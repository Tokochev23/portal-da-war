rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ===== Helpers =====
    function isLoggedIn() {
      return request.auth != null;
    }

    function isStaff() {
      return isLoggedIn() &&
        exists(/databases/$(database)/documents/usuarios/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.papel in ['narrador', 'admin'];
    }

    // ===== PAÍSES =====
    match /paises/{document} {
      allow read: if true;
      allow write: if isLoggedIn();
    }

    // ===== USUÁRIOS =====
    match /usuarios/{userId} {
      // Permitir que o próprio usuário leia/escreva seus dados
      allow read, write: if isLoggedIn() && request.auth.uid == userId;
      
      // ADICIONADO: Permitir que staff (narradores/admins) leiam todos os usuários
      allow read: if isStaff();
      
      // ADICIONADO: Permitir que staff atualize dados de usuários (atribuições de país, etc.)
      allow write: if isStaff();
    }

    // ===== CONFIGURAÇÕES =====
    match /configuracoes/{document} {
      allow read: if true;
      allow write: if isLoggedIn();
    }

    // ===== VEÍCULOS PENDENTES =====
    match /vehicles_pending/{docId} {
      allow create: if isLoggedIn()
        && request.resource.data.keys().hasAny(['playerId'])
        && request.auth.uid == request.resource.data.playerId;

      allow read: if isLoggedIn()
        && (request.auth.uid == resource.data.playerId || isStaff());

      allow update, delete: if isStaff();
    }

    // ===== VEÍCULOS APROVADOS =====
    match /vehicles_approved/{playerId}/{documents=**} {
      allow read: if isLoggedIn()
        && (request.auth.uid == playerId || isStaff());

      allow write: if isStaff();
    }

    // ===== VEÍCULOS REJEITADOS =====
    match /vehicles_rejected/{docId} {
      allow create: if isStaff();
      allow read: if isLoggedIn()
        && (request.auth.uid == resource.data.playerId || isStaff());
      allow update, delete: if isStaff();
    }

    // ===== INVENTÁRIO =====
    match /inventory/{countryId}/{documents=**} {
      allow read: if isLoggedIn()
        && (resource.data.ownerUid == request.auth.uid || isStaff());

      allow write: if isStaff();
    }

    // ===== HISTÓRICO ECONÔMICO =====
    match /economic_history/{document} {
      allow read: if isLoggedIn();
      allow write: if isStaff();
    }

    // ===== HISTÓRICO DE MUDANÇAS =====
    match /change_history/{document} {
      allow read: if isLoggedIn();
      allow write: if isStaff();
    }

    // ===== NOTIFICAÇÕES =====
    match /notifications/{document} {
      allow read: if isLoggedIn();
      allow write: if isStaff();
    }

    // ===== EVENTOS =====
    match /events/{document} {
      allow read: if isLoggedIn();
      allow write: if isStaff();
    }

    // ===== HISTÓRICO DE EVENTOS =====
    match /event_history/{document} {
      allow read: if isLoggedIn();
      allow write: if isStaff();
    }
  }
}