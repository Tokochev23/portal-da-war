<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‚úàÔ∏è Criador de Aeronaves Avan√ßado ‚Ä¢ WAR Era 1954</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 16 16%22%3E%3Crect width=%2216%22 height=%2216%22 rx=%223%22 fill=%22%23ffb400%22/%3E%3Ctext x=%228%22 y=%2211%22 font-size=%2210%22 text-anchor=%22middle%22 fill=%22%230b1020%22%3EW%3C/text%3E%3C/svg%3E" />

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- html2canvas for screenshot capture -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            bg: {
              DEFAULT: "#0b1020",
              soft: "#10172a",
              ring: "#1e293b"
            },
            brand: {
              50:"#fff7e6",100:"#ffefcc",200:"#ffe099",300:"#ffd166",400:"#ffc233",
              500:"#ffb400",600:"#e09f00",700:"#b37d00",800:"#805900",900:"#4d3600"
            }
          }
        }
      }
    }
  </script>

  <!-- Inter Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Stardos+Stencil:wght@700&display=swap" rel="stylesheet">
  
  <!-- Chart.js for performance graphs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- CSS Refatorado -->
  <link rel="stylesheet" href="css/vehicle-creator.css">
  <link rel="stylesheet" href="css/vehicle-creator-enhanced.css">
  
  <!-- Custom Slider CSS for Aircraft -->
  <style>
    .aircraft-slider {
      background: linear-gradient(to right, #10b981 0%, #f59e0b 50%, #ef4444 100%);
      outline: none;
      border-radius: 8px;
    }
    
    .aircraft-slider::-webkit-slider-thumb {
      appearance: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: linear-gradient(45deg, #22d3ee, #0ea5e9);
      cursor: pointer;
      border: 2px solid #1e293b;
      box-shadow: 0 4px 12px rgba(34, 211, 238, 0.4);
      transition: all 0.2s ease;
    }
    
    .aircraft-slider::-webkit-slider-thumb:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 16px rgba(34, 211, 238, 0.6);
    }
    
    .aircraft-slider::-moz-range-thumb {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: linear-gradient(45deg, #22d3ee, #0ea5e9);
      cursor: pointer;
      border: 2px solid #1e293b;
      box-shadow: 0 4px 12px rgba(34, 211, 238, 0.4);
      transition: all 0.2s ease;
    }
    
    .aircraft-slider::-moz-range-thumb:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 16px rgba(34, 211, 238, 0.6);
    }
    
    .aircraft-slider:focus {
      box-shadow: 0 0 0 3px rgba(34, 211, 238, 0.3);
    }

    /* Aircraft performance indicators */
    .performance-indicator {
      background: linear-gradient(to right, #06b6d4 0%, #0ea5e9 50%, #3b82f6 100%);
      outline: none;
      border-radius: 8px;
    }
    
    .performance-indicator::-webkit-slider-thumb {
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: linear-gradient(45deg, #06b6d4, #0ea5e9);
      cursor: pointer;
      border: 2px solid #1e293b;
      box-shadow: 0 4px 12px rgba(6, 182, 212, 0.4);
      transition: all 0.2s ease;
    }
    
    .performance-indicator::-webkit-slider-thumb:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 16px rgba(6, 182, 212, 0.6);
    }
    
    .performance-indicator::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: linear-gradient(45deg, #06b6d4, #0ea5e9);
      cursor: pointer;
      border: 2px solid #1e293b;
      box-shadow: 0 4px 12px rgba(6, 182, 212, 0.4);
      transition: all 0.2s ease;
    }
    
    .performance-indicator::-moz-range-thumb:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 16px rgba(6, 182, 212, 0.6);
    }
  </style>
</head>

<body class="gradient-bg min-h-screen">
  <!-- Loading Screen -->
  <div id="initial-loading" class="fixed inset-0 bg-bg z-50 flex items-center justify-center">
    <div class="text-center">
      <div class="animate-spin w-12 h-12 border-4 border-cyan-500 border-t-transparent rounded-full mx-auto mb-4"></div>
      <p class="text-slate-200 font-medium">Iniciando Criador de Aeronaves...</p>
      <p class="text-slate-400 text-sm mt-2" id="loading-status">Carregando templates...</p>
    </div>
  </div>

  <!-- HEADER -->
  <header class="border-b border-slate-800/50 bg-bg/80 backdrop-blur-sm sticky top-0 z-40">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
      <div class="flex h-16 items-center justify-between">
        <div class="flex items-center space-x-4">
          <div class="flex items-center space-x-2">
            <span class="text-3xl">‚úàÔ∏è</span>
            <div>
              <h1 class="text-lg font-bold text-slate-100">Criador de Aeronaves</h1>
              <p class="text-xs text-slate-400">Sistema Avan√ßado WAR Era 1954</p>
            </div>
          </div>
        </div>

        <div class="flex items-center space-x-4">
          <div class="flex items-center space-x-2 text-sm">
            <span class="text-slate-400">Pa√≠s:</span>
            <span id="current-country" class="font-medium text-cyan-300">Carregando...</span>
          </div>
          
          <button onclick="showAircraftSummaryModal()" class="flex items-center space-x-2 rounded-lg bg-cyan-600 px-4 py-2 text-sm font-medium text-white transition-all hover:bg-cyan-700 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:ring-offset-2 focus:ring-offset-bg">
            <span>‚úàÔ∏è</span>
            <span>Ficha da Aeronave</span>
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- MAIN CONTENT -->
  <main class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-8">
    
    <!-- PROJECT INFO SECTION -->
    <div class="bg-slate-800/40 border border-slate-700/50 rounded-xl p-6 mb-8">
      <div class="flex items-start justify-between">
        <div class="flex items-center space-x-3">
          <span class="text-4xl">üõ©Ô∏è</span>
          <div>
            <h2 class="text-xl font-bold text-slate-100">Projeto de Aeronave</h2>
            <p class="text-slate-400 text-sm mt-1">Configure cada componente para criar sua aeronave ideal</p>
          </div>
        </div>
        
        <div class="text-right">
          <div class="text-lg font-bold text-cyan-300" id="aircraft-name-display">Nova Aeronave</div>
          <div class="text-sm text-slate-400 mt-1">
            <span id="aircraft-type-display">Tipo n√£o definido</span> ‚Ä¢ 
            <span id="aircraft-year-display">1954</span>
          </div>
        </div>
      </div>
      
      <!-- Quick stats row -->
      <div class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-4 pt-4 border-t border-slate-700/30">
        <div class="text-center">
          <div class="text-xl font-bold text-slate-100" id="total-weight-display">0 kg</div>
          <div class="text-xs text-slate-400">Peso Total</div>
        </div>
        <div class="text-center">
          <div class="text-xl font-bold text-cyan-300" id="max-speed-display">0 km/h</div>
          <div class="text-xs text-slate-400">Velocidade M√°x</div>
        </div>
        <div class="text-center">
          <div class="text-xl font-bold text-sky-300" id="thrust-weight-ratio-display">0:1</div>
          <div class="text-xs text-slate-400">Empuxo/Peso</div>
        </div>
        <div class="text-center">
          <div class="text-xl font-bold text-blue-300" id="total-cost-display">$0K</div>
          <div class="text-xs text-slate-400">Custo Unidade</div>
        </div>
      </div>
    </div>

    <!-- COMPONENT TABS -->
    <div class="bg-slate-800/40 border border-slate-700/50 rounded-xl overflow-hidden mb-8">
      <nav class="flex border-b border-slate-700/50">
        <button class="tab-button flex-1 px-6 py-4 text-sm font-medium border-b-2 transition-all hover:text-cyan-300 hover:bg-slate-800/50" data-tab="category">
          <div class="flex items-center justify-center space-x-2">
            <span>üéØ</span>
            <span>Categoria</span>
          </div>
        </button>
        <button class="tab-button flex-1 px-6 py-4 text-sm font-medium border-b-2 transition-all hover:text-cyan-300 hover:bg-slate-800/50" data-tab="structure">
          <div class="flex items-center justify-center space-x-2">
            <span>üîß</span>
            <span>Estrutura</span>
          </div>
        </button>
        <button class="tab-button flex-1 px-6 py-4 text-sm font-medium border-b-2 transition-all hover:text-cyan-300 hover:bg-slate-800/50" data-tab="cell">
          <div class="flex items-center justify-center space-x-2">
            <span>‚úàÔ∏è</span>
            <span>C√©lula</span>
          </div>
        </button>
        <button class="tab-button flex-1 px-6 py-4 text-sm font-medium border-b-2 transition-all hover:text-cyan-300 hover:bg-slate-800/50" data-tab="wings">
          <div class="flex items-center justify-center space-x-2">
            <span>ü™∂</span>
            <span>Asas</span>
          </div>
        </button>
        <button class="tab-button flex-1 px-6 py-4 text-sm font-medium border-b-2 transition-all hover:text-cyan-300 hover:bg-slate-800/50" data-tab="propulsion">
          <div class="flex items-center justify-center space-x-2">
            <span>üöÄ</span>
            <span>Propuls√£o</span>
          </div>
        </button>
        <button class="tab-button flex-1 px-6 py-4 text-sm font-medium border-b-2 transition-all hover:text-cyan-300 hover:bg-slate-800/50" data-tab="supercharger">
          <div class="flex items-center justify-center space-x-2">
            <span>‚ö°</span>
            <span>Supercharger</span>
          </div>
        </button>
        <button class="tab-button flex-1 px-6 py-4 text-sm font-medium border-b-2 transition-all hover:text-cyan-300 hover:bg-slate-800/50" data-tab="weapons">
          <div class="flex items-center justify-center space-x-2">
            <span>üéØ</span>
            <span>Armamento</span>
          </div>
        </button>
        <button class="tab-button flex-1 px-6 py-4 text-sm font-medium border-b-2 transition-all hover:text-cyan-300 hover:bg-slate-800/50" data-tab="avionics">
          <div class="flex items-center justify-center space-x-2">
            <span>üì°</span>
            <span>Avi√¥nica</span>
          </div>
        </button>
      </nav>

      <div id="tab-content" class="p-6 min-h-[500px]">
        <!-- Dynamic content will be loaded here -->
        <div class="text-center text-slate-400 py-16">
          <span class="text-4xl">‚úàÔ∏è</span>
          <p class="mt-4">Selecione uma aba para come√ßar a configurar sua aeronave</p>
        </div>
      </div>
    </div>

    <!-- WARNINGS SECTION -->
    <div id="warnings-container" class="hidden">
      <div class="bg-slate-800/40 border border-slate-700/50 rounded-xl p-6 mb-8">
        <div class="flex items-start space-x-3">
          <span class="text-2xl">‚ö†Ô∏è</span>
          <div>
            <h3 class="text-lg font-semibold text-amber-300 mb-2">Avisos de Design</h3>
            <div id="warnings-list" class="space-y-2">
              <!-- Warnings will be populated by JavaScript -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ANALYSIS SECTION -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
      <!-- Performance Chart -->
      <div class="bg-slate-800/40 border border-slate-700/50 rounded-xl p-6">
        <h3 class="text-lg font-semibold text-slate-100 mb-4 flex items-center space-x-2">
          <span>üìä</span>
          <span>Performance da Aeronave</span>
        </h3>
        <div class="relative h-80">
          <canvas id="performance-radar"></canvas>
        </div>
      </div>

      <!-- Detailed Analysis -->
      <div class="space-y-6">
        <!-- Flight Performance -->
        <div class="bg-slate-800/40 border border-slate-700/50 rounded-xl p-6">
          <h3 class="text-lg font-semibold text-slate-100 mb-4 flex items-center space-x-2">
            <span>üõ´</span>
            <span>Performance de Voo</span>
          </h3>
          <div id="flight-performance-analysis">
            <!-- Flight performance details will be populated by JavaScript -->
          </div>
        </div>

        <!-- Cost Breakdown -->
        <div class="bg-slate-800/40 border border-slate-700/50 rounded-xl p-6">
          <h3 class="text-lg font-semibold text-slate-100 mb-4 flex items-center space-x-2">
            <span>üí∞</span>
            <span>An√°lise de Custos</span>
          </h3>
          <div id="cost-breakdown">
            <p class="text-slate-400 text-sm text-center py-8">Selecione componentes para ver a an√°lise de custos.</p>
            <!-- Cost details will be populated by JavaScript -->
          </div>
        </div>
      </div>
    </div>

    <!-- ACTION BUTTONS -->
    <div class="flex flex-col sm:flex-row items-center justify-between gap-4 bg-slate-800/40 border border-slate-700/50 rounded-xl p-6">
      <div class="flex items-center space-x-4 text-sm text-slate-400">
        <span class="flex items-center space-x-2">
          <span class="w-2 h-2 bg-cyan-500 rounded-full"></span>
          <span>Sistema de Design Aeron√°utico</span>
        </span>
        <span>‚Ä¢</span>
        <span>WAR Era 1954</span>
      </div>
      
      <div class="flex items-center space-x-3">
        <button onclick="resetAircraft()" class="px-4 py-2 bg-slate-600 hover:bg-slate-500 text-white rounded-lg font-medium transition-colors flex items-center space-x-2">
          <span>üîÑ</span>
          <span>Resetar</span>
        </button>
        
        <button onclick="saveAircraftDesign()" class="px-4 py-2 bg-sky-600 hover:bg-sky-700 text-white rounded-lg font-medium transition-colors flex items-center space-x-2">
          <span>üíæ</span>
          <span>Salvar Design</span>
        </button>
        
        <button onclick="showAircraftSummaryModal()" class="px-6 py-2 bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-700 hover:to-blue-700 text-white rounded-lg font-medium transition-all duration-200 flex items-center space-x-2 shadow-lg hover:shadow-cyan-500/25">
          <span>‚úàÔ∏è</span>
          <span>Ver Ficha Completa</span>
        </button>
      </div>
    </div>

  </main>

  <!-- Scripts -->
  <script src="./js/utils/templateLoader.js"></script>
  <script src="./js/utils/realisticPerformanceCalculator.js"></script>
  <script src="./js/utils/advancedPerformanceCalculator.js"></script>
  <script type="module" src="./js/components/aircraftTabLoaders.js"></script>
  <script type="module" src="./js/aircraft/data/StructuralMaterials.js"></script>
  <script type="module" src="./js/aircraft/systems/CenterOfGravity.js"></script>
  <script type="module" src="./js/aircraft/ui/StructureMaterialsHandler.js"></script>
  <script type="module" src="./js/aircraft/components/PerformanceComponent.js"></script>
  <script type="module" src="./js/aircraft/systems/PerformanceCalculationSystem.js"></script>
  <script type="module" src="./js/aircraft/systems/CostCalculationSystem.js"></script>
  <script type="module" src="./js/aircraft/systems/UnifiedCalculationSystem.js"></script>
  <script type="module" src="./js/services/firebase.js"></script>
  <script type="module" src="./js/utils/aircraftCostSystem.js"></script>
  <script type="module" src="js/aircraftCreator.js"></script>
  
  <script type="module">
    import { EngineeringDashboard } from './js/ui/EngineeringDashboard.js';
    import { WarningsDisplay } from './js/ui/WarningsDisplay.js';
    import { CostDisplay } from './js/ui/CostDisplay.js';
    import { OptimizedTemplateLoader } from './js/components/OptimizedTemplateLoader.js';

    // Sistema de inicializa√ß√£o para aeronaves
    class AircraftCreatorApp {
      constructor() {
        this.currentTab = 'category';
        this.dashboard = null;
        this.warningsDisplay = null;
        this.costDisplay = null;
        this.isInitialized = false;
        this.loadingElement = document.getElementById('initial-loading');
        this.statusElement = document.getElementById('loading-status');

        // Initialize template loader
        window.templateInjector = new OptimizedTemplateLoader();
      }

      updateLoadingStatus(message) {
        if (this.statusElement) {
          this.statusElement.textContent = message;
        }
      }

      async initialize() {
        try {
          this.updateLoadingStatus('Iniciando sistema de aeronaves...');
          
          // Carregar templates primeiro
          this.updateLoadingStatus('Carregando templates...');
          if (window.progressiveLoader) {
            await window.progressiveLoader.loadAll();
          }
          
          // Carregar componentes de aeronaves
          this.updateLoadingStatus('Carregando componentes de aeronaves...');
          if (window.loadAircraftComponents) {
            const componentsLoaded = await window.loadAircraftComponents();
            if (!componentsLoaded) {
              throw new Error('Falha ao carregar componentes de aeronaves');
            }
          } else {
            console.warn('‚ö†Ô∏è loadAircraftComponents function not found - using fallback');
            // Fallback: aguardar um pouco para os scripts carregarem
            await new Promise(resolve => setTimeout(resolve, 1000));
            if (!window.AIRCRAFT_COMPONENTS || Object.keys(window.AIRCRAFT_COMPONENTS.airframes || {}).length === 0) {
              throw new Error('Componentes de aeronaves n√£o foram carregados');
            }
          }
          
          this.updateLoadingStatus('Inicializando interface...');
          this.initializeInterface();
          this.setupTabNavigation();
          this.dashboard = new EngineeringDashboard('performance-radar');
          this.warningsDisplay = new WarningsDisplay('warnings-container', 'warnings-list');
          this.costDisplay = new CostDisplay('cost-breakdown');
          
          // Carregar a primeira aba (categoria)
          this.updateLoadingStatus('Carregando categorias...');
          this.loadTabContent('category');
          
          // Initial calculations update to show displays (even with zero values)
          setTimeout(() => {
            if (typeof window.updateAircraftCalculations === 'function') {
              window.updateAircraftCalculations();
            }
          }, 200);
          
          setTimeout(() => this.hideLoadingScreen(), 500);
          
        } catch (error) {
          console.error('‚ùå Initialization failed:', error);
          this.showInitializationError(error);
        }
      }

      hideLoadingScreen() {
        if (this.loadingElement) {
          this.loadingElement.style.opacity = '0';
          setTimeout(() => {
            this.loadingElement.style.display = 'none';
          }, 300);
        }
        this.isInitialized = true;
        console.log('‚úÖ Aircraft Creator fully initialized');
      }

      showInitializationError(error) {
        console.error('‚ùå Erro de inicializa√ß√£o:', error);
        if (this.statusElement) {
          this.statusElement.innerHTML = `
            <div class="text-red-400 text-center">
              <div class="text-lg font-semibold mb-2">‚ùå Erro de Inicializa√ß√£o</div>
              <div class="text-sm">${error.message}</div>
              <button onclick="window.location.reload()" class="mt-4 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                Recarregar P√°gina
              </button>
            </div>
          `;
        }
      }

      initializeInterface() {
        const country = localStorage.getItem('loggedCountry') || 'Desconhecido';
        const countryElement = document.getElementById('current-country');
        if (countryElement) {
          countryElement.textContent = country;
        }
        
        // Initialize currentAircraft object
        if (!window.currentAircraft) {
          window.currentAircraft = {
            name: 'Nova Aeronave',
            airframe: null,
            engine: null,
            weapons: [],
            avionics: [],
            supercharger: null,
            quantity: 1
          };
        }
        
        this.setActiveTab('airframes');
      }

      setupTabNavigation() {
        const tabButtons = document.querySelectorAll('.tab-button');
        tabButtons.forEach(button => {
          button.addEventListener('click', () => {
            const tabId = button.dataset.tab;
            this.setActiveTab(tabId);
            this.loadTabContent(tabId);
          });
        });
      }

      setActiveTab(tabId) {
        this.currentTab = tabId;
        document.querySelectorAll('.tab-button').forEach(btn => {
          btn.classList.remove('border-cyan-500', 'text-cyan-300');
          btn.classList.add('border-transparent', 'text-slate-400');
        });
        const activeBtn = document.querySelector(`[data-tab="${tabId}"]`);
        if(activeBtn) {
          activeBtn.classList.add('border-cyan-500', 'text-cyan-300');
          activeBtn.classList.remove('border-transparent', 'text-slate-400');
        }
      }

      loadTabContent(tabId) {
        const tabContent = document.getElementById('tab-content');
        if (!tabContent) return;

        tabContent.innerHTML = '<div class="text-center py-8"><div class="animate-spin w-6 h-6 border-2 border-cyan-500 border-t-transparent rounded-full mx-auto"></div></div>';

        setTimeout(() => {
          switch(tabId) {
            case 'category': this.loadCategoryTab(); break;
            case 'structure': this.loadStructureTab(); break;
            case 'cell': this.loadCellTab(); break;
            case 'wings': this.loadWingsTab(); break;
            case 'propulsion': this.loadPropulsionTab(); break;
            case 'supercharger': this.loadSuperchargerTab(); break;
            case 'weapons': this.loadWeaponsTab(); break;
            case 'avionics': this.loadAvionicsTab(); break;
          }
        }, 200);
      }

      loadWingsTab() {
        if (window.tabLoaders) window.tabLoaders.loadWingsTab();
      }

      loadCellTab() {
        if (window.tabLoaders) window.tabLoaders.loadCellTab();
      }

      loadPropulsionTab() {
        if (window.tabLoaders) window.tabLoaders.loadPropulsionTab();
      }

      loadSuperchargerTab() {
        if (window.tabLoaders) window.tabLoaders.loadSuperchargerTab();
      }

      loadWeaponsTab() {
        if (window.tabLoaders) window.tabLoaders.loadWeaponsTab();
      }

      loadAvionicsTab() {
        if (window.tabLoaders) window.tabLoaders.loadAvionicsTab();
      }

      loadCategoryTab() {
        if (window.tabLoaders) window.tabLoaders.loadCategoryTab();
      }

      loadStructureTab() {
        if (window.tabLoaders) window.tabLoaders.loadStructureTab();
      }
    }

    // Inicializa√ß√£o global
    window.aircraftCreatorApp = new AircraftCreatorApp();

    // Fun√ß√µes globais para sele√ß√£o de componentes
    window.selectAirframe = function(airframeId) {
      if (!window.AIRCRAFT_COMPONENTS?.airframes[airframeId]) {
        console.error('Airframe not found:', airframeId);
        return;
      }
      
      window.currentAircraft.airframe = airframeId;
      console.log('Selected airframe:', airframeId);

      // Update visual selection
      document.querySelectorAll('.airframe-card').forEach(card => {
        card.classList.remove('selected', 'border-cyan-400', 'ring-1', 'ring-cyan-400/50');
        card.classList.add('border-slate-700/50', 'bg-slate-800/40');
      });
      
      const selectedCard = document.querySelector(`[onclick="selectAirframe('${airframeId}')"]`);
      if (selectedCard) {
        selectedCard.classList.add('selected', 'border-cyan-400', 'ring-1', 'ring-cyan-400/50');
        selectedCard.classList.remove('border-slate-700/50', 'bg-slate-800/40');
      }
      
      // Update calculations and refresh tabs that depend on airframe selection
      updateAircraftCalculations();
      
      // Refresh engine tab if it's currently visible to show compatibility
      if (window.aircraftCreatorApp.currentTab === 'engines') {
        window.aircraftCreatorApp.loadEnginesTab();
      }
    };

    window.selectAircraftEngine = function(engineId) {
      if (!window.AIRCRAFT_COMPONENTS?.aircraft_engines[engineId]) {
        console.error('Engine not found:', engineId);
        return;
      }
      
      window.currentAircraft.engine = engineId;
      console.log('Selected engine:', engineId);

      // Update visual selection
      document.querySelectorAll('.engine-card').forEach(card => {
        card.classList.remove('selected', 'border-cyan-400', 'ring-1', 'ring-cyan-400/50');
        card.classList.add('border-slate-700/50', 'bg-slate-800/40');
      });
      
      const selectedCard = document.querySelector(`[onclick="selectAircraftEngine('${engineId}')"]`);
      if (selectedCard) {
        selectedCard.classList.add('selected', 'border-cyan-400', 'ring-1', 'ring-cyan-400/50');
        selectedCard.classList.remove('border-slate-700/50', 'bg-slate-800/40');
      }
      
      updateAircraftCalculations();
    };

    window.toggleAircraftWeapon = function(weaponId) {
      if (!window.currentAircraft.weapons) {
        window.currentAircraft.weapons = [];
      }
      
      const index = window.currentAircraft.weapons.indexOf(weaponId);
      if (index > -1) {
        window.currentAircraft.weapons.splice(index, 1);
      } else {
        window.currentAircraft.weapons.push(weaponId);
      }
      
      console.log('Weapon toggled:', weaponId, 'Current weapons:', window.currentAircraft.weapons);
      updateAircraftCalculations();
    };

    window.selectSupercharger = function(superchargerId) {
      if (!window.AIRCRAFT_COMPONENTS?.superchargers[superchargerId]) {
        console.error('Supercharger not found:', superchargerId);
        return;
      }
      
      window.currentAircraft.supercharger = superchargerId;
      console.log('Selected supercharger:', superchargerId);

      // Update visual selection
      document.querySelectorAll('.component-card[onclick*="selectSupercharger"]').forEach(card => {
        card.classList.remove('selected', 'border-cyan-400', 'ring-1', 'ring-cyan-400/50', 'bg-cyan-900/20');
        card.classList.add('border-slate-700/50', 'bg-slate-800/40');
      });
      
      const selectedCard = document.querySelector(`[onclick="selectSupercharger('${superchargerId}')"]`);
      if (selectedCard) {
        selectedCard.classList.add('selected', 'border-cyan-400', 'ring-1', 'ring-cyan-400/50', 'bg-cyan-900/20');
        selectedCard.classList.remove('border-slate-700/50', 'bg-slate-800/40');
      }

      // Update selected supercharger name display
      const nameDisplay = document.getElementById('selected-supercharger-name');
      if (nameDisplay && window.AIRCRAFT_COMPONENTS.superchargers[superchargerId]) {
        nameDisplay.textContent = window.AIRCRAFT_COMPONENTS.superchargers[superchargerId].name;
      }

      // Update impact displays
      if (window.tabLoaders && typeof window.tabLoaders.updateSuperchargerImpact === 'function') {
        window.tabLoaders.updateSuperchargerImpact();
      }
      
      updateAircraftCalculations();
    };

    window.showTechRequirement = function(componentName, requiredTech, currentTech) {
      const missingTech = requiredTech - currentTech;
      alert(`${componentName} requer n√≠vel tecnol√≥gico ${requiredTech}.\n\nSeu n√≠vel atual: ${currentTech}\nNecess√°rio: +${missingTech} pontos de tecnologia`);
    };

    window.calculateAircraftCosts = function(aircraft = window.currentAircraft) {
      return window.AircraftCostSystem ? window.AircraftCostSystem.calculateCosts(aircraft) : { unitCost: 0, maintenanceCostPerHour: 0 };
    };

    window.calculateAircraftCost = function(aircraft = window.currentAircraft) {
      const costs = window.calculateAircraftCosts(aircraft);
      return costs.unitCost || 0;
    };

    window.updateAircraftCalculations = function() {
      console.log('üîÑ Updating aircraft calculations...');

      if (!window.currentAircraft?.airframe) {
        console.log('‚ö†Ô∏è No airframe selected - showing zero values');
        // Show zero values in displays
        updateAircraftDisplays({ totalWeight: 0, maxSpeed: 0, thrustToWeight: 0 });
        if (window.aircraftCreatorApp.costDisplay) {
            window.aircraftCreatorApp.costDisplay.update();
        }
        return;
      }

      // Use unified calculation system if available
      if (window.unifiedCalculationSystem) {
        window.calculateAircraftComplete(window.currentAircraft, {
          includePerformance: true,
          includeCosts: true,
          includeCenterOfGravity: true,
          includeValidation: true
        }).then(results => {
          console.log('‚úÖ Unified calculations completed:', results);

          // Update displays with unified results
          if (results.summary?.performance) {
            updateAircraftDisplays({
              totalWeight: results.summary.balance?.totalMass || 0,
              maxSpeed: results.summary.performance.maxSpeed || 0,
              thrustToWeight: results.summary.performance.thrustToWeight || 0,
              range: results.summary.performance.range || 0
            });
          }

          if (results.costs && window.aircraftCreatorApp.costDisplay) {
            window.aircraftCreatorApp.costDisplay.update(results.costs);
          }

          // Update warnings display
          if (window.aircraftCreatorApp.warningsDisplay) {
            window.aircraftCreatorApp.warningsDisplay.update(results.warnings, results.errors);
          }

          // Update performance chart
          if (window.aircraftCreatorApp.dashboard) {
            window.aircraftCreatorApp.dashboard.update(results);
          }

        }).catch(error => {
          console.error('‚ùå Unified calculation failed, falling back to legacy:', error);
          performLegacyCalculations();
        });
        return;
      }

      // Fallback to legacy calculations
      performLegacyCalculations();
    };

    function performLegacyCalculations() {
      
      try {
        if (window.calculateAircraftPerformance) {
          const performance = window.calculateAircraftPerformance(window.currentAircraft);
          console.log('Performance calculated:', performance);
          
          // Update displays
          updateAircraftDisplays(performance);

          // Handle warnings display
          const warningsContainer = document.getElementById('warnings-container');
          const warningsList = document.getElementById('warnings-list');
          if (warningsContainer && warningsList) {
              if (performance.warnings && performance.warnings.length > 0) {
                  warningsList.innerHTML = performance.warnings.map(w => `<div class="text-sm">‚Ä¢ ${w}</div>`).join('');
                  warningsContainer.classList.remove('hidden');
              } else {
                  warningsList.innerHTML = '';
                  warningsContainer.classList.add('hidden');
              }
          }

          // Update performance radar chart
          if (window.aircraftCreatorApp.dashboard) {
            window.aircraftCreatorApp.dashboard.update(window.currentAircraft);
          }
        }
        
        if (window.AircraftCostSystem) {
          const costs = window.AircraftCostSystem.calculateCosts(window.currentAircraft);
          console.log('Costs calculated:', costs);
          
          // Update cost displays
          if (window.aircraftCreatorApp.costDisplay) {
            window.aircraftCreatorApp.costDisplay.update(costs);
          }
        }
        
        console.log('‚úÖ Aircraft calculations updated successfully');
      } catch (error) {
        console.error('‚ùå Error updating aircraft calculations:', error);
      }
    };

    function updateAircraftDisplays(performance) {
      // Update header displays
      const weightEl = document.getElementById('total-weight-display');
      const speedEl = document.getElementById('max-speed-display');
      const thrustEl = document.getElementById('thrust-weight-ratio-display');
      
      if (weightEl && performance.totalWeight) {
        weightEl.textContent = Math.round(performance.totalWeight) + ' kg';
      }
      if (speedEl && (performance.maxSpeed || performance.maxSpeedKph)) {
        const speed = performance.maxSpeed || performance.maxSpeedKph;
        speedEl.textContent = Math.round(speed) + ' km/h';
      }
      if (thrustEl && performance.thrustToWeight) {
        thrustEl.textContent = performance.thrustToWeight.toFixed(2) + ':1';
      }
      
      // Update detailed performance section
      const performanceSection = document.getElementById('flight-performance-analysis');
      if (performanceSection && window.AircraftPerformanceSystem) {
        performanceSection.innerHTML = window.AircraftPerformanceSystem.renderPerformanceDisplay(window.currentAircraft);
      }
    }

    // This function is now simplified as the main display is handled by CostDisplay.js
    function updateCostDisplays(costs) {
      const costEl = document.getElementById('total-cost-display');
      if (costEl && costs.unitProductionCost) {
        const cost = costs.unitProductionCost;
        if (cost >= 1000000) {
            costEl.textContent = `$${(cost / 1000000).toFixed(1)}M`;
        } else if (cost >= 1000) {
            costEl.textContent = `$${Math.round(cost / 1000)}K`;
        } else {
            costEl.textContent = `$${Math.round(cost)}`;
        }
      }
    }

    // Fun√ß√µes auxiliares
    window.resetAircraft = function() {
      window.currentAircraft = {
        name: 'Nova Aeronave',
        airframe: null,
        engine: null,
        weapons: [],
        avionics: [],
        quantity: 1
      };
      
      // Refresh current tab
      window.aircraftCreatorApp.loadTabContent(window.aircraftCreatorApp.currentTab);
      updateAircraftCalculations();
    };

    window.saveAircraftDesign = function() {
      console.log('Saving aircraft design:', window.currentAircraft);
      // TODO: Implement save functionality
      alert('Design salvo! (funcionalidade ser√° implementada)');
    };

    window.showAircraftSummaryModal = function() {
      console.log('Showing aircraft summary modal');
      // TODO: Implement modal display
      alert('Modal da aeronave ser√° implementado');
    };

    
  </script>


  <!-- AIRCRAFT SUMMARY MODAL -->
  <div id="aircraft-summary-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
    <div class="bg-slate-900 rounded-2xl shadow-2xl border border-slate-700 w-full max-w-6xl max-h-[90vh] overflow-y-auto">
      <!-- Modal Header -->
      <div class="flex items-center justify-between p-6 border-b border-slate-700 sticky top-0 bg-slate-900 rounded-t-2xl">
        <div class="flex items-center gap-3">
          <span class="text-3xl">‚úàÔ∏è</span>
          <h2 class="text-2xl font-bold text-slate-100">Ficha T√©cnica da Aeronave</h2>
        </div>
        <button onclick="hideAircraftSummaryModal()" class="w-8 h-8 rounded-full bg-slate-800 hover:bg-slate-700 flex items-center justify-center transition-colors">
          <span class="text-slate-400 text-xl">√ó</span>
        </button>
      </div>

      <!-- Modal Content -->
      <div id="aircraft-summary-content" class="p-6">
        <!-- Content will be populated by JavaScript -->
      </div>

      <!-- Modal Footer -->
      <div class="p-6 border-t border-slate-700 bg-slate-800/50 rounded-b-2xl space-y-4">
        
        <!-- Quantity Selection -->
        <div class="bg-slate-700/30 border border-slate-600/50 rounded-lg p-4">
          <label class="block text-sm font-medium text-slate-300 mb-2">
            üìä Quantidade de Unidades a Produzir
          </label>
          <div class="flex items-center gap-4">
            <input 
              type="number" 
              id="aircraft-quantity-input" 
              class="flex-1 px-3 py-2 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-transparent" 
              min="1" 
              max="500" 
              value="12"
              placeholder="Ex: 12"
            >
            <div class="text-xs text-slate-400 text-center">
              <div>Min: 1</div>
              <div>Max: 500</div>
            </div>
          </div>
          <p class="text-xs text-slate-400 mt-1">
            Esta quantidade ser√° avaliada pelo narrador para aprova√ß√£o
          </p>
        </div>
        
        <!-- Country Selection for Admin/Narrator -->
        <div id="admin-country-selection-aircraft" class="hidden bg-slate-700/30 border border-slate-600/50 rounded-lg p-4">
          <label class="block text-sm font-medium text-slate-300 mb-2">
            üåç Pa√≠s de Destino (Admin/Narrador)
          </label>
          <select 
            id="aircraft-target-country" 
            class="w-full px-3 py-2 bg-slate-800/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
          >
            <option value="">Carregando pa√≠ses...</option>
          </select>
          <p class="text-xs text-slate-400 mt-1">
            Como admin/narrador, selecione o pa√≠s que receber√° esta aeronave
          </p>
        </div>
        
        <!-- Action Buttons -->
        <div class="flex gap-3 justify-end">
          <button onclick="exportAircraftToPDF()" class="px-4 py-2 bg-slate-600 hover:bg-slate-500 text-white rounded-lg font-medium transition-colors flex items-center gap-2">
            <span>üìÑ</span>
            <span>Exportar PDF</span>
          </button>
          
          <button id="submit-aircraft-approval-btn" onclick="submitAircraftForApprovalModal()" class="px-6 py-2 bg-gradient-to-r from-cyan-600 to-blue-700 hover:from-cyan-700 hover:to-blue-800 text-white rounded-lg font-medium transition-all duration-200 flex items-center gap-2 shadow-lg hover:shadow-cyan-500/25 disabled:opacity-50 disabled:cursor-not-allowed">
            <span>‚úàÔ∏è</span>
            <span>Enviar para Aprova√ß√£o</span>
          </button>
        </div>
        
        <!-- Status Message Area -->
        <div id="aircraft-submission-status" class="hidden mt-3 rounded-lg p-3 text-sm"></div>
      </div>
    </div>
  </div>

  <script>
    // Aircraft Modal Functions
    function showAircraftSummaryModal() {
      const modal = document.getElementById('aircraft-summary-modal');
      if (modal) {
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        populateAircraftSummary();
        loadCountriesForAdmin();
      }
    }

    function hideAircraftSummaryModal() {
      const modal = document.getElementById('aircraft-summary-modal');
      if (modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      }
    }

    function populateAircraftSummary() {
      const content = document.getElementById('aircraft-summary-content');
      if (!content || !window.currentAircraft) return;

      const performance = window.realisticPerformanceCalculator ? 
        window.realisticPerformanceCalculator.calculateAircraftPerformance(window.currentAircraft) : null;

      const airframe = window.AIRCRAFT_COMPONENTS?.airframes?.[window.currentAircraft.airframe];
      const engine = window.AIRCRAFT_COMPONENTS?.aircraft_engines?.[window.currentAircraft.engine];

      content.innerHTML = `
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- Basic Info -->
          <div class="bg-slate-800/30 rounded-lg p-4 border border-slate-700/50">
            <h3 class="text-lg font-semibold text-slate-200 mb-3">Informa√ß√µes B√°sicas</h3>
            <div class="space-y-2 text-sm">
              <div><span class="text-slate-400">Nome:</span> <span class="text-white">${window.currentAircraft.name || 'Nova Aeronave'}</span></div>
              <div><span class="text-slate-400">Fuselagem:</span> <span class="text-white">${airframe?.name || 'N√£o selecionada'}</span></div>
              <div><span class="text-slate-400">Motor:</span> <span class="text-white">${engine?.name || 'N√£o selecionado'}</span></div>
              <div><span class="text-slate-400">Era:</span> <span class="text-white">${airframe?.tech_era || 'N/A'}</span></div>
            </div>
          </div>

          <!-- Performance -->
          <div class="bg-slate-800/30 rounded-lg p-4 border border-slate-700/50">
            <h3 class="text-lg font-semibold text-slate-200 mb-3">Performance</h3>
            <div class="space-y-2 text-sm">
              <div><span class="text-slate-400">Vel. M√°xima:</span> <span class="text-cyan-300">${performance?.maxSpeed || 0} km/h</span></div>
              <div><span class="text-slate-400">Taxa de Subida:</span> <span class="text-green-300">${performance?.rateOfClimb || 0} m/min</span></div>
              <div><span class="text-slate-400">Teto de Servi√ßo:</span> <span class="text-blue-300">${performance?.serviceCeiling || 0} m</span></div>
              <div><span class="text-slate-400">Alcance:</span> <span class="text-yellow-300">${performance?.range || 0} km</span></div>
            </div>
          </div>

          <!-- Configuration -->
          <div class="bg-slate-800/30 rounded-lg p-4 border border-slate-700/50">
            <h3 class="text-lg font-semibold text-slate-200 mb-3">Configura√ß√£o</h3>
            <div class="space-y-2 text-sm">
              <div><span class="text-slate-400">Armamentos:</span> <span class="text-white">${window.currentAircraft.weapons?.length || 0} itens</span></div>
              <div><span class="text-slate-400">Avi√¥nicos:</span> <span class="text-white">${window.currentAircraft.avionics?.length || 0} sistemas</span></div>
              <div><span class="text-slate-400">Peso Total:</span> <span class="text-white">${performance?.totalWeight || 0} kg</span></div>
            </div>
          </div>

          <!-- Economics -->
          <div class="bg-slate-800/30 rounded-lg p-4 border border-slate-700/50">
            <h3 class="text-lg font-semibold text-slate-200 mb-3">Custos</h3>
            <div class="space-y-2 text-sm">
              <div><span class="text-slate-400">Custo Base:</span> <span class="text-white" id="aircraft-unit-cost">Calculando...</span></div>
              <div><span class="text-slate-400">Pa√≠s:</span> <span class="text-white">${window.getCurrentUserCountry()?.name || 'N/A'}</span></div>
              <div><span class="text-slate-400">Modificador:</span> <span class="text-white">${((window.getCurrentUserCountry()?.costModifier || 1.0) * 100).toFixed(0)}%</span></div>
            </div>
          </div>
        </div>
      `;

      // Calculate costs
      if (window.calculateAircraftCost) {
        const baseCost = window.calculateAircraftCost(window.currentAircraft);
        document.getElementById('aircraft-unit-cost').textContent = `$${baseCost.toLocaleString()}`;
      }
    }

    async function loadCountriesForAdmin() {
      try {
        const permissions = await window.getUserPermissions();
        const adminSection = document.getElementById('admin-country-selection-aircraft');
        
        if (permissions.isAdmin || permissions.isNarrator) {
          adminSection.classList.remove('hidden');
          
          const select = document.getElementById('aircraft-target-country');
          const countries = window.getGameCountries();
          
          select.innerHTML = '<option value="">Selecione um pa√≠s...</option>';
          
          Object.values(countries || {}).forEach(country => {
            const option = document.createElement('option');
            option.value = country.id;
            option.textContent = country.name;
            select.appendChild(option);
          });
        }
      } catch (error) {
        console.error('Error loading countries for admin:', error);
      }
    }

    async function submitAircraftForApprovalModal() {
      const btn = document.getElementById('submit-aircraft-approval-btn');
      const status = document.getElementById('aircraft-submission-status');
      const quantity = parseInt(document.getElementById('aircraft-quantity-input').value) || 1;
      
      // Check for admin target country
      const targetCountrySelect = document.getElementById('aircraft-target-country');
      const targetCountry = targetCountrySelect?.value || null;
      
      if (!window.currentAircraft?.airframe || !window.currentAircraft?.engine) {
        showSubmissionStatus('Selecione pelo menos uma fuselagem e um motor antes de enviar para aprova√ß√£o.', 'error');
        return;
      }

      btn.disabled = true;
      btn.innerHTML = '<span>‚è≥</span><span>Enviando...</span>';
      
      try {
        const result = await window.submitAircraftForApproval(window.currentAircraft, quantity, targetCountry);
        
        if (result.success) {
          showSubmissionStatus(`‚úÖ ${result.message}`, 'success');
          setTimeout(() => hideAircraftSummaryModal(), 3000);
        } else {
          showSubmissionStatus(`‚ùå ${result.error}`, 'error');
        }
      } catch (error) {
        showSubmissionStatus(`‚ùå Erro inesperado: ${error.message}`, 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<span>‚úàÔ∏è</span><span>Enviar para Aprova√ß√£o</span>';
      }
    }

    function showSubmissionStatus(message, type) {
      const status = document.getElementById('aircraft-submission-status');
      status.classList.remove('hidden');
      status.className = `mt-3 rounded-lg p-3 text-sm ${type === 'success' ? 'bg-green-900/50 text-green-300 border border-green-700' : 'bg-red-900/50 text-red-300 border border-red-700'}`;
      status.textContent = message;
    }

    function exportAircraftToPDF() {
      // TODO: Implement PDF export
      alert('Funcionalidade de exporta√ß√£o PDF ser√° implementada em breve!');
    }
  </script>

</body>
</html>