<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Teste - Sistema Econ√¥mico Avan√ßado v3.0</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      color: #e2e8f0;
    }
  </style>
</head>
<body class="min-h-screen p-8">
  <div class="max-w-4xl mx-auto">
    <div class="bg-slate-800/50 backdrop-blur border border-slate-600/50 rounded-2xl p-8 mb-8">
      <h1 class="text-3xl font-bold text-center mb-2">‚ö° Sistema Econ√¥mico Avan√ßado v3.0</h1>
      <p class="text-center text-slate-400">Teste de Integra√ß√£o Completa</p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Testes de Migra√ß√£o -->
      <div class="bg-slate-800/30 border border-slate-600/50 rounded-xl p-6">
        <h2 class="text-xl font-semibold mb-4 text-emerald-400">üöÄ Migra√ß√£o de Dados</h2>
        <div class="space-y-3">
          <button id="btn-test-migration" class="w-full bg-red-600 hover:bg-red-500 text-white font-medium px-4 py-3 rounded-lg transition-colors">
            Executar Migra√ß√£o Completa
          </button>
          <div id="migration-status" class="text-sm text-slate-400"></div>
        </div>
      </div>

      <!-- Testes de Energia -->
      <div class="bg-slate-800/30 border border-slate-600/50 rounded-xl p-6">
        <h2 class="text-xl font-semibold mb-4 text-purple-400">‚ö° Sistema de Energia</h2>
        <div class="space-y-3">
          <button id="btn-test-energy" class="w-full bg-purple-600 hover:bg-purple-500 text-white font-medium px-4 py-3 rounded-lg transition-colors">
            Processar Turno de Energia
          </button>
          <div id="energy-status" class="text-sm text-slate-400"></div>
        </div>
      </div>

      <!-- Teste do EnergyManager -->
      <div class="bg-slate-800/30 border border-slate-600/50 rounded-xl p-6">
        <h2 class="text-xl font-semibold mb-4 text-blue-400">üè≠ Gest√£o de Usinas</h2>
        <div class="space-y-3">
          <select id="select-test-country" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2">
            <option value="">-- Selecione um pa√≠s --</option>
          </select>
          <button id="btn-test-energy-manager" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-medium px-4 py-3 rounded-lg transition-colors">
            Abrir Gerenciador de Energia
          </button>
          <div id="energy-manager-status" class="text-sm text-slate-400"></div>
        </div>
      </div>

      <!-- Teste dos C√°lculos -->
      <div class="bg-slate-800/30 border border-slate-600/50 rounded-xl p-6">
        <h2 class="text-xl font-semibold mb-4 text-amber-400">üìä Testes de C√°lculo</h2>
        <div class="space-y-3">
          <button id="btn-test-calculations" class="w-full bg-amber-600 hover:bg-amber-500 text-white font-medium px-4 py-3 rounded-lg transition-colors">
            Testar C√°lculos Econ√¥micos
          </button>
          <div id="calculations-status" class="text-sm text-slate-400"></div>
        </div>
      </div>
    </div>

    <!-- Log de Resultados -->
    <div class="mt-8 bg-slate-900/50 border border-slate-600/50 rounded-xl p-6">
      <h3 class="text-lg font-semibold mb-4">üìã Log de Execu√ß√£o</h3>
      <div id="test-log" class="bg-slate-950/50 rounded-lg p-4 text-sm font-mono max-h-96 overflow-y-auto">
        <div class="text-slate-400">Aguardando testes...</div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="./js/services/firebase.js" type="module"></script>
  <script type="module">
    import { db, auth, getAllCountries } from './js/services/firebase.js';
    import { runAdvancedEconomyMigration } from './scripts/migrate-advanced-economy.js';
    import { processEnergySystemTurn } from './js/systems/energyPenaltyProcessor.js';
    import { EnergyManager } from './js/components/energyManager.js';
    import EconomicCalculations from './js/systems/economicCalculations.js';

    const log = document.getElementById('test-log');
    const statusElements = {
      migration: document.getElementById('migration-status'),
      energy: document.getElementById('energy-status'),
      manager: document.getElementById('energy-manager-status'),
      calculations: document.getElementById('calculations-status')
    };

    function addLog(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const colors = {
        info: 'text-blue-400',
        success: 'text-emerald-400',
        error: 'text-red-400',
        warning: 'text-amber-400'
      };

      log.innerHTML += `<div class="${colors[type]}">[${timestamp}] ${message}</div>`;
      log.scrollTop = log.scrollHeight;
    }

    function updateStatus(element, message, type = 'info') {
      const colors = {
        info: 'text-slate-400',
        success: 'text-emerald-400',
        error: 'text-red-400',
        warning: 'text-amber-400'
      };

      element.innerHTML = message;
      element.className = `text-sm ${colors[type]}`;
    }

    // Carregamento inicial
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        addLog('Usu√°rio autenticado: ' + user.email, 'success');
        await loadCountries();
      } else {
        addLog('Usu√°rio n√£o autenticado', 'warning');
      }
    });

    async function loadCountries() {
      try {
        const countries = await getAllCountries();
        const select = document.getElementById('select-test-country');

        select.innerHTML = '<option value="">-- Selecione um pa√≠s --</option>';
        countries.forEach(country => {
          select.innerHTML += `<option value="${country.id}">${country.Pais || country.id}</option>`;
        });

        addLog(`${countries.length} pa√≠ses carregados`, 'success');
      } catch (error) {
        addLog('Erro ao carregar pa√≠ses: ' + error.message, 'error');
      }
    }

    // Teste de Migra√ß√£o
    document.getElementById('btn-test-migration').addEventListener('click', async () => {
      const btn = document.getElementById('btn-test-migration');
      try {
        btn.disabled = true;
        btn.textContent = 'Migrando...';
        updateStatus(statusElements.migration, 'Executando migra√ß√£o...', 'warning');
        addLog('Iniciando migra√ß√£o de dados', 'info');

        await runAdvancedEconomyMigration();

        updateStatus(statusElements.migration, 'Migra√ß√£o conclu√≠da com sucesso', 'success');
        addLog('Migra√ß√£o de dados conclu√≠da', 'success');
      } catch (error) {
        updateStatus(statusElements.migration, 'Erro na migra√ß√£o', 'error');
        addLog('Erro na migra√ß√£o: ' + error.message, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Executar Migra√ß√£o Completa';
      }
    });

    // Teste de Energia
    document.getElementById('btn-test-energy').addEventListener('click', async () => {
      const btn = document.getElementById('btn-test-energy');
      try {
        btn.disabled = true;
        btn.textContent = 'Processando...';
        updateStatus(statusElements.energy, 'Processando turno de energia...', 'warning');
        addLog('Iniciando processamento de energia', 'info');

        await processEnergySystemTurn();

        updateStatus(statusElements.energy, 'Processamento conclu√≠do', 'success');
        addLog('Turno de energia processado com sucesso', 'success');
      } catch (error) {
        updateStatus(statusElements.energy, 'Erro no processamento', 'error');
        addLog('Erro no processamento: ' + error.message, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Processar Turno de Energia';
      }
    });

    // Teste do EnergyManager
    document.getElementById('btn-test-energy-manager').addEventListener('click', async () => {
      const select = document.getElementById('select-test-country');
      const countryId = select.value;

      if (!countryId) {
        updateStatus(statusElements.manager, 'Selecione um pa√≠s primeiro', 'error');
        return;
      }

      try {
        updateStatus(statusElements.manager, 'Abrindo gerenciador...', 'warning');
        addLog(`Abrindo EnergyManager para ${select.options[select.selectedIndex].text}`, 'info');

        // Criar modal de teste
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4';
        modal.innerHTML = `
          <div class="bg-slate-800 border border-slate-600/70 rounded-2xl w-full max-w-5xl max-h-[90vh] overflow-hidden">
            <div class="flex items-center justify-between p-6 border-b border-slate-600/50">
              <h3 class="text-xl font-bold text-slate-100">‚ö° Teste EnergyManager</h3>
              <button id="close-test-modal" class="text-slate-400 hover:text-slate-200 text-2xl">√ó</button>
            </div>
            <div id="panel-energia" class="p-6 max-h-[70vh] overflow-y-auto"></div>
          </div>
        `;

        document.body.appendChild(modal);

        const energyManager = new EnergyManager();
        await energyManager.initialize(countryId);

        modal.querySelector('#close-test-modal').addEventListener('click', () => {
          modal.remove();
        });

        updateStatus(statusElements.manager, 'EnergyManager aberto com sucesso', 'success');
        addLog('EnergyManager carregado e funcional', 'success');

      } catch (error) {
        updateStatus(statusElements.manager, 'Erro ao abrir gerenciador', 'error');
        addLog('Erro no EnergyManager: ' + error.message, 'error');
      }
    });

    // Teste de C√°lculos
    document.getElementById('btn-test-calculations').addEventListener('click', async () => {
      try {
        updateStatus(statusElements.calculations, 'Executando testes...', 'warning');
        addLog('Iniciando testes de c√°lculos econ√¥micos', 'info');

        // Teste 1: C√°lculo de demanda de energia
        const mockCountry = {
          PIB: 1000000000,
          Populacao: 10000000,
          Urbanizacao: 60,
          IndustrialEfficiency: 45
        };

        const demandResult = EconomicCalculations.computeEnergyDemandGW(mockCountry);
        addLog(`Demanda estimada: ${demandResult.demandaGW} GW (${demandResult.perCapitaKWh} kWh per capita)`, 'info');

        // Teste 2: C√°lculo de bens de consumo
        const consumerGoods = EconomicCalculations.computeConsumerGoodsIndexV2(mockCountry, {
          Graos: 80,
          Combustivel: 60,
          EnergiaDisponivel: 120
        });
        addLog(`√çndice de Bens de Consumo: ${consumerGoods.index}% (fator urbano: ${consumerGoods.urbanFactor})`, 'info');

        // Teste 3: Penalidade de energia
        const penalty = EconomicCalculations.computeEnergyPenalty(100, 150);
        addLog(`Penalidade de energia (100MW/150MW): ${(penalty * 100).toFixed(1)}%`, 'info');

        updateStatus(statusElements.calculations, 'Todos os testes passaram', 'success');
        addLog('Testes de c√°lculos conclu√≠dos com sucesso', 'success');

      } catch (error) {
        updateStatus(statusElements.calculations, 'Erro nos testes', 'error');
        addLog('Erro nos testes de c√°lculo: ' + error.message, 'error');
      }
    });

    // Inicializa√ß√£o
    addLog('Sistema de testes carregado', 'success');
    addLog('Aguardando autentica√ß√£o...', 'info');
  </script>
</body>
</html>