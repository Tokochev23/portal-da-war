const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/firebase-BN3MSMQD.js","assets/preload-helper-f85Crcwt.js","assets/utils-DLoRv3re.js"])))=>i.map(i=>d[i]);
import{_ as C}from"./preload-helper-f85Crcwt.js";import{db as c}from"./firebase-BN3MSMQD.js";import{g as x,a as v}from"./resourceMapping-BBQTZbLj.js";import"./utils-DLoRv3re.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-functions-compat.js";class O{constructor(){this.ordersCollection="marketplace_recurring_orders",this.transactionsCollection="marketplace_recurring_transactions",this.matchesCollection="marketplace_order_matches"}async createRecurringOrder(e){try{console.log("üìù Criando ordem recorrente:",e),this.validateOrderData(e);const t=x(e.item_id);if(!t)throw new Error(`Tipo de recurso n√£o reconhecido: ${e.item_id}`);const r=await c.collection("paises").doc(e.country_id).get();if(!r.exists)throw new Error("Pa√≠s n√£o encontrado");const o=r.data();e.order_type==="sell"?await this.validateSellOrder(e,o,t):e.order_type==="buy"&&await this.validateBuyOrder(e,o,t);const a=await C(()=>import("./firebase-BN3MSMQD.js"),__vite__mapDeps([0,1,2])).then(i=>i.auth.currentUser),s=e.player_id||a?.uid||null,n={country_id:e.country_id,country_name:o.Pais||o.Nome||"Unknown",country_flag:o.Flag||"üè≥Ô∏è",player_id:s,order_type:e.order_type,item_id:e.item_id,item_name:t.name,quantity:parseFloat(e.quantity),unit:t.defaultUnit,price_per_unit:parseFloat(e.price_per_unit),min_stock_reserve:parseFloat(e.min_stock_reserve||0),min_budget_reserve:parseFloat(e.min_budget_reserve||0),max_price_buy:e.order_type==="buy"?parseFloat(e.max_price_buy||e.price_per_unit*1.2):null,min_price_sell:e.order_type==="sell"?parseFloat(e.min_price_sell||e.price_per_unit*.8):null,status:"active",created_at:new Date,updated_at:new Date,last_execution:null,total_executed:0,total_volume:0,total_value:0,auto_renew:!0,expires_at:null},l=await c.collection(this.ordersCollection).add(n);return console.log("‚úÖ Ordem recorrente criada:",l.id),await this.matchOrders(l.id),{success:!0,orderId:l.id,order:n}}catch(t){throw console.error("‚ùå Erro ao criar ordem recorrente:",t),t}}validateOrderData(e){const t=["country_id","order_type","item_id","quantity","price_per_unit"];for(const r of t)if(!e[r])throw new Error(`Campo obrigat√≥rio faltando: ${r}`);if(!["buy","sell"].includes(e.order_type))throw new Error('order_type deve ser "buy" ou "sell"');if(e.quantity<=0)throw new Error("Quantidade deve ser maior que zero");if(e.price_per_unit<=0)throw new Error("Pre√ßo deve ser maior que zero")}async validateSellOrder(e,t,r){const o=v(e.item_id),a=window.ResourceProductionCalculator?.calculateCountryProduction(t)[o]||0,s=window.ResourceConsumptionCalculator?.calculateCountryConsumption(t)[o]||0,n=Math.max(0,a-s),l=e.quantity+(e.min_stock_reserve||0);if(n<l)throw new Error(`Estoque insuficiente. Necess√°rio: ${l.toLocaleString()} ${r.defaultUnit} (${e.quantity.toLocaleString()} venda + ${e.min_stock_reserve?.toLocaleString()||0} reserva). Dispon√≠vel: ${n.toLocaleString()}`)}async validateBuyOrder(e,t,r){const o=this.calculateBudget(t),a=e.quantity*e.price_per_unit,s=a+(e.min_budget_reserve||0);if(o<s)throw new Error(`Or√ßamento insuficiente. Necess√°rio: $${s.toLocaleString()} ($${a.toLocaleString()} compra + $${e.min_budget_reserve?.toLocaleString()||0} reserva). Dispon√≠vel: $${o.toLocaleString()}`)}calculateBudget(e){const t=parseFloat(e.PIB)||0,r=(parseFloat(e.Burocracia)||0)/100,o=(parseFloat(e.Estabilidade)||0)/100,a=t*.25*r*(o*1.5),s=parseFloat(e.OrcamentoGasto||0),n=parseFloat(e.AgencyBudgetSpent||0);return Math.max(0,a-s-n)}async matchOrders(e=null){try{console.log("üîç Procurando matches para ordens...");let t=[];if(e){const o=await c.collection(this.ordersCollection).doc(e).get();o.exists&&o.data().status==="active"&&(t=[{id:o.id,...o.data()}])}else t=(await c.collection(this.ordersCollection).where("status","==","active").get()).docs.map(a=>({id:a.id,...a.data()}));const r=[];for(const o of t.filter(a=>a.order_type==="sell")){const a=await c.collection(this.ordersCollection).where("order_type","==","buy").where("item_id","==",o.item_id).where("status","==","active").get();for(const s of a.docs){const n={id:s.id,...s.data()};if(n.country_id===o.country_id)continue;const l=o.price_per_unit,i=n.price_per_unit,_=o.min_price_sell||l*.8,d=n.max_price_buy||i*1.2;if(i>=_&&i<=d){const m=(l+i)/2,y=Math.min(o.quantity,n.quantity),h={sell_order_id:o.id,buy_order_id:n.id,item_id:o.item_id,quantity:y,price:m,total_value:y*m,status:"pending",created_at:new Date};await c.collection(this.matchesCollection).add(h),r.push(h),console.log(`‚úÖ Match criado: ${o.country_name} vende ${y} ${o.unit} de ${o.item_name} para ${n.country_name} por $${m.toFixed(2)}/${o.unit}`)}}}return console.log(`üéØ Total de matches criados: ${r.length}`),r}catch(t){throw console.error("‚ùå Erro ao fazer matching de ordens:",t),t}}async processTurnRecurringOrders(e){try{console.log(`üîÑ Processando ordens recorrentes do turno ${e}...`);const t=await c.collection(this.matchesCollection).where("status","==","pending").get(),r={total:t.size,executed:0,failed:0,errors:[]};for(const o of t.docs){const a=o.data();try{const s=await this.executeRecurringTransaction(a,e);s.success?(r.executed++,await o.ref.update({status:"completed",executed_at:new Date})):(r.failed++,r.errors.push({matchId:o.id,reason:s.reason}),await o.ref.update({status:"failed",error:s.reason}))}catch(s){r.failed++,r.errors.push({matchId:o.id,error:s.message}),console.error(`‚ùå Erro ao executar match ${o.id}:`,s)}}return console.log(`‚úÖ Processamento conclu√≠do: ${r.executed} executadas, ${r.failed} falhas`),r}catch(t){throw console.error("‚ùå Erro ao processar ordens recorrentes:",t),t}}async executeRecurringTransaction(e,t){try{console.log("‚öôÔ∏è Executando transa√ß√£o recorrente:",e);const r=await c.collection(this.ordersCollection).doc(e.sell_order_id).get(),o=await c.collection(this.ordersCollection).doc(e.buy_order_id).get();if(!r.exists||!o.exists)return{success:!1,reason:"Ordens n√£o encontradas"};const a={id:r.id,...r.data()},s={id:o.id,...o.data()},n=await c.collection("paises").doc(a.country_id).get(),l=await c.collection("paises").doc(s.country_id).get();if(!n.exists||!l.exists)return{success:!1,reason:"Pa√≠ses n√£o encontrados"};const i=n.data(),_=l.data(),d=v(a.item_id),m=window.ResourceProductionCalculator?.calculateCountryProduction(i)[d]||0,y=window.ResourceConsumptionCalculator?.calculateCountryConsumption(i)[d]||0;if(Math.max(0,m-y)<e.quantity+a.min_stock_reserve)return await c.collection(this.ordersCollection).doc(a.id).update({status:"out_of_stock",updated_at:new Date}),{success:!1,reason:"Vendedor sem estoque suficiente"};const f=this.calculateBudget(_),u=e.quantity*e.price;if(f<u+s.min_budget_reserve)return await c.collection(this.ordersCollection).doc(s.id).update({status:"out_of_budget",updated_at:new Date}),{success:!1,reason:"Comprador sem or√ßamento suficiente"};const p=c.batch(),w=parseFloat(i[d]||0);p.update(c.collection("paises").doc(a.country_id),{[d]:w-e.quantity,OrcamentoGasto:Math.max(0,parseFloat(i.OrcamentoGasto||0)-u),updated_at:new Date});const g=parseFloat(_[d]||0);p.update(c.collection("paises").doc(s.country_id),{[d]:g+e.quantity,OrcamentoGasto:parseFloat(_.OrcamentoGasto||0)+u,updated_at:new Date});const b=c.collection(this.transactionsCollection).doc();return p.set(b,{sell_order_id:a.id,buy_order_id:s.id,seller_country_id:a.country_id,seller_country_name:a.country_name,buyer_country_id:s.country_id,buyer_country_name:s.country_name,item_id:a.item_id,item_name:a.item_name,quantity:e.quantity,unit:a.unit,price_per_unit:e.price,total_value:u,executed_at:new Date,turn_number:t,status:"completed",seller_budget_before:this.calculateBudget(i),seller_budget_after:this.calculateBudget({...i,OrcamentoGasto:Math.max(0,parseFloat(i.OrcamentoGasto||0)-u)}),buyer_budget_before:f,buyer_budget_after:this.calculateBudget({..._,OrcamentoGasto:parseFloat(_.OrcamentoGasto||0)+u}),seller_stock_before:w,seller_stock_after:w-e.quantity,buyer_stock_before:g,buyer_stock_after:g+e.quantity}),p.update(c.collection(this.ordersCollection).doc(a.id),{last_execution:new Date,total_executed:(a.total_executed||0)+1,total_volume:(a.total_volume||0)+e.quantity,total_value:(a.total_value||0)+u,updated_at:new Date}),p.update(c.collection(this.ordersCollection).doc(s.id),{last_execution:new Date,total_executed:(s.total_executed||0)+1,total_volume:(s.total_volume||0)+e.quantity,total_value:(s.total_value||0)+u,updated_at:new Date}),await p.commit(),console.log(`‚úÖ Transa√ß√£o executada: ${a.country_name} vendeu ${e.quantity} ${a.unit} de ${a.item_name} para ${s.country_name} por $${u.toLocaleString()}`),{success:!0,transactionId:b.id}}catch(r){return console.error("‚ùå Erro ao executar transa√ß√£o recorrente:",r),{success:!1,error:r.message}}}async cancelOrder(e){try{return await c.collection(this.ordersCollection).doc(e).update({status:"cancelled",updated_at:new Date}),console.log("‚úÖ Ordem cancelada:",e),{success:!0}}catch(t){throw console.error("‚ùå Erro ao cancelar ordem:",t),t}}async pauseOrder(e){try{return await c.collection(this.ordersCollection).doc(e).update({status:"paused",updated_at:new Date}),console.log("‚è∏Ô∏è Ordem pausada:",e),{success:!0}}catch(t){throw console.error("‚ùå Erro ao pausar ordem:",t),t}}async reactivateOrder(e){try{return await c.collection(this.ordersCollection).doc(e).update({status:"active",updated_at:new Date}),console.log("‚ñ∂Ô∏è Ordem reativada:",e),await this.matchOrders(e),{success:!0}}catch(t){throw console.error("‚ùå Erro ao reativar ordem:",t),t}}async getCountryOrders(e,t=null){try{let r=c.collection(this.ordersCollection).where("country_id","==",e);return t&&(r=r.where("status","==",t)),(await r.orderBy("created_at","desc").get()).docs.map(a=>({id:a.id,...a.data()}))}catch(r){throw console.error("‚ùå Erro ao listar ordens:",r),r}}async getCountryTransactions(e,t=50){try{const r=await c.collection(this.transactionsCollection).where("seller_country_id","==",e).orderBy("executed_at","desc").limit(t).get(),o=await c.collection(this.transactionsCollection).where("buyer_country_id","==",e).orderBy("executed_at","desc").limit(t).get(),a=[...r.docs.map(s=>({id:s.id,type:"sell",...s.data()})),...o.docs.map(s=>({id:s.id,type:"buy",...s.data()}))];return a.sort((s,n)=>n.executed_at.toMillis()-s.executed_at.toMillis()),a.slice(0,t)}catch(r){throw console.error("‚ùå Erro ao buscar hist√≥rico de transa√ß√µes:",r),r}}}window.RecurringOrdersSystem=O;export{O as RecurringOrdersSystem};
