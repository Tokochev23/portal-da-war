const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/turnProcessor-885tCVLN.js","assets/preload-helper-f85Crcwt.js","assets/utils-DLoRv3re.js","assets/consumerGoodsCalculator-RQh-OK8I.js","assets/turnEventsSystem-US8vT2BV.js","assets/espionageOperationsSystem-VZyzbeX4.js","assets/shipyardSystem-B7HEfEsS.js","assets/lawAndExhaustionCalculator-COcnTsA2.js"])))=>i.map(i=>d[i]);
import{_ as A}from"./preload-helper-f85Crcwt.js";import{L as i,s as y,V as g,g as d,F as p}from"./utils-DLoRv3re.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-functions-compat.js";const h={apiKey:window.FIREBASE_API_KEY||"AIzaSyBd-cQsmXqgU9wVDtxYdaeLFQIfIUxv6GE",authDomain:window.FIREBASE_AUTH_DOMAIN||"war-1954-1799c.firebaseapp.com",projectId:window.FIREBASE_PROJECT_ID||"war-1954-1799c",storageBucket:window.FIREBASE_STORAGE_BUCKET||"war-1954-1799c.firebasestorage.app",messagingSenderId:window.FIREBASE_MESSAGING_SENDER_ID||"147967902110",appId:window.FIREBASE_APP_ID||"1:147967902110:web:2e2a54b98ef9474d7a968f",measurementId:window.FIREBASE_MEASUREMENT_ID||"G-LQNDE985RB",databaseURL:window.FIREBASE_DATABASE_URL||void 0};function R(a){const e=["apiKey","authDomain","projectId"];for(const o of e)if(!a[o])throw new Error(`Configuração Firebase inválida: ${o} é obrigatório`);return a}if(!h.databaseURL&&h.projectId)try{const a=h.projectId;h.databaseURL=`https://${a}-default-rtdb.firebaseio.com/`}catch{}const T=R(h),v={maxLoginAttempts:3,rateLimiting:{windowMs:900*1e3}};let L,f,n,D,u,P=new Map;class l{static getErrorMessage(e){const o={"auth/user-not-found":"Usuário não encontrado. Verifique o email.","auth/wrong-password":"Senha incorreta. Tente novamente.","auth/email-already-in-use":"Este email já está em uso.","auth/weak-password":"A senha é muito fraca. Use pelo menos 6 caracteres.","auth/invalid-email":"Email inválido. Verifique o formato.","auth/too-many-requests":"Muitas tentativas. Tente novamente mais tarde.","auth/network-request-failed":"Erro de conexão. Verifique sua internet.","permission-denied":"Acesso negado. Verifique suas permissões.",unavailable:"Serviço temporariamente indisponível.",cancelled:"Operação cancelada.","deadline-exceeded":"Tempo limite excedido. Tente novamente.","not-found":"Documento não encontrado.","already-exists":"Documento já existe.","resource-exhausted":"Limite de requisições excedido.","failed-precondition":"Condição prévia falhou.",aborted:"Operação abortada.","out-of-range":"Valor fora do intervalo permitido.",unimplemented:"Funcionalidade não implementada.",internal:"Erro interno do servidor.","data-loss":"Perda de dados detectada."},r=e.code||e.message;return o[r]||`Erro: ${e.message||"Erro desconhecido"}`}static handleError(e,o="operação"){const r=this.getErrorMessage(e);return i.error(`Firebase ${o} failed:`,e),y("error",r,{duration:6e3}),{success:!1,error:e,message:r}}}function w(a){const e=Date.now(),r=(P.get(a)||[]).filter(t=>e-t<v.rateLimiting.windowMs);if(r.length>=v.maxLoginAttempts)throw new Error("too-many-requests");r.push(e),P.set(a,r)}try{u=window.firebase,L=u.initializeApp(T),f=u.auth(),n=u.firestore(),D=u.storage(),n.enablePersistence({synchronizeTabs:!0}).catch(a=>i.warn("Não foi possível habilitar persistência:",a)),i.info("Firebase inicializado com sucesso")}catch(a){i.error("Erro crítico ao inicializar Firebase:",a),y("error","Erro crítico: Não foi possível conectar ao servidor. Recarregue a página.",{persistent:!0})}const E=new u.auth.GoogleAuthProvider;E.addScope("profile");E.addScope("email");window.db=n;window.auth=f;async function S(){try{w("google-login");const e=(await f.signInWithPopup(E)).user;if(!e.email||!g.isValidEmail(e.email))throw new Error("Email inválido recebido do Google");return await n.collection("usuarios").doc(e.uid).set({nome:g.sanitizeInput(e.displayName||"Usuário",{maxLength:100}),email:e.email.toLowerCase(),photoURL:e.photoURL||null,papel:"jogador",dataIngresso:u.firestore.Timestamp.now(),ultimoLogin:u.firestore.Timestamp.now(),ativo:!0,versaoTermos:"1.0"},{merge:!0}),i.info("Login Google realizado com sucesso",{uid:e.uid,email:e.email}),{success:!0,user:e}}catch(a){return l.handleError(a,"login com Google")}}async function U(a,e,o){try{if(!g.isValidEmail(a))throw new Error("invalid-email");if(!g.isStrongPassword(e))throw new Error("weak-password");const r=g.sanitizeInput(o,{maxLength:100});if(!r||r.length<2)throw new Error("Nome deve ter pelo menos 2 caracteres");w(a.toLowerCase());const s=(await f.createUserWithEmailAndPassword(a.toLowerCase(),e)).user;return await s.updateProfile({displayName:r}),await n.collection("usuarios").doc(s.uid).set({nome:r,email:a.toLowerCase(),papel:"jogador",dataIngresso:u.firestore.Timestamp.now(),ultimoLogin:u.firestore.Timestamp.now(),ativo:!0,versaoTermos:"1.0",configuracoes:{notificacoes:!0,tema:"dark"}}),i.info("Registro realizado com sucesso",{uid:s.uid,email:s.email}),{success:!0,user:s}}catch(r){return l.handleError(r,"registro")}}async function $(a,e){try{if(!g.isValidEmail(a))throw new Error("invalid-email");if(!e||e.length<6)throw new Error("wrong-password");w(a.toLowerCase());const o=await f.signInWithEmailAndPassword(a.toLowerCase(),e);try{await n.collection("usuarios").doc(o.user.uid).update({ultimoLogin:u.firestore.Timestamp.now()})}catch(r){i.warn("Não foi possível atualizar último login:",r)}return i.info("Login realizado com sucesso",{uid:o.user.uid,email:o.user.email}),{success:!0,user:o.user}}catch(o){return l.handleError(o,"login")}}async function M(a,e){if(!a||!e){const o=new Error("userId e paisId são obrigatórios");return l.handleError(o,"vinculação jogador-país")}try{const o=await n.collection("paises").doc(e).get();if(!o.exists)throw new Error("País não encontrado");if(o.data().Player)throw new Error("País já possui um jogador");return await n.runTransaction(async t=>{t.update(n.collection("paises").doc(e),{Player:a,DataVinculacao:u.firestore.Timestamp.now()}),t.set(n.collection("usuarios").doc(a),{paisId:e,papel:"jogador",ultimaAtualizacao:u.firestore.Timestamp.now(),ativo:!0},{merge:!0})}),d.clear(),i.info("Jogador vinculado ao país com sucesso",{userId:a,paisId:e}),{success:!0}}catch(o){return l.handleError(o,"vinculação jogador-país")}}async function b(a,e=!0){if(!a)return i.warn("checkUserPermissions: userId é obrigatório"),{isNarrator:!1,isAdmin:!1,isPlayer:!0};const o=`permissions-${a}`;try{if(e){const s=d.get(o);if(s)return i.debug(`Permissões do usuário ${a} carregadas do cache`),s}const r=await n.collection("usuarios").doc(a).get();let t={isNarrator:!1,isAdmin:!1,isPlayer:!0,role:"jogador"};if(r.exists){const s=r.data(),c=s.papel||"jogador";t={isNarrator:c==="narrador"||c==="admin",isAdmin:c==="admin",isPlayer:c==="jogador"||c==="narrador"||c==="admin",role:c,ativo:s.ativo!==!1}}return d.set(o,t,6e5),i.debug(`Permissões verificadas para ${a}:`,t),t}catch(r){return i.error("Erro ao verificar permissões:",r),{isNarrator:!1,isAdmin:!1,isPlayer:!0,role:"jogador"}}}async function F(a,e=!0){if(!a)return i.warn("checkPlayerCountry: userId é obrigatório"),null;const o=`player-country-${a}`;try{if(e){const s=d.get(o);if(s!==null)return i.debug(`País do jogador ${a} carregado do cache: ${s}`),s}const r=await n.collection("usuarios").doc(a).get();let t=null;return r.exists&&(t=r.data().paisId||null),d.set(o,t,3e5),i.debug(`País do jogador ${a}: ${t||"nenhum"}`),t}catch(r){return i.error("Erro ao verificar país do jogador:",r),null}}async function B(a=!0){const e="available-countries";try{if(a){const s=d.get(e);if(s)return i.debug("Países disponíveis carregados do cache"),s}const t=(await n.collection("paises").where("Player","in",[null,"",void 0]).get()).docs.map(s=>{const c=s.data();return{id:s.id,...c,Pais:g.sanitizeInput(c.Pais||"",{maxLength:100})}}).filter(s=>s.Pais&&s.PIB!==void 0);return d.set(e,t,18e4),i.info(`${t.length} países disponíveis encontrados`),t}catch(o){return l.handleError(o,"busca de países disponíveis"),[]}}async function G(a=!0){const e="all-countries";try{if(a){const s=d.get(e);if(s)return i.debug("Países carregados do cache"),s}const r=await n.collection("paises").get();if(r.empty)return i.warn("Nenhum país encontrado na coleção"),[];const t=r.docs.map(s=>{const c=s.data(),m={id:s.id,...c,Pais:g.sanitizeInput(c.Pais||"",{maxLength:100}),PIB:Math.max(0,p.parseNumber(c.PIB)||0)};if(m.Carvao===void 0&&(m.Carvao=0),m.PotencialCarvao===void 0)switch(m.Pais){case"Alemanha":m.PotencialCarvao=10;break;case"Reino Unido":m.PotencialCarvao=9;break;case"Brasil":m.PotencialCarvao=4;break;default:m.PotencialCarvao=5}return m.power_plants===void 0&&(m.power_plants=[]),m.PotencialHidreletrico===void 0&&(m.PotencialHidreletrico=5),m});return d.set(e,t,3e5),i.info(`${t.length} países carregados com sucesso`),t}catch(o){return l.handleError(o,"carregamento de países"),[]}}async function V(a,e=!0){if(!a)return i.warn("getCountryData: paisId é obrigatório"),null;const o=`country-${a}`;try{if(e){const c=d.get(o);if(c)return i.debug(`Dados do país ${a} carregados do cache`),c}const r=await n.collection("paises").doc(a).get();if(!r.exists)return i.warn(`País ${a} não encontrado`),null;const t=r.data(),s={...t,Pais:g.sanitizeInput(t.Pais||"",{maxLength:100}),PIB:Math.max(0,p.parseNumber(t.PIB)||0),Estabilidade:Math.max(0,Math.min(100,p.parseNumber(t.Estabilidade)||0)),Tecnologia:Math.max(0,p.parseNumber(t.Tecnologia)||0),Aeronautica:Math.max(0,p.parseNumber(t.Aeronautica)||0),Veiculos:Math.max(0,p.parseNumber(t.Veiculos)||0),Marinha:Math.max(0,p.parseNumber(t.Marinha)||0)};return d.set(o,s,18e4),i.debug(`Dados do país ${a} carregados com sucesso`),s}catch(r){return l.handleError(r,`carregamento do país ${a}`),null}}async function k(a=!0){const e="game-config";try{if(a){const t=d.get(e);if(t)return i.debug("Configuração do jogo carregada do cache"),t}const o=await n.collection("configuracoes").doc("jogo").get();let r=null;return o.exists&&(r=o.data(),r.turnoAtual!==void 0&&(r.turnoAtual=Math.max(0,parseInt(r.turnoAtual)||0))),d.set(e,r,12e4),i.debug("Configuração do jogo carregada:",r),r}catch(o){return i.error("Erro ao carregar configuração do jogo:",o),null}}async function q(){try{const a=await n.collection("configuracoes").doc("regrasDinamicas").get();return a.exists?(i.debug("Regras dinâmicas carregadas do Firestore"),a.data()):(i.debug("Nenhum documento de regras dinâmicas encontrado, usando objeto vazio."),{})}catch(a){return l.handleError(a,"carregamento de regras dinâmicas"),{}}}async function K(a,e=null){try{if(typeof a!="object"||a===null)throw new Error("Objeto de regras inválido.");if(e){const r=await b(e,!1);if(!r.isNarrator&&!r.isAdmin)throw new Error("Acesso negado: apenas narradores podem salvar regras.")}const o={...a,ultimaAtualizacao:u.firestore.Timestamp.now(),ultimoEditor:e||"desconhecido"};return await n.collection("configuracoes").doc("regrasDinamicas").set(o),d.clear(),i.info("Regras dinâmicas salvas com sucesso",{userId:e}),y("success","Conjunto de regras customizadas foi salvo!"),{success:!0}}catch(o){return l.handleError(o,"salvamento de regras dinâmicas")}}async function W(a,e=null){try{const o=parseInt(a);if(isNaN(o)||o<0)throw new Error("Número do turno inválido");if(e){const t=await b(e,!1);if(!t.isNarrator&&!t.isAdmin)throw new Error("Acesso negado: apenas narradores podem atualizar turnos")}const r={turnoAtual:o,ultimaAtualizacao:u.firestore.Timestamp.now()};e&&(r.ultimoEditor=e),await n.collection("configuracoes").doc("jogo").set(r,{merge:!0});try{const{default:t}=await A(async()=>{const{default:c}=await import("./turnProcessor-885tCVLN.js");return{default:c}},__vite__mapDeps([0,1,2,3,4,5,6,7]));if(await t.isTurnProcessed(o))i.info(`Turno ${o} já foi processado anteriormente`);else{i.info(`Iniciando processamento automático do turno ${o}`);const c=await t.processTurnEnd(o);i.info(`Processamento do turno ${o} concluído`,c)}}catch(t){i.error("Erro no processamento automático do turno:",t),console.warn("⚠️ Erro no processamento automático, mas turno foi atualizado")}return d.clear(),i.info(`Turno atualizado para #${o}`,{userId:e,newTurn:o}),{success:!0,turno:o}}catch(o){return l.handleError(o,"atualização de turno")}}async function O(){try{w("google-login");const e=(await f.signInWithPopup(E)).user;if(!e.email||!g.isValidEmail(e.email))throw new Error("Email inválido recebido do Google");const o=n.collection("usuarios").doc(e.uid),r=await o.get(),t={nome:g.sanitizeInput(e.displayName||"Usuário",{maxLength:100}),email:e.email.toLowerCase(),photoURL:e.photoURL||null,ultimoLogin:u.firestore.Timestamp.now(),ativo:!0,versaoTermos:"1.0"};return r.exists?(r.data()||{}).papel||(t.papel="jogador"):(t.dataIngresso=u.firestore.Timestamp.now(),t.papel="jogador"),await o.set(t,{merge:!0}),i.info("Login Google (preservando papel) realizado com sucesso",{uid:e.uid,email:e.email}),{success:!0,user:e}}catch(a){return l.handleError(a,"login com Google (preservar papel)")}}async function J(a,e){if(!a||!e){const o=new Error("userId e paisId são obrigatórios");return l.handleError(o,"vinculação jogador-país (preservar papel)")}try{const o=await n.collection("paises").doc(e).get();if(!o.exists)throw new Error("País não encontrado");if(o.data().Player)throw new Error("País já possui um jogador");return await n.runTransaction(async t=>{t.update(n.collection("paises").doc(e),{Player:a,DataVinculacao:u.firestore.Timestamp.now()}),t.set(n.collection("usuarios").doc(a),{paisId:e,ultimaAtualizacao:u.firestore.Timestamp.now(),ativo:!0},{merge:!0})}),d.clear(),i.info("Jogador vinculado ao país (preservando papel) com sucesso",{userId:a,paisId:e}),{success:!0}}catch(o){return l.handleError(o,"vinculação jogador-país (preservar papel)")}}export{L as app,f as auth,F as checkPlayerCountry,b as checkUserPermissions,n as db,G as getAllCountries,B as getAvailableCountries,V as getCountryData,q as getCustomRules,k as getGameConfig,E as googleProvider,U as registerWithEmailPassword,K as saveCustomRules,$ as signInWithEmailPassword,S as signInWithGoogle,O as signInWithGooglePreserveRole,D as storage,W as updateTurn,M as vincularJogadorAoPais,J as vincularJogadorAoPaisSemRebaixar};
