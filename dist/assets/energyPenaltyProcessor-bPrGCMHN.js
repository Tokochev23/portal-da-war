import{getAllCountries as C,db as c}from"./firebase-ep1w8F7T.js";import{L as i}from"./utils-DLoRv3re.js";import{E as m}from"./economicCalculations-Dlmo5Lcc.js";import"./preload-helper-f85Crcwt.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-functions-compat.js";class h{constructor(){this.isProcessing=!1}async processAllCountries(){if(this.isProcessing){i.warn("EnergyPenaltyProcessor já está em execução");return}try{this.isProcessing=!0,i.info("Iniciando processamento de penalidades de energia...");const e=await C(),a=c.batch();let r=0;for(const o of e){const s=await this.processCountryEnergyPenalty(o);if(s.needsUpdate){const t=c.collection("paises").doc(o.id);a.update(t,s.updates),r++,s.penalty>0&&i.info(`${o.Pais}: déficit de ${s.deficitPercent}%, penalidade de -$${s.penalty.toFixed(0)}`)}}r>0?(await a.commit(),i.info(`Penalidades de energia aplicadas em ${r} países`)):i.info("Nenhum país precisou de penalidade de energia")}catch(e){i.error("Erro ao processar penalidades de energia:",e)}finally{this.isProcessing=!1}}async processCountryEnergyPenalty(e){try{const a=m.computeEnergyDemandGW(e),r=parseFloat(e.EnergiaCapacidade)||parseFloat(e.Energia?.capacidade)||0;if(r>=a.demandaGW)return{needsUpdate:!1};const s=(a.demandaGW-r)/a.demandaGW*100,t=m.computeEnergyPenalty(r,a.demandaGW),n=parseFloat(e.PIB)||0,d=n*Math.min(.02,(1-t)*.05);if(d>0){const l=Math.max(n-d,n*.98),P=l/(parseFloat(e.Populacao)||1),y=parseFloat(e.Estabilidade)||50,p=s>50?1:0,u={PIB:l,PIBPerCapita:P,"Energia.demanda":a.demandaGW,"geral.PIB":l,"geral.PIBPerCapita":P};return p>0&&(u.Estabilidade=Math.max(0,y-p),u["geral.Estabilidade"]=Math.max(0,y-p)),{needsUpdate:!0,updates:u,penalty:d,deficitPercent:s.toFixed(1)}}return{needsUpdate:!1}}catch(a){return i.error(`Erro ao processar penalidade para ${e.Pais}:`,a),{needsUpdate:!1}}}async processResourceConsumption(){try{const e=await C(),a=c.batch();let r=0;for(const o of e){if(!o.power_plants||o.power_plants.length===0)continue;const s={Carvao:parseFloat(o.CarvaoSaldo||o.Carvao||0),Combustivel:parseFloat(o.Combustivel||0),Uranio:parseFloat(o.Uranio||0)},t=m.calculateEnergyProduction(o,s);if(t.consumedResources&&Object.values(t.consumedResources).some(n=>n>0)){const n={};if(t.consumedResources.Carvao>0&&(n.CarvaoSaldo=Math.max(0,s.Carvao-t.consumedResources.Carvao)),t.consumedResources.Combustivel>0&&(n.Combustivel=Math.max(0,s.Combustivel-t.consumedResources.Combustivel)),t.consumedResources.Uranio>0&&(n.Uranio=Math.max(0,s.Uranio-t.consumedResources.Uranio)),Object.keys(n).length>0){const f=c.collection("paises").doc(o.id);a.update(f,n),r++}}}r>0&&(await a.commit(),i.info(`Consumo de recursos aplicado em ${r} países`))}catch(e){i.error("Erro ao processar consumo de recursos:",e)}}}const g=new h;async function M(){await Promise.all([g.processAllCountries(),g.processResourceConsumption()])}export{h as EnergyPenaltyProcessor,g as energyPenaltyProcessor,M as processEnergySystemTurn};
