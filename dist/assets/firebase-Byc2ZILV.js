const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/turnProcessor-CJO0FaZ_.js","assets/preload-helper-f85Crcwt.js","assets/utils-DLoRv3re.js","assets/consumerGoodsCalculator-RQh-OK8I.js","assets/turnEventsSystem-CRwqzoR2.js","assets/espionageOperationsSystem-BMSdpmVp.js","assets/shipyardSystem-OMSau52w.js","assets/lawAndExhaustionCalculator-COcnTsA2.js"])))=>i.map(i=>d[i]);
import{_ as N}from"./preload-helper-f85Crcwt.js";import{L as s,s as P,V as f,g as d,F as h}from"./utils-DLoRv3re.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-functions-compat.js";const w={apiKey:window.FIREBASE_API_KEY||"AIzaSyBd-cQsmXqgU9wVDtxYdaeLFQIfIUxv6GE",authDomain:window.FIREBASE_AUTH_DOMAIN||"war-1954-1799c.firebaseapp.com",projectId:window.FIREBASE_PROJECT_ID||"war-1954-1799c",storageBucket:window.FIREBASE_STORAGE_BUCKET||"war-1954-1799c.firebasestorage.app",messagingSenderId:window.FIREBASE_MESSAGING_SENDER_ID||"147967902110",appId:window.FIREBASE_APP_ID||"1:147967902110:web:2e2a54b98ef9474d7a968f",measurementId:window.FIREBASE_MEASUREMENT_ID||"G-LQNDE985RB",databaseURL:window.FIREBASE_DATABASE_URL||void 0};function C(e){const r=["apiKey","authDomain","projectId"];for(const a of r)if(!e[a])throw new Error(`Configuração Firebase inválida: ${a} é obrigatório`);return e}if(!w.databaseURL&&w.projectId)try{const e=w.projectId;w.databaseURL=`https://${e}-default-rtdb.firebaseio.com/`}catch{}const D=C(w),b={maxLoginAttempts:3,rateLimiting:{windowMs:900*1e3}};let L,p,c,j,u,A=new Map;class m{static getErrorMessage(r){const a={"auth/user-not-found":"Usu├írio n├úo encontrado. Verifique o email.","auth/wrong-password":"Senha incorreta. Tente novamente.","auth/email-already-in-use":"Este email j├í est├í em uso.","auth/weak-password":"A senha ├® muito fraca. Use pelo menos 6 caracteres.","auth/invalid-email":"Email inv├ílido. Verifique o formato.","auth/too-many-requests":"Muitas tentativas. Tente novamente mais tarde.","auth/network-request-failed":"Erro de conex├úo. Verifique sua internet.","permission-denied":"Acesso negado. Verifique suas permiss├Áes.",unavailable:"Servi├ºo temporariamente indispon├¡vel.",cancelled:"Opera├º├úo cancelada.","deadline-exceeded":"Tempo limite excedido. Tente novamente.","not-found":"Documento n├úo encontrado.","already-exists":"Documento j├í existe.","resource-exhausted":"Limite de requisi├º├Áes excedido.","failed-precondition":"Condi├º├úo pr├®via falhou.",aborted:"Opera├º├úo abortada.","out-of-range":"Valor fora do intervalo permitido.",unimplemented:"Funcionalidade n├úo implementada.",internal:"Erro interno do servidor.","data-loss":"Perda de dados detectada."},t=r.code||r.message;return a[t]||`Erro: ${r.message||"Erro desconhecido"}`}static handleError(r,a="opera├º├úo"){const t=this.getErrorMessage(r);return s.error(`Firebase ${a} failed:`,r),P("error",t,{duration:6e3}),{success:!1,error:r,message:t}}}function y(e){const r=Date.now(),t=(A.get(e)||[]).filter(o=>r-o<b.rateLimiting.windowMs);if(t.length>=b.maxLoginAttempts)throw new Error("too-many-requests");t.push(r),A.set(e,t)}try{u=window.firebase,L=u.initializeApp(D),p=u.auth(),c=u.firestore(),j=u.storage(),c.enablePersistence({synchronizeTabs:!0}).catch(e=>s.warn("N├úo foi poss├¡vel habilitar persist├¬ncia:",e)),s.info("Firebase inicializado com sucesso")}catch(e){s.error("Erro cr├¡tico ao inicializar Firebase:",e),P("error","Erro cr├¡tico: N├úo foi poss├¡vel conectar ao servidor. Recarregue a p├ígina.",{persistent:!0})}const E=new u.auth.GoogleAuthProvider;E.addScope("profile");E.addScope("email");window.db=c;window.auth=p;const x=new Set(["auth/popup-blocked","auth/cancelled-popup-request"]);async function R(){try{return{user:(await p.signInWithPopup(E)).user,redirectTriggered:!1}}catch(e){if(x.has(e?.code))return s.warn("Popup do Google bloqueado. Alternando para redirect.",e),await p.signInWithRedirect(E),{user:null,redirectTriggered:!0};throw e}}async function v(e,{preserveRole:r=!1}={}){const a=c.collection("usuarios").doc(e.uid),o={nome:f.sanitizeInput(e.displayName||"Usuário",{maxLength:100}),email:e.email.toLowerCase(),photoURL:e.photoURL||null,ultimoLogin:u.firestore.Timestamp.now(),ativo:!0,versaoTermos:"1.0"};if(r){const i=await a.get();i.exists?(i.data()||{}).papel||(o.papel="jogador"):(o.dataIngresso=u.firestore.Timestamp.now(),o.papel="jogador")}else o.dataIngresso=u.firestore.Timestamp.now(),o.papel="jogador";await a.set(o,{merge:!0})}async function B(){try{y("google-login");const{user:e,redirectTriggered:r}=await R();if(r)return{success:!0,redirect:!0};if(!e.email||!f.isValidEmail(e.email))throw new Error("Email invalido recebido do Google");return await v(e),s.info("Login Google realizado com sucesso",{uid:e.uid,email:e.email}),{success:!0,user:e}}catch(e){return m.handleError(e,"login com Google")}}async function U(e,r,a){try{if(!f.isValidEmail(e))throw new Error("invalid-email");if(!f.isStrongPassword(r))throw new Error("weak-password");const t=f.sanitizeInput(a,{maxLength:100});if(!t||t.length<2)throw new Error("Nome deve ter pelo menos 2 caracteres");y(e.toLowerCase());const i=(await p.createUserWithEmailAndPassword(e.toLowerCase(),r)).user;return await i.updateProfile({displayName:t}),await c.collection("usuarios").doc(i.uid).set({nome:t,email:e.toLowerCase(),papel:"jogador",dataIngresso:u.firestore.Timestamp.now(),ultimoLogin:u.firestore.Timestamp.now(),ativo:!0,versaoTermos:"1.0",configuracoes:{notificacoes:!0,tema:"dark"}}),s.info("Registro realizado com sucesso",{uid:i.uid,email:i.email}),{success:!0,user:i}}catch(t){return m.handleError(t,"registro")}}async function V(e,r){try{if(!f.isValidEmail(e))throw new Error("invalid-email");if(!r||r.length<6)throw new Error("wrong-password");y(e.toLowerCase());const a=await p.signInWithEmailAndPassword(e.toLowerCase(),r);try{await c.collection("usuarios").doc(a.user.uid).update({ultimoLogin:u.firestore.Timestamp.now()})}catch(t){s.warn("N├úo foi poss├¡vel atualizar ├║ltimo login:",t)}return s.info("Login realizado com sucesso",{uid:a.user.uid,email:a.user.email}),{success:!0,user:a.user}}catch(a){return m.handleError(a,"login")}}async function q(e){try{if(!f.isValidEmail(e))throw new Error("invalid-email");const r=e.toLowerCase().trim();try{await p.sendPasswordResetEmail(r)}catch(a){if(a.code==="auth/user-not-found"){let t=[];try{t=await p.fetchSignInMethodsForEmail(r)}catch(o){s.warn("Não foi possível obter métodos de login:",o)}if(t.includes("google.com")&&!t.includes("password"))throw new Error("Esta conta usa apenas login com Google. Acesse com o Google ou defina uma senha nas configurações.")}throw a}try{await c.collection("password_reset_logs").add({email:r,requestedAt:u.firestore.FieldValue.serverTimestamp()})}catch(a){s.warn("Não foi possível registrar log de reset de senha:",a)}return{success:!0,message:"Enviamos um email com instruções para redefinir sua senha."}}catch(r){return m.handleError(r,"recuperação de senha")}}async function k(e,r){if(!e||!r){const a=new Error("userId e paisId s├úo obrigat├│rios");return m.handleError(a,"vincula├º├úo jogador-pa├¡s")}try{const a=await c.collection("paises").doc(r).get();if(!a.exists)throw new Error("Pa├¡s n├úo encontrado");if(a.data().Player)throw new Error("Pa├¡s j├í possui um jogador");return await c.runTransaction(async o=>{o.update(c.collection("paises").doc(r),{Player:e,DataVinculacao:u.firestore.Timestamp.now()}),o.set(c.collection("usuarios").doc(e),{paisId:r,papel:"jogador",ultimaAtualizacao:u.firestore.Timestamp.now(),ativo:!0},{merge:!0})}),d.clear(),s.info("Jogador vinculado ao pa├¡s com sucesso",{userId:e,paisId:r}),{success:!0}}catch(a){return m.handleError(a,"vincula├º├úo jogador-pa├¡s")}}async function T(e,r=!0){if(!e)return s.warn("checkUserPermissions: userId ├® obrigat├│rio"),{isNarrator:!1,isAdmin:!1,isPlayer:!0};const a=`permissions-${e}`;try{if(r){const i=d.get(a);if(i)return s.debug(`Permiss├Áes do usu├írio ${e} carregadas do cache`),i}const t=await c.collection("usuarios").doc(e).get();let o={isNarrator:!1,isAdmin:!1,isPlayer:!0,role:"jogador"};if(t.exists){const i=t.data(),n=i.papel||"jogador";o={isNarrator:n==="narrador"||n==="admin",isAdmin:n==="admin",isPlayer:n==="jogador"||n==="narrador"||n==="admin",role:n,ativo:i.ativo!==!1}}return d.set(a,o,6e5),s.debug(`Permiss├Áes verificadas para ${e}:`,o),o}catch(t){return s.error("Erro ao verificar permiss├Áes:",t),{isNarrator:!1,isAdmin:!1,isPlayer:!0,role:"jogador"}}}async function K(e,r=!0){if(!e)return s.warn("checkPlayerCountry: userId ├® obrigat├│rio"),null;const a=`player-country-${e}`;try{if(r){const i=d.get(a);if(i!==null)return s.debug(`Pa├¡s do jogador ${e} carregado do cache: ${i}`),i}const t=await c.collection("usuarios").doc(e).get();let o=null;return t.exists&&(o=t.data().paisId||null),d.set(a,o,3e5),s.debug(`Pa├¡s do jogador ${e}: ${o||"nenhum"}`),o}catch(t){return s.error("Erro ao verificar pa├¡s do jogador:",t),null}}async function O(e=!0){const r="available-countries";try{if(e){const i=d.get(r);if(i)return s.debug("Pa├¡ses dispon├¡veis carregados do cache"),i}const o=(await c.collection("paises").where("Player","in",[null,"",void 0]).get()).docs.map(i=>{const n=i.data();return{id:i.id,...n,Pais:f.sanitizeInput(n.Pais||"",{maxLength:100})}}).filter(i=>i.Pais&&i.PIB!==void 0);return d.set(r,o,18e4),s.info(`${o.length} pa├¡ses dispon├¡veis encontrados`),o}catch(a){return m.handleError(a,"busca de pa├¡ses dispon├¡veis"),[]}}async function W(e=!0){const r="all-countries";try{if(e){const n=d.get(r);if(n)return s.debug("Pa├¡ses carregados do cache"),n}const t=await c.collection("paises").get();if(t.empty)return s.warn("Nenhum pa├¡s encontrado na cole├º├úo"),[];const o=t.docs.map(n=>{const g=n.data(),l={id:n.id,...g,Pais:f.sanitizeInput(g.Pais||"",{maxLength:100}),PIB:Math.max(0,h.parseNumber(g.PIB)||0)};if(l.Carvao===void 0&&(l.Carvao=0),l.PotencialCarvao===void 0)switch(l.Pais){case"Alemanha":l.PotencialCarvao=10;break;case"Reino Unido":l.PotencialCarvao=9;break;case"Brasil":l.PotencialCarvao=4;break;default:l.PotencialCarvao=5}return l.power_plants===void 0&&(l.power_plants=[]),l.PotencialHidreletrico===void 0&&(l.PotencialHidreletrico=5),l}),i=[...new Set(o.filter(n=>n.Player).map(n=>n.Player))];if(i.length>0){const n=await I(i);o.forEach(g=>{if(g.Player&&n.has(g.Player)){const l=n.get(g.Player);g.PlayerName=l.nome||l.displayName||l.email?.split("@")[0]||g.Player,g.PlayerEmail=l.email||null}})}return d.set(r,o,3e5),s.info(`${o.length} pa├¡ses carregados com sucesso`),o}catch(a){return m.handleError(a,"carregamento de pa├¡ses"),[]}}async function J(e,r=!0){if(!e)return s.warn("getCountryData: paisId ├® obrigat├│rio"),null;const a=`country-${e}`;try{if(r){const n=d.get(a);if(n)return s.debug(`Dados do pa├¡s ${e} carregados do cache`),n}const t=await c.collection("paises").doc(e).get();if(!t.exists)return s.warn(`Pa├¡s ${e} n├úo encontrado`),null;const o=t.data(),i={...o,Pais:f.sanitizeInput(o.Pais||"",{maxLength:100}),PIB:Math.max(0,h.parseNumber(o.PIB)||0),Estabilidade:Math.max(0,Math.min(100,h.parseNumber(o.Estabilidade)||0)),Tecnologia:Math.max(0,h.parseNumber(o.Tecnologia)||0),Aeronautica:Math.max(0,h.parseNumber(o.Aeronautica)||0),Veiculos:Math.max(0,h.parseNumber(o.Veiculos)||0),Marinha:Math.max(0,h.parseNumber(o.Marinha)||0)};return d.set(a,i,18e4),s.debug(`Dados do pa├¡s ${e} carregados com sucesso`),i}catch(t){return m.handleError(t,`carregamento do pa├¡s ${e}`),null}}async function H(e=!0){const r="game-config";try{if(e){const o=d.get(r);if(o)return s.debug("Configura├º├úo do jogo carregada do cache"),o}const a=await c.collection("configuracoes").doc("jogo").get();let t=null;return a.exists&&(t=a.data(),t.turnoAtual!==void 0&&(t.turnoAtual=Math.max(0,parseInt(t.turnoAtual)||0))),d.set(r,t,12e4),s.debug("Configura├º├úo do jogo carregada:",t),t}catch(a){return s.error("Erro ao carregar configura├º├úo do jogo:",a),null}}async function I(e){const r=new Map,a=Array.from(new Set(e.filter(Boolean))),t=10;for(let o=0;o<a.length;o+=t){const i=a.slice(o,o+t);try{(await c.collection("usuarios").where(u.firestore.FieldPath.documentId(),"in",i).get()).forEach(g=>{r.set(g.id,g.data()||{})})}catch(n){s.warn("Falha ao carregar dados de jogadores para países:",n)}}return r}async function Q(){try{const e=await c.collection("configuracoes").doc("regrasDinamicas").get();return e.exists?(s.debug("Regras din├ómicas carregadas do Firestore"),e.data()):(s.debug("Nenhum documento de regras din├ómicas encontrado, usando objeto vazio."),{})}catch(e){return m.handleError(e,"carregamento de regras din├ómicas"),{}}}async function Y(e,r=null){try{if(typeof e!="object"||e===null)throw new Error("Objeto de regras inv├ílido.");if(r){const t=await T(r,!1);if(!t.isNarrator&&!t.isAdmin)throw new Error("Acesso negado: apenas narradores podem salvar regras.")}const a={...e,ultimaAtualizacao:u.firestore.Timestamp.now(),ultimoEditor:r||"desconhecido"};return await c.collection("configuracoes").doc("regrasDinamicas").set(a),d.clear(),s.info("Regras din├ómicas salvas com sucesso",{userId:r}),P("success","Conjunto de regras customizadas foi salvo!"),{success:!0}}catch(a){return m.handleError(a,"salvamento de regras din├ómicas")}}async function X(e,r=null){try{const a=parseInt(e);if(isNaN(a)||a<0)throw new Error("N├║mero do turno inv├ílido");if(r){const o=await T(r,!1);if(!o.isNarrator&&!o.isAdmin)throw new Error("Acesso negado: apenas narradores podem atualizar turnos")}const t={turnoAtual:a,ultimaAtualizacao:u.firestore.Timestamp.now()};r&&(t.ultimoEditor=r),await c.collection("configuracoes").doc("jogo").set(t,{merge:!0});try{const{default:o}=await N(async()=>{const{default:n}=await import("./turnProcessor-CJO0FaZ_.js");return{default:n}},__vite__mapDeps([0,1,2,3,4,5,6,7]));if(await o.isTurnProcessed(a))s.info(`Turno ${a} j├í foi processado anteriormente`);else{s.info(`Iniciando processamento autom├ítico do turno ${a}`);const n=await o.processTurnEnd(a);s.info(`Processamento do turno ${a} conclu├¡do`,n)}}catch(o){s.error("Erro no processamento autom├ítico do turno:",o),console.warn("ÔÜá´©Å Erro no processamento autom├ítico, mas turno foi atualizado")}return d.clear(),s.info(`Turno atualizado para #${a}`,{userId:r,newTurn:a}),{success:!0,turno:a}}catch(a){return m.handleError(a,"atualiza├º├úo de turno")}}async function Z(){try{y("google-login");const{user:e,redirectTriggered:r}=await R();if(r)return{success:!0,redirect:!0};if(!e.email||!f.isValidEmail(e.email))throw new Error("Email invalido recebido do Google");return await v(e,{preserveRole:!0}),s.info("Login Google (preservando papel) realizado com sucesso",{uid:e.uid,email:e.email}),{success:!0,user:e}}catch(e){return m.handleError(e,"login com Google (preservar papel)")}}async function ee(e=!1){try{const r=await p.getRedirectResult();if(r&&r.user){if(!r.user.email||!f.isValidEmail(r.user.email))throw new Error("Email invalido recebido do Google");return await v(r.user,{preserveRole:e}),s.info("Login Google via redirect concluido",{uid:r.user.uid,email:r.user.email}),{success:!0,user:r.user}}return{success:!1,user:null}}catch(r){return r?.code==="auth/no-auth-event"?{success:!1,user:null}:m.handleError(r,"login com Google (redirect)")}}async function re(e,r){if(!e||!r){const a=new Error("userId e paisId s├úo obrigat├│rios");return m.handleError(a,"vincula├º├úo jogador-pa├¡s (preservar papel)")}try{const a=await c.collection("paises").doc(r).get();if(!a.exists)throw new Error("Pa├¡s n├úo encontrado");if(a.data().Player)throw new Error("Pa├¡s j├í possui um jogador");return await c.runTransaction(async o=>{o.update(c.collection("paises").doc(r),{Player:e,DataVinculacao:u.firestore.Timestamp.now()}),o.set(c.collection("usuarios").doc(e),{paisId:r,ultimaAtualizacao:u.firestore.Timestamp.now(),ativo:!0},{merge:!0})}),d.clear(),s.info("Jogador vinculado ao pa├¡s (preservando papel) com sucesso",{userId:e,paisId:r}),{success:!0}}catch(a){return m.handleError(a,"vincula├º├úo jogador-pa├¡s (preservar papel)")}}export{L as app,p as auth,K as checkPlayerCountry,T as checkUserPermissions,c as db,W as getAllCountries,O as getAvailableCountries,J as getCountryData,Q as getCustomRules,H as getGameConfig,E as googleProvider,ee as handleGoogleRedirectResult,U as registerWithEmailPassword,q as requestPasswordReset,Y as saveCustomRules,V as signInWithEmailPassword,B as signInWithGoogle,Z as signInWithGooglePreserveRole,j as storage,X as updateTurn,k as vincularJogadorAoPais,re as vincularJogadorAoPaisSemRebaixar};
