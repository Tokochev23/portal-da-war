import{L as n,h as f}from"./firebase-DhoRyF0N.js";import{C as E}from"./consumerGoodsCalculator-BzhzLFUc.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js";import"https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js";class w{static async processTurnEnd(t){try{n.info(`Iniciando processamento autom√°tico do turno ${t}`),console.log(`üîÑ PROCESSAMENTO AUTOM√ÅTICO DO TURNO ${t}`);const o=Date.now();let e=0;const r=await f.collection("paises").get(),y=f.batch();return r.forEach(l=>{const s=l.data(),i=s.Pais||s.Nome||l.id;try{const a=E.applyStabilityEffect(s),c={...s,Estabilidade:a.newStability},p=E.calculateConsumerGoods(c),d={Estabilidade:a.newStability,BensDeConsumo:p.level,ProcessamentoTurno:{turno:t,timestamp:new Date().toISOString(),stabilityChange:a.stabilityEffect,previousStability:a.currentStability,newStability:a.newStability,consumerGoodsLevel:p.level}};y.update(l.ref,d),e++,Math.abs(a.stabilityEffect)>=2&&console.log(`${i}: Estabilidade ${a.currentStability}% ‚Üí ${a.newStability}% (${a.stabilityEffect>0?"+":""}${a.stabilityEffect}%)`)}catch(a){n.error(`Erro ao processar ${i} no turno ${t}:`,a)}}),e>0&&(await y.commit(),await this.saveTurnProcessingLog(t,e,o),n.info(`Turno ${t} processado: ${e} pa√≠ses atualizados`),console.log(`‚úÖ Turno ${t} processado: ${e} pa√≠ses atualizados em ${Date.now()-o}ms`)),{success:!0,processedCount:e,duration:Date.now()-o}}catch(o){throw n.error(`Erro no processamento do turno ${t}:`,o),console.error(`‚ùå Erro no processamento do turno ${t}:`,o),o}}static async saveTurnProcessingLog(t,o,e){try{const r={turno:t,timestamp:new Date().toISOString(),processedCount:o,duration:Date.now()-e,systems:["consumer_goods","stability_effects"],version:"1.0"};await f.collection("logs").doc(`turno_${t}_${Date.now()}`).set(r)}catch(r){n.error("Erro ao salvar log do processamento:",r)}}static async testTurnProcessing(t="TEST"){try{console.log(`üß™ TESTE DE PROCESSAMENTO DE TURNO ${t}`);const o=await f.collection("paises").get(),e=[];o.forEach(s=>{const i=s.data(),a=i.Pais||i.Nome||s.id;try{const c=E.applyStabilityEffect(i),p=E.calculateConsumerGoods(i);e.push({country:a,currentStability:c.currentStability,stabilityEffect:c.stabilityEffect,newStability:c.newStability,consumerGoodsLevel:p.level,effectDescription:c.effectDescription})}catch(c){console.error(`Erro no teste para ${a}:`,c)}});const r=e.filter(s=>Math.abs(s.stabilityEffect)>=2),y=e.filter(s=>s.stabilityEffect>0),l=e.filter(s=>s.stabilityEffect<0);return console.log(`
üìä RESUMO DO TESTE:`),console.log(`Total de pa√≠ses: ${e.length}`),console.log(`Mudan√ßas significativas (‚â•2%): ${r.length}`),console.log(`Efeitos positivos: ${y.length}`),console.log(`Efeitos negativos: ${l.length}`),r.length>0&&(console.log(`
‚ö° MUDAN√áAS SIGNIFICATIVAS:`),r.sort((s,i)=>Math.abs(i.stabilityEffect)-Math.abs(s.stabilityEffect)).slice(0,10).forEach(s=>{console.log(`${s.country}: ${s.currentStability}% ‚Üí ${s.newStability}% (${s.stabilityEffect>0?"+":""}${s.stabilityEffect}%)`)})),e}catch(o){throw console.error("Erro no teste de processamento:",o),o}}static async isTurnProcessed(t){try{return!(await f.collection("logs").where("turno","==",t).where("systems","array-contains","consumer_goods").limit(1).get()).empty}catch(o){return n.error("Erro ao verificar processamento do turno:",o),!1}}static async reprocessTurn(t){try{return console.log(`üîÑ Reprocessando turno ${t}...`),await this.isTurnProcessed(t)&&console.log(`‚ö†Ô∏è Turno ${t} j√° foi processado. For√ßando reprocessamento...`),await this.processTurnEnd(t)}catch(o){throw console.error(`Erro ao reprocessar turno ${t}:`,o),o}}}export{w as default};
