class n{constructor(){this.cache=new Map,this.loadingQueue=new Set,this.retryAttempts=3,this.retryDelay=1e3}async loadTemplate(e,r=!0){if(r&&this.cache.has(e))return this.cache.get(e);if(this.loadingQueue.has(e))return this.waitForTemplate(e);this.loadingQueue.add(e);try{const a=await(await this.fetchWithRetry(e)).text();return this.cache.set(e,a),this.loadingQueue.delete(e),a}catch(t){throw this.loadingQueue.delete(e),console.error(`Failed to load template: ${e}`,t),new Error(`Template loading failed: ${e}`)}}async fetchWithRetry(e,r=0){try{const t=await fetch(e);if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);return t}catch(t){if(r<this.retryAttempts-1)return await this.delay(this.retryDelay*(r+1)),this.fetchWithRetry(e,r+1);throw t}}async waitForTemplate(e){for(;this.loadingQueue.has(e);)await this.delay(50);return this.cache.get(e)}delay(e){return new Promise(r=>setTimeout(r,e))}preloadTemplates(e){return Promise.allSettled(e.map(r=>this.loadTemplate(r)))}clearCache(){this.cache.clear(),this.loadingQueue.clear()}getCacheSize(){return this.cache.size}}window.templateLoader=new n;class c{constructor(e){this.loader=e,this.injectionQueue=[],this.isProcessing=!1}async injectTemplate(e,r,t={}){return new Promise((a,o)=>{this.injectionQueue.push({containerId:e,templatePath:r,data:t,resolve:a,reject:o}),this.isProcessing||this.processQueue()})}async processQueue(){if(this.injectionQueue.length===0){this.isProcessing=!1;return}this.isProcessing=!0;const e=this.injectionQueue.shift();try{const r=await this.loader.loadTemplate(e.templatePath),t=this.processTemplate(r,e.data),a=document.getElementById(e.containerId);if(!a)throw new Error(`Container not found: ${e.containerId}`);a.innerHTML=t,e.resolve(t)}catch(r){console.error("Template injection failed:",r),e.reject(r)}setTimeout(()=>this.processQueue(),10)}processTemplate(e,r){let t=e;for(const[a,o]of Object.entries(r)){const i=new RegExp(`{{\\s*${a}\\s*}}`,"g");t=t.replace(i,String(o))}return t}async injectMultipleTemplates(e){const r=e.map(t=>this.injectTemplate(t.containerId,t.templatePath,t.data));return Promise.allSettled(r)}}window.templateInjector=new c(window.templateLoader);window.loadTemplate=async function(s,e,r={}){try{await window.templateInjector.injectTemplate(s,e,r)}catch(t){console.error(`Failed to load template into ${s}:`,t);const a=document.getElementById(s);a&&(a.innerHTML=`
                <div class="text-center py-8 text-red-400">
                    <div class="text-2xl mb-2">‚ö†Ô∏è</div>
                    <p>Erro ao carregar componente</p>
                    <p class="text-sm text-slate-500 mt-2">${t.message}</p>
                </div>
            `)}};class l{constructor(){this.criticalTemplates=["templates/aircraft-creator/airframes-tab.html","templates/aircraft-creator/engines-tab.html"],this.secondaryTemplates=["templates/aircraft-creator/weapons-tab.html","templates/aircraft-creator/wings-tab.html","templates/aircraft-creator/avionics-tab.html"],this.tertiaryTemplates=["templates/aircraft-creator/component-tabs.html"]}async loadCritical(){console.log("üöÄ Loading critical templates...");const e=await window.templateLoader.preloadTemplates(this.criticalTemplates),r=e.filter(t=>t.status==="rejected");return r.length>0&&console.warn("Some critical templates failed to load:",r),e}async loadSecondary(){return console.log("üì¶ Loading secondary templates..."),window.templateLoader.preloadTemplates(this.secondaryTemplates)}async loadTertiary(){return console.log("üîß Loading tertiary templates..."),window.templateLoader.preloadTemplates(this.tertiaryTemplates)}async loadAll(){try{await this.loadCritical(),setTimeout(()=>this.loadSecondary(),100),setTimeout(()=>this.loadTertiary(),500),console.log("‚úÖ Progressive loading initiated")}catch(e){console.error("‚ùå Progressive loading failed:",e)}}}window.progressiveLoader=new l;console.log("üìù Template Loader carregado!");
