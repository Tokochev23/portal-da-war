import{db as d}from"./firebase-BDV7finj.js";import{B as p}from"./shipyardSystem-B7HEfEsS.js";import"./utils-DLoRv3re.js";const h={limited:{name:"Limitada",icon:"ü•â",minBudgetPercent:.5,maxBudgetPercent:2,power:"fraca",description:"Opera√ß√µes b√°sicas limitadas",modifier:-1},competent:{name:"Competente",icon:"ü•à",minBudgetPercent:2,maxBudgetPercent:5,power:"m√©dia",description:"Boas capacidades operacionais",modifier:0},powerful:{name:"Poderosa",icon:"ü•á",minBudgetPercent:5,maxBudgetPercent:10,power:"forte",description:"Opera√ß√µes complexas e eficazes",modifier:1},elite:{name:"Elite",icon:"üíé",minBudgetPercent:10,maxBudgetPercent:15,power:"muito forte",description:"Dom√≠nio total em intelig√™ncia",modifier:2}},v={external_espionage:{name:"Espionagem Externa",icon:"üïµÔ∏è",description:"HUMINT/SIGINT contra outros pa√≠ses",bonuses:{espionageSuccess:10,infiltrationSpeed:15}},counterintelligence:{name:"Contra-Espionagem",icon:"üõ°Ô∏è",description:"Seguran√ßa nacional e anti-espionagem",bonuses:{detection:20,investigation:15}},covert_operations:{name:"Opera√ß√µes Encobertas",icon:"üé≠",description:"Sabotagem, influ√™ncia e subvers√£o",bonuses:{sabotageSuccess:15,psychologicalWarfare:20}}};class B{constructor(){this.agencies=new Map,this.lastUpdate=null}calculateCostByPIB(e,t){const a=parseFloat(t.PIB)||0,o=parseFloat(t.Populacao)||1,r=a/o,i=a/1e9,n=Math.max(.5,Math.min(3,Math.log10(i+1)*.8+.5));let s=1;r<2e3?s=.8:r>2e4&&(s=1.3);const c=n*s;return Math.round(e*c)}calculateBudget(e){const t=parseFloat(e.PIB)||0,a=(parseFloat(e.Burocracia)||0)/100,o=(parseFloat(e.Estabilidade)||0)/100;return t*.25*a*o*1.5}determineTier(e){return e>=h.elite.minBudgetPercent?"elite":e>=h.powerful.minBudgetPercent?"powerful":e>=h.competent.minBudgetPercent?"competent":"limited"}calculateFoundationCost(e){return this.calculateCostByPIB(15e8,e)}async hasAgency(e){try{const t=await d.collection("agencies").where("countryId","==",e).get();if(!t.empty){const a=t.docs[0].data();return a.id=t.docs[0].id,a}return null}catch(t){return console.error("Erro ao verificar ag√™ncia:",t),null}}async foundAgency(e,t,a,o,r){try{if(await this.hasAgency(e.id))return{success:!1,error:"Este pa√≠s j√° possui uma ag√™ncia de intelig√™ncia!"};const n=Math.max(.5,Math.min(15,parseFloat(a))),s=this.calculateFoundationCost(e),c=this.calculateBudget(e);if(c<s)return{success:!1,error:"Or√ßamento nacional insuficiente para fundar ag√™ncia!"};const g=this.determineTier(n),u=h[g],m=Math.round(c*(n/100)),f={countryId:e.id,countryName:e.Pais,name:t||`Ag√™ncia de ${e.Pais}`,foundedTurn:r,budgetPercent:n,budget:m,tier:g,tierName:u.name,focus:o,focusName:v[o].name,technologies:[],currentResearch:null,operations:[],operatives:0,foundationCost:s,createdAt:new Date().toISOString()},E=await d.collection("agencies").add(f),P=parseFloat(e.OrcamentoGasto||0),l=s+m;await d.collection("paises").doc(e.id).update({hasAgency:!0,agencyId:E.id});try{await p.addExpense(e.id,p.EXPENSE_CATEGORIES.AGENCY_BUDGET,s,`Funda√ß√£o da ag√™ncia: ${t}`),await p.addExpense(e.id,p.EXPENSE_CATEGORIES.AGENCY_BUDGET,m,`Or√ßamento anual da ag√™ncia: ${t} (${n}% do or√ßamento nacional)`),console.log(`üí∞ Budget atualizado: -$${(l/1e6).toFixed(2)}M (Funda√ß√£o + Or√ßamento Anual)`)}catch(I){console.error("‚ö†Ô∏è Erro ao atualizar budget tracker (ag√™ncia j√° foi criada):",I)}return{success:!0,agency:{...f,id:E.id},cost:s,annualBudget:m,totalSpent:l,tier:u}}catch(i){return console.error("Erro ao fundar ag√™ncia:",i),{success:!1,error:"Erro ao processar funda√ß√£o: "+i.message}}}async updateAgencyBudget(e,t,a){try{const o=Math.max(.5,Math.min(15,parseFloat(t))),r=this.calculateBudget(a),i=Math.round(r*(o/100)),n=this.determineTier(o),c=(await d.collection("agencies").doc(e).get()).data(),g=c.budget||0;await d.collection("agencies").doc(e).update({budgetPercent:o,budget:i,tier:n,tierName:h[n].name});try{const u=i-g;u>0?await p.addExpense(a.id,p.EXPENSE_CATEGORIES.AGENCY_BUDGET,u,`Aumento do or√ßamento da ag√™ncia ${c.name} (${o}%)`):u<0&&await p.addIncome(a.id,p.INCOME_CATEGORIES.OTHER_INCOME,Math.abs(u),`Redu√ß√£o do or√ßamento da ag√™ncia ${c.name} (${o}%)`)}catch(u){console.error("‚ö†Ô∏è Erro ao atualizar budget tracker:",u)}return{success:!0,newBudget:i,newTier:n,budgetUpdated:!0}}catch(o){return console.error("Erro ao atualizar or√ßamento da ag√™ncia:",o),{success:!1,error:o.message}}}async getAgency(e){try{const t=await d.collection("agencies").where("countryId","==",e).get();if(!t.empty){const a=t.docs[0].data();return a.id=t.docs[0].id,a}return null}catch(t){return console.error("Erro ao buscar ag√™ncia:",t),null}}async dissolveAgency(e,t){try{return await d.collection("agencies").doc(e).delete(),await d.collection("paises").doc(t).update({hasAgency:!1,agencyId:null}),{success:!0}}catch(a){return console.error("Erro ao dissolver ag√™ncia:",a),{success:!1,error:a.message}}}getTiers(){return h}getFocuses(){return v}}const R=new B,b={1:{name:"Estabelecer Presen√ßa",icon:"üö∂",duration:[2,4],activities:["Enviar operativos","Criar identidades de cobertura","Estabelecer safe houses","Mapear territ√≥rio"],intelUnlocked:0,risks:["Operativos capturados","Identidades expostas"],description:"Primeiros passos em territ√≥rio inimigo"},2:{name:"Recrutar Rede Local",icon:"üë•",duration:[2,6],activities:["Identificar alvos para recrutamento","Aproximar e recrutar","Construir rede de informantes","Estabelecer comunica√ß√µes seguras"],intelUnlocked:10,risks:["Informantes capturados","Rede comprometida"],description:"Construir base de opera√ß√µes local"},3:{name:"Penetra√ß√£o",icon:"üéØ",duration:[3,8],activities:["Infiltrar instala√ß√µes-chave","Plantar dispositivos","Subornar oficiais","Acessar documentos classificados"],intelUnlocked:40,risks:["Contra-espionagem ativa","Dispositivos descobertos"],description:"Acesso a informa√ß√µes sens√≠veis"},4:{name:"Opera√ß√µes Completas",icon:"‚ö°",duration:"ongoing",activities:["Acesso total a informa√ß√µes","Capacidade de sabotagem","Influenciar decis√µes","Opera√ß√µes encobertas"],intelUnlocked:100,risks:["Detec√ß√£o constante","Guerra de contra-espionagem"],description:"Dom√≠nio completo de intelig√™ncia"}},O={0:{label:"P√∫blico",info:["PIB","Popula√ß√£o","Modelo Pol√≠tico","WPI","Estabilidade (geral)","Urbaniza√ß√£o","Tecnologia (%)"]},10:{label:"Presen√ßa Estabelecida",info:["Or√ßamento Nacional aproximado","Recursos principais","Principais cidades"]},40:{label:"Rede Infiltrada",info:["Or√ßamento detalhado","Distribui√ß√£o militar","Tecnologias espec√≠ficas","Capacidade de produ√ß√£o"]},70:{label:"Penetra√ß√£o Profunda",info:["Invent√°rio militar parcial","Planos de produ√ß√£o","Bens de consumo","Recursos detalhados"]},100:{label:"Dom√≠nio Total",info:["Invent√°rio completo","Ordens de batalha","Inten√ß√µes diplom√°ticas","Projetos secretos","Ag√™ncia inimiga (se houver)"]}},M={CLEAN_FAIL:{name:"Falha Limpa",exposed:!1,detailsRevealed:0,severity:"low"},MINOR_EXPOSURE:{name:"Exposi√ß√£o Menor",exposed:!0,detailsRevealed:20,severity:"medium"},MAJOR_EXPOSURE:{name:"Exposi√ß√£o Grave",exposed:!0,detailsRevealed:60,severity:"high"},TOTAL_COMPROMISE:{name:"Comprometimento Total",exposed:!0,detailsRevealed:100,operativesCaptured:!0,severity:"critical"}};class y{constructor(){this.operations=new Map}calculateOperationCost(e,t){const r=.5+(parseFloat(e.WarPower)||50)/100;return Math.round(25e3*t*r)}calculatePhaseSuccessChance(e,t,a,o){let r=.6;r-=(e-1)*.1,r+={limited:-.1,competent:0,powerful:.1,elite:.2}[t.tier]||0;const n=(parseFloat(o.TecnologiaCivil)||parseFloat(o.Tecnologia)||0)/100;r+=n*.15;const s=(parseFloat(a.CounterIntelligence)||0)/100;r-=s*2.5;const c=(parseFloat(a.Urbanizacao)||0)/100;return r-=c*.08,t.technologies&&(t.technologies.includes("tradecraft_basic")&&(r+=.1),t.technologies.includes("recruitment_native")&&(r+=.15),e>=3&&t.technologies.includes("surveillance_electronic")&&(r+=.1)),Math.max(.05,Math.min(.95,r))}calculateDetectionChance(e,t){const a=(parseFloat(t.CounterIntelligence)||0)/100;let o=e*.05;return o+=a*4,Math.min(.9,o)}async hasActiveOperation(e,t){try{const a=await d.collection("espionage_operations").where("spyCountryId","==",e).where("targetCountryId","==",t).where("active","==",!0).get();if(!a.empty){const o=a.docs[0].data();return o.id=a.docs[0].id,o}return null}catch(a){return console.error("Erro ao verificar opera√ß√£o:",a),null}}async initiateOperation(e,t,a,o,r){try{if(await this.hasActiveOperation(e.countryId,t.id))return{success:!1,error:"Voc√™ j√° tem uma opera√ß√£o ativa neste pa√≠s!"};const n=this.calculateOperationCost(t,o);if(e.budget<n)return{success:!1,error:"Or√ßamento da ag√™ncia insuficiente!"};const s={agencyId:e.id,spyCountryId:e.countryId,spyCountryName:e.countryName,targetCountryId:t.id,targetCountryName:t.Pais,phase:1,progress:0,startedTurn:r,lastProgressTurn:r,plannedDuration:o,operativesDeployed:Math.floor(3+Math.random()*5),coverIdentities:this.generateCoverIdentities(),detected:!1,detectedTurn:null,active:!0,intelLevel:0,createdAt:new Date().toISOString()},c=await d.collection("espionage_operations").add(s);return{success:!0,operation:{...s,id:c.id},cost:n}}catch(i){return console.error("Erro ao iniciar opera√ß√£o:",i),{success:!1,error:"Erro ao processar opera√ß√£o: "+i.message}}}generateCoverIdentities(){const e=["Comerciante","Jornalista","Diplomata","Professor","Engenheiro","M√©dico","Empres√°rio","Turista","Estudante","Artista","Pesquisador","Consultor"],t=Math.floor(2+Math.random()*3),a=[];for(let o=0;o<t;o++){const r=e[Math.floor(Math.random()*e.length)];a.includes(r)||a.push(r)}return a}async progressOperation(e,t,a,o,r){try{const i=await d.collection("espionage_operations").doc(e).get();if(!i.exists)return{success:!1,error:"Opera√ß√£o n√£o encontrada!"};const n=i.data();if(n.lastProgressTurn===r)return{success:!1,error:"Opera√ß√£o j√° progrediu neste turno!"};const s=n.phase,c=b[s],g=this.calculatePhaseSuccessChance(s,t,a,o),m=Math.random()<=g,f=this.calculateDetectionChance(s,a),P=Math.random()<=f;let l={lastProgressTurn:r};if(m){const I=100/(c.duration[1]||4),C=Math.min(100,n.progress+I);l.progress=C,C>=100&&(s<4?(l.phase=s+1,l.progress=0,l.intelLevel=b[s+1].intelUnlocked):l.intelLevel=100)}return P&&!n.detected&&(l.detected=!0,l.detectedTurn=r),await d.collection("espionage_operations").doc(e).update(l),{success:!0,succeeded:m,detected:P,newPhase:l.phase||s,newProgress:l.progress||n.progress,intelLevel:l.intelLevel||n.intelLevel,successChance:Math.round(g*100),detectionChance:Math.round(f*100)}}catch(i){return console.error("Erro ao progredir opera√ß√£o:",i),{success:!1,error:i.message}}}async getAgencyOperations(e){try{return(await d.collection("espionage_operations").where("agencyId","==",e).where("active","==",!0).get()).docs.map(a=>({id:a.id,...a.data()}))}catch(t){return console.error("Erro ao buscar opera√ß√µes:",t),[]}}async terminateOperation(e){try{return await d.collection("espionage_operations").doc(e).update({active:!1,terminatedAt:new Date().toISOString()}),{success:!0}}catch(t){return console.error("Erro ao encerrar opera√ß√£o:",t),{success:!1,error:t.message}}}getPhases(){return b}getIntelLayers(){return O}getFailureTypes(){return M}}const x=new y;export{h as A,b as I,x as e,R as i};
