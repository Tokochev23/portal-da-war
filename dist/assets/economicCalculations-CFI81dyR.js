import{L as m,o as $}from"./firebase-BARDcBiw.js";function v(r,t){const e=parseFloat(r)||0,a=parseFloat(t)||0;return e*a}function R(r,t){const e=parseFloat(r)||0,a=parseFloat(t)||0;return a===0?0:e/a}function L(r,t){const e=parseFloat(r)||0,a=parseFloat(t)||0;return e*(1+a)}function O(r){const t=parseFloat(r.Populacao)||0,e=parseFloat(r.PIBPerCapita)||0,a=v(t,e),o=(parseFloat(r.Burocracia)||0)/100,i=(parseFloat(r.Estabilidade)||0)/100;return a*.25*o*i*1.5}function k(r){return r>=1e12?`$${(r/1e12).toFixed(1)}T`:r>=1e9?`$${(r/1e9).toFixed(1)}bi`:r>=1e6?`$${(r/1e6).toFixed(1)}M`:r>=1e3?`$${(r/1e3).toFixed(1)}k`:`$${r.toLocaleString()}`}function q(r){return r>=1e3?`$${r.toLocaleString()}`:`$${r.toFixed(0)}`}const A={THERMAL_COAL:{id:"THERMAL_COAL",name:"Termelétrica a Carvão",type:"thermal",resource_input:"Carvao",resource_consumption:10,energy_output:50,cost:500,tech_requirement:20,pollution:.1,description:"Baixo requisito tecnológico, converte Carvão em Energia Elétrica. Gera poluição."},THERMAL_FUEL:{id:"THERMAL_FUEL",name:"Termelétrica a Combustível",type:"thermal",resource_input:"Combustivel",resource_consumption:8,energy_output:60,cost:700,tech_requirement:30,pollution:.08,description:"Mais eficiente que a carvão, converte Combustível em Energia Elétrica. Gera poluição."},HYDROELECTRIC:{id:"HYDROELECTRIC",name:"Hidrelétrica",type:"hydro",resource_input:null,resource_consumption:0,energy_output:80,cost:1500,tech_requirement:40,potential_requirement:"PotencialHidreletrico",pollution:.01,description:"Requer potencial geográfico. Custo de construção alto, mas geração de energia barata e constante."},NUCLEAR:{id:"NUCLEAR",name:"Usina Nuclear",type:"nuclear",resource_input:"Uranio",resource_consumption:1,energy_output:200,cost:5e3,tech_requirement:70,pollution:.005,description:"Requer altíssima tecnologia e Urânio. Geração massiva de energia."}};class P{constructor(t){this.scope=t}evaluate(t){t=t.replace(/\s+/g,"");for(const[e,a]of Object.entries(this.scope)){const o=new RegExp(`\\b${e}\\b`,"g");t=t.replace(o,String(parseFloat(a)||0))}if(!/^[0-9+\-*/.()%\s]+$/.test(t))throw new Error("Expressão contém caracteres não permitidos");try{return new Function(`return ${t}`)()}catch(e){throw new Error(`Erro ao avaliar expressão: ${e.message}`)}}parse(t){return{evaluate:e=>new P(e).evaluate(t)}}}const U={parse:r=>new P({}).parse(r)};function W(r){const t={};if(!r||typeof r!="object")return t;for(const e in r){const a=r[e];if(typeof a=="object"&&a!==null&&!Array.isArray(a))for(const o in a)o in t||(t[o]=a[o]);else t[e]=a}return t}function y(r,t){if(!r||typeof r!="string")return{success:!1,value:0,error:"Fórmula inválida ou não fornecida."};const e=W(t);try{const o=U.parse(r).evaluate(e);if(typeof o!="number"||!isFinite(o))throw new Error("O resultado da fórmula não é um número válido.");return{success:!0,value:o,error:null}}catch(a){return m.error(`Erro ao avaliar a fórmula "${r}":`,a),{success:!1,value:0,error:a.message}}}const p={diceBase:{successThreshold:5},inflation:{external:{impact_5_percent:.2,impact_20_percent:.4,impact_40_percent:.4,economic_ratio_5x:.15,economic_ratio_10x:.25},internal:{concentration_80:.15},resistance:{technology_70:.25,stability_75:.2,superpower:.3,max_resistance:.6}}};class V{static calculateBaseGrowth(t,e,a={}){const{dice:o,type:i,value:s,buff:c=0}=t;let l=0;o>p.diceBase.successThreshold?l=(o-p.diceBase.successThreshold)/12:o<=3?l=-.02:l=.02;let n;const u=a?.modificadorCrescimento;if(u){const h=y(u,e);if(h.success)n=h.value,m.info(`Modificador de Crescimento calculado com fórmula customizada: ${u}`);else{m.error(`Falha na fórmula de Modificador de Crescimento "${u}". Usando cálculo padrão. Erro: ${h.error}`);const g=(parseFloat(e.Tecnologia)||0)/100,E=(parseFloat(e.Urbanizacao)||0)/100;n=1+g*E*1.5}}else{const h=(parseFloat(e.Tecnologia)||0)/100,g=(parseFloat(e.Urbanizacao)||0)/100;n=1+h*g*1.5}const d=parseFloat(e.Estabilidade)||0;let f=1;d<30?f=.6:d<50?f=.8:d>80&&(f=1.2);const b=this.getActionTypeConfig(i);let F=b.multiplier;F=this.applyTypeSpecificModifiers(F,b,e);const I=1+c/100,C=l*n*f*F*I;return{baseGrowth:l,countryModifier:n,stabilityModifier:f,typeMultiplier:F,buffModifier:I,preInflationGrowth:C,value:parseFloat(s)||0}}static getActionTypeConfig(t){return{infrastructure:{multiplier:1.3,bonusCondition:"urbanization",bonusThreshold:50,bonusValue:.4},research:{multiplier:1.8,bonusCondition:"technology",bonusThreshold:60,bonusValue:.5},industry:{multiplier:1.6,pibBonus:.5,penaltyCondition:"stability",penaltyThreshold:40,penaltyValue:.15},social:{multiplier:1.1,stabilityBonus:1}}[t]||{multiplier:1.2}}static applyTypeSpecificModifiers(t,e,a){let o=t;return e.bonusCondition&&this.getCountryStatValue(a,e.bonusCondition)>e.bonusThreshold&&(o*=1+e.bonusValue),e.penaltyCondition&&this.getCountryStatValue(a,e.penaltyCondition)<e.penaltyThreshold&&(o*=1-e.penaltyValue),e.pibBonus&&(o*=1+e.pibBonus),o}static getCountryStatValue(t,e){return{technology:parseFloat(t.Tecnologia)||0,urbanization:parseFloat(t.Urbanizacao)||0,stability:parseFloat(t.Estabilidade)||0,pib:parseFloat(t.PIB)||0}[e]||0}static calculateProductiveChains(t,e){const a=[...new Set(t.map(i=>i.type))],o=[];return a.includes("infrastructure")&&a.includes("industry")&&(o.push({name:"Infraestrutura + Indústria",bonus:.35,affectedType:"industry",description:"Infraestrutura potencializa desenvolvimento industrial"}),(parseFloat(e.Estabilidade)||0)<50&&o.push({name:"Infraestrutura + Indústria (Estabilidade)",bonus:.3,affectedType:"industry",description:"Infraestrutura elimina penalidade de estabilidade baixa"})),a.includes("research")&&a.includes("industry")&&o.push({name:"P&D + Indústria",bonus:.25,affectedType:"industry",description:"Inovação acelera crescimento industrial",techBonus:1}),a.includes("research")&&a.includes("social")&&o.push({name:"P&D + Social",bonus:.35,affectedType:"social",description:"Pesquisa melhora eficiência de políticas sociais",techBonus:1}),o}static calculateInflation(t,e,a={},o={}){let i=0;const s=t.filter(l=>l.isExternal);for(const l of s){const n=a[l.targetCountry];n&&(i+=this.calculateExternalInflation(l,e,n))}i+=this.calculateDistributionInflation(t,e,o);const c=this.calculateInflationResistance(e);return i=Math.max(0,i-c),Math.min(i,.85)}static calculateExternalInflation(t,e,a){let o=0;const i=parseFloat(t.value)||0,s=parseFloat(a.PIB)||1,c=i/s;c>.05&&(o+=p.inflation.external.impact_5_percent),c>.2&&(o+=p.inflation.external.impact_20_percent),c>.4&&(o+=p.inflation.external.impact_40_percent);const n=(parseFloat(e.PIB)||1)/s;return n>5&&(o+=p.inflation.external.economic_ratio_5x),n>10&&(o+=p.inflation.external.economic_ratio_10x),o}static calculateDistributionInflation(t,e,a={}){let o=0;if(t.length===0)return 0;const i={};t.forEach(c=>{const l=parseFloat(c.value)||0;i[c.type]||(i[c.type]=0),i[c.type]+=l*1e6});const s=this.calculateBudget(e,a);for(const[c,l]of Object.entries(i))l/s>.8&&(o+=p.inflation.internal.concentration_80);return o}static calculateInflationResistance(t){let e=.15;const a=parseFloat(t.Tecnologia)||0,o=parseFloat(t.Estabilidade)||0,i=parseFloat(t.PIB)||0;return a>50&&(e+=.15),a>70&&(e+=p.inflation.resistance.technology_70),o>50&&(e+=.1),o>75&&(e+=p.inflation.resistance.stability_75),i>5e10&&(e+=.1),i>2e11&&(e+=.15),i>5e11&&(e+=p.inflation.resistance.superpower),Math.min(e,p.inflation.resistance.max_resistance)}static calculateBudget(t,e={}){const a=e?.orcamento;if(a){const c=y(a,t);if(c.success)return m.info(`Orçamento calculado com fórmula customizada: ${a}`),c.value;m.error(`Falha na fórmula de orçamento customizada "${a}". Usando cálculo padrão. Erro: ${c.error}`)}const o=parseFloat(t.PIB)||0,i=(parseFloat(t.Burocracia)||0)/100,s=(parseFloat(t.Estabilidade)||0)/100;return o*.25*i*s*1.5}static async processAllActions(t,e,a={}){const o=await $(),i={actions:[],totalGrowth:0,totalInflation:0,finalGrowth:0,newPIB:0,productiveChains:[],stabilityChanges:0,technologyChanges:0};t.forEach(n=>{const u=this.calculateBaseGrowth(n,e,o);i.actions.push({...n,...u})});const s=this.calculateProductiveChains(t,e);i.productiveChains=s,s.forEach(n=>{i.actions.forEach(u=>{u.type===n.affectedType&&(u.preInflationGrowth*=1+n.bonus,u.chainBonus=n.bonus)}),n.techBonus&&(i.technologyChanges+=n.techBonus)});const c=parseFloat(e.PIBPerCapita)||R(parseFloat(e.PIB)||0,parseFloat(e.Populacao)||1),l=parseFloat(e.Populacao)||1;return i.totalGrowth=i.actions.reduce((n,u)=>{const d=u.preInflationGrowth*(u.value*1e6)/(c*l);return n+d},0),i.totalInflation=this.calculateInflation(t,e,a,o),i.finalGrowth=i.totalGrowth*(1-i.totalInflation),i.newPIBPerCapita=L(c,i.finalGrowth),i.newPIB=v(l,i.newPIBPerCapita),i.stabilityChanges=t.filter(n=>n.type==="social"&&n.dice>p.diceBase.successThreshold).length,i}static calculateEconomicDependency(t,e,a){if(!e||e.length<3)return 0;const o=e.slice(-5);let i=0,s=0;return o.forEach(c=>{c.externalInvestments&&Object.entries(c.externalInvestments).forEach(([l,n])=>{i+=n,l===a&&(s+=n)})}),i===0?0:s/i}static computeIndustryResourceConsumption(t,e){return(parseFloat(t)||0)*.2}static computeEnergyPenalty(t,e){if(t>=e)return 1;const a=(e-t)/Math.max(e,1);return Math.max(0,1-a*.6)}static computeConsumerGoodsIndex(t,e={}){const a=parseFloat(e.Graos||t.Graos||0),o=parseFloat(e.Combustivel||t.Combustivel||0),i=parseFloat(e.EnergiaDisponivel||t.EnergiaDisponivel||t.EnergiaCapacidade||0),s=parseFloat(t.IndustrialEfficiency)||50,c=Math.min(1,a/100),l=Math.min(1,(o+i)/100),n=Math.min(1,s/100),u=(c*.4+l*.3+n*.3)*100;return Math.round(u)}static computeConsumerGoodsIndexV2(t,e={}){try{const a=parseFloat(e.Graos||t.Graos||0),o=parseFloat(e.Combustivel||t.Combustivel||0),i=parseFloat(e.EnergiaDisponivel||t.EnergiaDisponivel||t.EnergiaCapacidade||0),s=parseFloat(t.IndustrialEfficiency)||50,c=parseFloat(t.PIB)||0,l=parseFloat(t.Populacao)||1,n=l>0?c/l:0,u=parseFloat(t.Estabilidade)||50,d=parseFloat(t.Urbanizacao)||50,f=150,b=250,F=1e4,I=Math.min(1,a/f),C=Math.min(1,(o+i)/b),h=Math.min(1,s/100),g=Math.min(1,n/F),E=Math.min(1,u/100),x=.25,B=.2,w=.25,T=.2,M=.1,_=1+(d/100-.5)*.1,G=(x*I+B*C+w*h+T*g+M*E)*_;return{index:Math.round(Math.max(0,Math.min(1,G))*100),breakdown:{g:Number((I*100).toFixed(1)),f:Number((C*100).toFixed(1)),i:Number((h*100).toFixed(1)),p:Number((g*100).toFixed(1)),s:Number((E*100).toFixed(1))},urbanFactor:Number(_.toFixed(3))}}catch(a){return m.error("computeConsumerGoodsIndexV2 failed:",a),{index:0,breakdown:{g:0,f:0,i:0,p:0,s:0},urbanFactor:1}}}static computeEnergyDemandGW(t){try{const e=parseFloat(t.PIB)||0,a=parseFloat(t.Populacao)||1,o=a>0?e/a:0,i=500,s=o/1e3*50,c=(parseFloat(t.Urbanizacao)||0)/100,l=1+Math.min(.4,c*.4),n=(parseFloat(t.IndustrialEfficiency)||50)/100,u=1-Math.min(.25,n*.25),d=Math.max(0,(i+s)*l*u),f=d*a/1e6,b=f/8760;return{demandaGW:Number(b.toFixed(3)),perCapitaKWh:Number(d.toFixed(1)),totalGWh:Number(f.toFixed(2))}}catch(e){return m.error("computeEnergyDemandGW failed:",e),{demandaGW:0,perCapitaKWh:0,totalGWh:0}}}static calculateEnergyProduction(t,e){let a=0;const o={Carvao:0,Combustivel:0,Uranio:0};if(!t.power_plants||t.power_plants.length===0)return{totalProduction:a,consumedResources:o};for(const i of t.power_plants){const s=A[i.id];if(!s){m.warn(`Tipo de usina desconhecido: ${i.id}`);continue}let c=!0;if(s.resource_input){const l=s.resource_input,n=s.resource_consumption;e[l]<n?(c=!1,m.info(`Usina ${s.name} não pode produzir por falta de ${l}.`)):o[l]+=n}s.type==="hydro"&&t.PotencialHidreletrico<=0&&(c=!1,m.info(`Usina ${s.name} não pode produzir por falta de potencial hidrelétrico.`)),c&&(a+=s.energy_output)}return{totalProduction:a,consumedResources:o}}static checkRejectionRisk(t,e,a){const o=parseFloat(t.Estabilidade)||0,i=parseFloat(t.PIB)||1,s=e/i;return o<40&&s>.1?{hasRisk:!0,riskLevel:s>.2?"high":"medium",stabilityPenalty:Math.min(s*10,3)}:{hasRisk:!1}}static checkDonorStabilityPenalty(t,e,a){const o=parseFloat(t.Estabilidade)||0,i=e/a;return o<40&&i>.2?Math.min(i*5,2):0}}export{V as E,A as P,q as a,v as b,O as c,k as f};
