<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‚öì Criador de Navios Avan√ßado ‚Ä¢ WAR Era 1954</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 16 16%22%3E%3Crect width=%2216%22 height=%2216%22 rx=%223%22 fill=%22%23004d8c%22/%3E%3Ctext x=%228%22 y=%2211%22 font-size=%2210%22 text-anchor=%22middle%22 fill=%22%23ffffff%22%3E‚öì%3C/text%3E%3C/svg%3E" />

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- html2canvas for screenshot capture -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            bg: {
              DEFAULT: "#0b1020",
              soft: "#10172a",
              ring: "#1e293b"
            },
            naval: {
              50:"#e6f3ff",100:"#cce7ff",200:"#99cfff",300:"#66b7ff",400:"#339fff",
              500:"#0087ff",600:"#006dcc",700:"#005399",800:"#003966",900:"#001f33"
            },
            brand: {
              50:"#fff7e6",100:"#ffefcc",200:"#ffe099",300:"#ffd166",400:"#ffc233",
              500:"#ffb400",600:"#e09f00",700:"#b37d00",800:"#805900",900:"#4d3600"
            }
          }
        }
      }
    }
  </script>

  <!-- Inter Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Stardos+Stencil:wght@700&display=swap" rel="stylesheet">
  
  <!-- Chart.js for performance graphs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- CSS Refatorado -->
  
  <script type="module" crossorigin src="/portal-da-war/assets/criador-navios-npRkdv4e.js"></script>
  <link rel="modulepreload" crossorigin href="/portal-da-war/assets/preload-helper-f85Crcwt.js">
  <link rel="modulepreload" crossorigin href="/portal-da-war/assets/hulls-CFhq2zY8.js">
  <link rel="modulepreload" crossorigin href="/portal-da-war/assets/propulsion-Ds8gNL2e.js">
  <link rel="modulepreload" crossorigin href="/portal-da-war/assets/naval_guns-RPDYGynX.js">
  <link rel="modulepreload" crossorigin href="/portal-da-war/assets/naval_missiles-1gme3iwB.js">
  <link rel="modulepreload" crossorigin href="/portal-da-war/assets/secondary_weapons-B2--kRuu.js">
  <link rel="modulepreload" crossorigin href="/portal-da-war/assets/electronics-CC3zpcSk.js">
  <link rel="modulepreload" crossorigin href="/portal-da-war/assets/armor-DmFYxSll.js">
  <link rel="stylesheet" crossorigin href="/portal-da-war/assets/criador-navios-DYfnxx-y.css">
  <link rel="stylesheet" crossorigin href="/portal-da-war/assets/vehicle-creator-enhanced-F6ob6G-p.css">
</head>

<body class="gradient-bg min-h-screen">
  <!-- Loading Screen -->
  <div id="initial-loading" class="fixed inset-0 bg-bg z-50 flex items-center justify-center">
    <div class="text-center">
      <div class="animate-spin w-12 h-12 border-4 border-naval-500 border-t-transparent rounded-full mx-auto mb-4"></div>
      <p class="text-slate-200 font-medium">Iniciando Criador de Navios...</p>
      <p class="text-slate-400 text-sm mt-2" id="loading-status">Carregando componentes navais...</p>
    </div>
  </div>

  <!-- HEADER -->
  <header class="border-b border-slate-800/50 bg-bg/80 backdrop-blur-sm sticky top-0 z-40">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
      <div class="flex h-16 items-center justify-between">
        <div class="flex items-center space-x-4">
          <div class="flex items-center space-x-2">
            <span class="text-3xl">‚öì</span>
            <div>
              <h1 class="text-lg font-bold text-slate-100">Criador de Navios</h1>
              <p class="text-xs text-slate-400">Sistema Naval Avan√ßado WAR Era 1954</p>
            </div>
          </div>
        </div>

        <div class="flex items-center space-x-4">
          <div class="flex items-center space-x-2 text-sm">
            <span class="text-slate-400">Pa√≠s:</span>
            <span id="current-country" class="font-medium text-naval-300">Carregando...</span>
          </div>
          
          <button onclick="showShipSummaryModal()" class="flex items-center space-x-2 rounded-lg bg-naval-600 px-4 py-2 text-sm font-medium text-white transition-all hover:bg-naval-700 focus:outline-none focus:ring-2 focus:ring-naval-500 focus:ring-offset-2 focus:ring-offset-bg">
            <span>‚öì</span>
            <span>Ficha do Navio</span>
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- MAIN CONTENT -->
  <main class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-8">
    
    <!-- PROJECT INFO SECTION -->
    <div class="bg-slate-800/40 border border-slate-700/50 rounded-xl p-6 mb-8">
      <div class="flex items-start justify-between">
        <div class="flex items-center space-x-3">
          <span class="text-4xl">üö¢</span>
          <div>
            <h2 class="text-xl font-bold text-slate-100">Projeto Naval</h2>
            <p class="text-slate-400 text-sm mt-1">Configure cada componente para criar seu navio de guerra ideal</p>
          </div>
        </div>
        
        <div class="text-right">
          <div class="text-lg font-bold text-naval-300" id="ship-name-display">Novo Navio</div>
          <div class="text-sm text-slate-400 mt-1">
            <span id="ship-class-display">Classe n√£o definida</span> ‚Ä¢ 
            <span id="ship-year-display">1954</span>
          </div>
        </div>
      </div>
      
      <!-- Quick stats row -->
      <div class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-4 pt-4 border-t border-slate-700/30">
        <div class="text-center">
          <div class="text-xl font-bold text-slate-100" id="total-displacement-display">0 t</div>
          <div class="text-xs text-slate-400">Deslocamento</div>
        </div>
        <div class="text-center">
          <div class="text-xl font-bold text-naval-300" id="max-speed-display">0 n√≥s</div>
          <div class="text-xs text-slate-400">Velocidade M√°x</div>
        </div>
        <div class="text-center">
          <div class="text-xl font-bold text-sky-300" id="main-armament-display">0 canh√µes</div>
          <div class="text-xs text-slate-400">Artilharia Principal</div>
        </div>
        <div class="text-center">
          <div class="text-xl font-bold text-blue-300" id="total-cost-display">$0M</div>
          <div class="text-xs text-slate-400">Custo Total</div>
        </div>
      </div>
    </div>

    <!-- COMPONENT TABS -->
    <div class="bg-slate-800/40 border border-slate-700/50 rounded-xl overflow-hidden mb-8">
      <nav class="flex border-b border-slate-700/50">
        <button class="tab-button flex-1 px-6 py-4 text-sm font-medium border-b-2 transition-all hover:text-naval-300 hover:bg-slate-800/50" data-tab="hull">
          <div class="flex items-center justify-center space-x-2">
            <span>üö¢</span>
            <span>Casco</span>
          </div>
        </button>
        <button class="tab-button flex-1 px-6 py-4 text-sm font-medium border-b-2 transition-all hover:text-naval-300 hover:bg-slate-800/50" data-tab="propulsion">
          <div class="flex items-center justify-center space-x-2">
            <span>‚öôÔ∏è</span>
            <span>Propuls√£o</span>
          </div>
        </button>
        <button class="tab-button flex-1 px-6 py-4 text-sm font-medium border-b-2 transition-all hover:text-naval-300 hover:bg-slate-800/50" data-tab="armor">
          <div class="flex items-center justify-center space-x-2">
            <span>üõ°Ô∏è</span>
            <span>Blindagem</span>
          </div>
        </button>
        <button class="tab-button flex-1 px-6 py-4 text-sm font-medium border-b-2 transition-all hover:text-naval-300 hover:bg-slate-800/50" data-tab="main_guns">
          <div class="flex items-center justify-center space-x-2">
            <span>üéØ</span>
            <span>Artilharia</span>
          </div>
        </button>
        <button class="tab-button flex-1 px-6 py-4 text-sm font-medium border-b-2 transition-all hover:text-naval-300 hover:bg-slate-800/50" data-tab="secondary">
          <div class="flex items-center justify-center space-x-2">
            <span>üöÄ</span>
            <span>Secund√°rio</span>
          </div>
        </button>
        <button class="tab-button flex-1 px-6 py-4 text-sm font-medium border-b-2 transition-all hover:text-naval-300 hover:bg-slate-800/50" data-tab="electronics">
          <div class="flex items-center justify-center space-x-2">
            <span>üì°</span>
            <span>Eletr√¥nicos</span>
          </div>
        </button>
      </nav>

      <div id="tab-content" class="p-6 min-h-[500px]">
        <!-- Dynamic content will be loaded here -->
        <div class="text-center text-slate-400 py-16">
          <span class="text-4xl">‚öì</span>
          <p class="mt-4">Selecione uma aba para come√ßar a configurar seu navio</p>
        </div>
      </div>
    </div>

    <!-- WARNINGS SECTION -->
    <div id="warnings-container" class="hidden">
      <div class="bg-amber-900/20 border border-amber-800/50 rounded-xl p-6 mb-8">
        <div class="flex items-start space-x-3">
          <span class="text-2xl">‚ö†Ô∏è</span>
          <div>
            <h3 class="text-lg font-semibold text-amber-300 mb-2">Avisos de Design</h3>
            <div id="warnings-list">
              <!-- Warnings will be populated by JavaScript -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ANALYSIS SECTION -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
      <!-- Performance Chart -->
      <div class="bg-slate-800/40 border border-slate-700/50 rounded-xl p-6">
        <h3 class="text-lg font-semibold text-slate-100 mb-4 flex items-center space-x-2">
          <span>üìä</span>
          <span>Performance Naval</span>
        </h3>
        <div class="relative">
          <canvas id="performance-radar" width="300" height="300"></canvas>
        </div>
      </div>

      <!-- Detailed Analysis -->
      <div class="space-y-6">
        <!-- Combat Performance -->
        <div class="bg-slate-800/40 border border-slate-700/50 rounded-xl p-6">
          <h3 class="text-lg font-semibold text-slate-100 mb-4 flex items-center space-x-2">
            <span>‚öîÔ∏è</span>
            <span>Performance de Combate</span>
          </h3>
          <div id="combat-performance-analysis">
            <!-- Combat performance details will be populated by JavaScript -->
          </div>
        </div>

        <!-- Cost Breakdown -->
        <div class="bg-slate-800/40 border border-slate-700/50 rounded-xl p-6">
          <h3 class="text-lg font-semibold text-slate-100 mb-4 flex items-center space-x-2">
            <span>üí∞</span>
            <span>An√°lise de Custos</span>
          </h3>
          <div id="cost-breakdown">
            <!-- Cost details will be populated by JavaScript -->
          </div>
        </div>
      </div>
    </div>

    <!-- ACTION BUTTONS -->
    <div class="flex flex-col sm:flex-row items-center justify-between gap-4 bg-slate-800/40 border border-slate-700/50 rounded-xl p-6">
      <div class="flex items-center space-x-4 text-sm text-slate-400">
        <span class="flex items-center space-x-2">
          <span class="w-2 h-2 bg-naval-500 rounded-full"></span>
          <span>Sistema de Design Naval</span>
        </span>
        <span>‚Ä¢</span>
        <span>WAR Era 1954</span>
      </div>
      
      <div class="flex items-center space-x-3">
        <button onclick="resetShip()" class="px-4 py-2 bg-slate-600 hover:bg-slate-500 text-white rounded-lg font-medium transition-colors flex items-center space-x-2">
          <span>üîÑ</span>
          <span>Resetar</span>
        </button>
        
        <button onclick="saveShipDesign()" class="px-4 py-2 bg-sky-600 hover:bg-sky-700 text-white rounded-lg font-medium transition-colors flex items-center space-x-2">
          <span>üíæ</span>
          <span>Salvar Design</span>
        </button>
        
        <button onclick="showShipSummaryModal()" class="px-6 py-2 bg-gradient-to-r from-naval-600 to-blue-600 hover:from-naval-700 hover:to-blue-700 text-white rounded-lg font-medium transition-all duration-200 flex items-center space-x-2 shadow-lg hover:shadow-naval-500/25">
          <span>‚öì</span>
          <span>Ver Ficha Completa</span>
        </button>
        
        <button onclick="submitNavalProductionOrder()" class="px-6 py-2 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white rounded-lg font-medium transition-all duration-200 flex items-center space-x-2 shadow-lg hover:shadow-green-500/25">
          <span>üè≠</span>
          <span>Solicitar Produ√ß√£o</span>
        </button>
      </div>
    </div>

  </main>


  
  <script>
    // Sistema de inicializa√ß√£o para navios
    class NavalCreatorApp {
      constructor() {
        this.currentTab = 'hull';
        this.performanceChart = null;
        this.isInitialized = false;
        this.loadingElement = document.getElementById('initial-loading');
        this.statusElement = document.getElementById('loading-status');
      }

      updateLoadingStatus(message) {
        if (this.statusElement) {
          this.statusElement.textContent = message;
        }
      }

      async initialize() {
        try {
          this.updateLoadingStatus('Iniciando sistema naval...');
          
          // Carregar templates primeiro
          this.updateLoadingStatus('Carregando templates...');
          if (window.progressiveLoader) {
            await window.progressiveLoader.loadAll();
          }
          
          // Carregar componentes navais
          this.updateLoadingStatus('Carregando componentes navais...');
          if (window.loadNavalComponents) {
            const componentsLoaded = await window.loadNavalComponents();
            if (!componentsLoaded) {
              throw new Error('Falha ao carregar componentes navais');
            }
          } else {
            console.warn('‚ö†Ô∏è loadNavalComponents function not found - using fallback');
            // Fallback: aguardar um pouco para os scripts carregarem
            await new Promise(resolve => setTimeout(resolve, 1000));
            if (!window.NAVAL_COMPONENTS || Object.keys(window.NAVAL_COMPONENTS.hulls || {}).length === 0) {
              throw new Error('Componentes navais n√£o foram carregados');
            }
          }
          
          this.updateLoadingStatus('Inicializando interface...');
          this.initializeInterface();
          this.setupTabNavigation();
          this.setupPerformanceChart();
          
          // Carregar a primeira aba (cascos)
          this.updateLoadingStatus('Carregando cascos...');
          this.loadTabContent('hull');
          
          // Initial calculations update to show displays (even with zero values)
          setTimeout(() => {
            if (typeof window.updateShipCalculations === 'function') {
              window.updateShipCalculations();
            }
          }, 200);
          
          setTimeout(() => this.hideLoadingScreen(), 500);
          
        } catch (error) {
          console.error('‚ùå Initialization failed:', error);
          this.showInitializationError(error);
        }
      }

      hideLoadingScreen() {
        if (this.loadingElement) {
          this.loadingElement.style.opacity = '0';
          setTimeout(() => {
            this.loadingElement.style.display = 'none';
          }, 300);
        }
        this.isInitialized = true;
        console.log('‚úÖ Naval Creator fully initialized');
      }

      showInitializationError(error) {
        console.error('‚ùå Erro de inicializa√ß√£o:', error);
        if (this.statusElement) {
          this.statusElement.innerHTML = `
            <div class="text-red-400 text-center">
              <div class="text-lg font-semibold mb-2">‚ùå Erro de Inicializa√ß√£o</div>
              <div class="text-sm">${error.message}</div>
              <button onclick="window.location.reload()" class="mt-4 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                Recarregar P√°gina
              </button>
            </div>
          `;
        }
      }

      initializeInterface() {
        const country = localStorage.getItem('loggedCountry') || 'Desconhecido';
        const countryElement = document.getElementById('current-country');
        if (countryElement) {
          countryElement.textContent = country;
        }
        
        // Initialize currentShip object
        if (!window.currentShip) {
          window.currentShip = {
            name: 'Novo Navio',
            hull: null,
            propulsion: null,
            armor: {},
            main_guns: [],
            secondary_weapons: [],
            electronics: [],
            quantity: 1
          };
        }
        
        this.setActiveTab('hull');
      }

      setupTabNavigation() {
        const tabButtons = document.querySelectorAll('.tab-button');
        tabButtons.forEach(button => {
          button.addEventListener('click', () => {
            const tabId = button.dataset.tab;
            this.setActiveTab(tabId);
            this.loadTabContent(tabId);
          });
        });
      }

      setActiveTab(tabId) {
        this.currentTab = tabId;
        document.querySelectorAll('.tab-button').forEach(btn => {
          btn.classList.remove('border-naval-500', 'text-naval-300');
          btn.classList.add('border-transparent', 'text-slate-400');
        });
        const activeBtn = document.querySelector(`[data-tab="${tabId}"]`);
        if(activeBtn) {
          activeBtn.classList.add('border-naval-500', 'text-naval-300');
          activeBtn.classList.remove('border-transparent', 'text-slate-400');
        }
      }

      loadTabContent(tabId) {
        const tabContent = document.getElementById('tab-content');
        if (!tabContent) return;
        
        tabContent.innerHTML = '<div class="text-center py-8"><div class="animate-spin w-6 h-6 border-2 border-naval-500 border-t-transparent rounded-full mx-auto"></div></div>';
        
        setTimeout(() => {
          switch(tabId) {
            case 'hull': this.loadHullTab(); break;
            case 'propulsion': this.loadPropulsionTab(); break;
            case 'armor': this.loadArmorTab(); break;
            case 'main_guns': this.loadMainGunsTab(); break;
            case 'secondary': this.loadSecondaryTab(); break;
            case 'electronics': this.loadElectronicsTab(); break;
          }
        }, 200);
      }

      loadHullTab() {
        if (window.navalTabLoaders) window.navalTabLoaders.loadHullTab();
      }

      loadPropulsionTab() {
        if (window.navalTabLoaders) window.navalTabLoaders.loadPropulsionTab();
      }

      loadArmorTab() {
        if (window.navalTabLoaders) window.navalTabLoaders.loadArmorTab();
      }

      loadMainGunsTab() {
        if (window.navalTabLoaders) window.navalTabLoaders.loadMainGunsTab();
      }

      loadSecondaryTab() {
        if (window.navalTabLoaders) window.navalTabLoaders.loadSecondaryTab();
      }

      loadElectronicsTab() {
        if (window.navalTabLoaders) window.navalTabLoaders.loadElectronicsTab();
      }

      setupPerformanceChart() {
        const chartElement = document.getElementById('performance-radar');
        if (!chartElement) {
          console.warn('Performance chart element not found, skipping chart setup');
          return;
        }

        // Destroy existing chart if it exists
        if (this.performanceChart) {
          this.performanceChart.destroy();
          this.performanceChart = null;
        }

        const ctx = chartElement.getContext('2d');
        this.performanceChart = new Chart(ctx, {
          type: 'radar',
          data: {
            labels: ['Velocidade', 'Armamento', 'Blindagem', 'Autonomia', 'Detec√ß√£o', 'Manobrabilidade'],
            datasets: [{
              label: 'Performance',
              data: [0, 0, 0, 0, 0, 0],
              backgroundColor: 'rgba(0, 135, 255, 0.2)',
              borderColor: 'rgba(0, 135, 255, 0.8)',
              pointBackgroundColor: 'rgba(0, 135, 255, 1)',
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: { 
              r: { 
                min: 0, 
                max: 100, 
                ticks: { display: false }, 
                grid: { color: 'rgba(255, 255, 255, 0.1)' }, 
                pointLabels: { color: 'rgba(255, 255, 255, 0.7)', font: { size: 11 } } 
              } 
            },
            plugins: { legend: { display: false } }
          }
        });
      }
    }

    // Inicializa√ß√£o global
    window.navalCreatorApp = new NavalCreatorApp();

    // Fun√ß√µes globais para sele√ß√£o de componentes
    window.selectHull = function(hullId) {
      if (!window.NAVAL_COMPONENTS?.hulls[hullId]) {
        console.error('Hull not found:', hullId);
        return;
      }
      
      window.currentShip.hull = hullId;
      console.log('Selected hull:', hullId);

      // Update visual selection
      document.querySelectorAll('.hull-card').forEach(card => {
        card.classList.remove('selected', 'border-naval-400', 'ring-1', 'ring-naval-400/50');
        card.classList.add('border-slate-700/50', 'bg-slate-800/40');
      });
      
      const selectedCard = document.querySelector(`[onclick="selectHull('${hullId}')"]`);
      if (selectedCard) {
        selectedCard.classList.add('selected', 'border-naval-400', 'ring-1', 'ring-naval-400/50');
        selectedCard.classList.remove('border-slate-700/50', 'bg-slate-800/40');
      }
      
      updateShipCalculations();
    };

    window.updateShipCalculations = function() {
      console.log('üîÑ Updating ship calculations...');
      
      if (!window.currentShip?.hull) {
        console.log('‚ö†Ô∏è No hull selected - showing zero values');
        // Show zero values in displays
        updateShipDisplays({ totalDisplacement: 0, maxSpeed: 0, mainArmament: 0 });
        updateCostDisplays({ totalCost: 0 });
        return;
      }
      
      try {
        if (window.calculateShipPerformance) {
          const performance = window.calculateShipPerformance(window.currentShip);
          console.log('Performance calculated:', performance);
          
          // Update displays
          updateShipDisplays(performance);
        }
        
        if (window.NavalCostSystem) {
          const costs = window.NavalCostSystem.calculateCosts(window.currentShip);
          console.log('Costs calculated:', costs);
          
          // Update cost displays
          updateCostDisplays(costs);
        }
        
        console.log('‚úÖ Ship calculations updated successfully');
      } catch (error) {
        console.error('‚ùå Error updating ship calculations:', error);
      }
    };

    function updateShipDisplays(performance) {
      // Update header displays
      const displacementEl = document.getElementById('total-displacement-display');
      const speedEl = document.getElementById('max-speed-display');
      const armamentEl = document.getElementById('main-armament-display');
      
      if (displacementEl && performance.totalDisplacement) {
        displacementEl.textContent = Math.round(performance.totalDisplacement) + ' t';
      }
      if (speedEl && performance.maxSpeed) {
        speedEl.textContent = Math.round(performance.maxSpeed) + ' n√≥s';
      }
      if (armamentEl && performance.mainArmament) {
        armamentEl.textContent = performance.mainArmament + ' canh√µes';
      }
      
      // Update detailed performance section
      const performanceSection = document.getElementById('combat-performance-analysis');
      if (performanceSection && window.NavalPerformanceSystem) {
        performanceSection.innerHTML = window.NavalPerformanceSystem.renderPerformanceDisplay(window.currentShip);
      }
    }

    function updateCostDisplays(costs) {
      const costEl = document.getElementById('total-cost-display');
      if (costEl && costs.totalCost) {
        costEl.textContent = '$' + Math.round(costs.totalCost / 1000000) + 'M';
      }
      
      // Update detailed cost breakdown section
      const costSection = document.getElementById('cost-breakdown');
      if (costSection && window.NavalCostSystem) {
        costSection.innerHTML = window.NavalCostSystem.renderCostDisplay(window.currentShip);
      }
    }

    // Fun√ß√µes auxiliares
    window.resetShip = function() {
      window.currentShip = {
        name: 'Novo Navio',
        hull: null,
        propulsion: null,
        armor: {},
        main_guns: [],
        secondary_weapons: [],
        electronics: [],
        quantity: 1
      };
      
      // Refresh current tab
      window.navalCreatorApp.loadTabContent(window.navalCreatorApp.currentTab);
      updateShipCalculations();
    };

    window.saveShipDesign = function() {
      console.log('Saving ship design:', window.currentShip);
      if (window.navalCreator && typeof window.navalCreator.saveDesignToStorage === 'function') {
        const designName = prompt('Nome do design:', window.currentShip.name) || window.currentShip.name;
        window.navalCreator.saveDesignToStorage(designName);
        alert(`Design "${designName}" salvo com sucesso!`);
      } else {
        alert('Sistema de salvamento n√£o dispon√≠vel');
      }
    };

    // Modal da ficha naval - implementa√ß√£o simples diretamente aqui
    window.showShipSummaryModal = function() {
      console.log('üö¢ Mostrando modal da ficha naval');
      
      if (!window.currentShip?.hull) {
        alert('Selecione um casco primeiro!');
        return;
      }

      const ship = window.currentShip;
      const hull = window.NAVAL_COMPONENTS?.hulls[ship.hull];
      
      if (!hull) {
        alert('Dados do casco n√£o encontrados!');
        return;
      }

      // Remove modal existente
      const existingModal = document.getElementById('ship-summary-modal');
      if (existingModal) existingModal.remove();

      // Cria o modal
      const modal = document.createElement('div');
      modal.id = 'ship-summary-modal';
      modal.className = 'fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4';
      modal.style.zIndex = '9999';

      // Calcula dados b√°sicos
      let performance = { totalDisplacement: hull.displacement || 0, maxSpeed: hull.max_speed || 0, mainArmament: ship.main_guns?.length || 0 };
      let costs = { production: hull.cost_base || 50000000 };
      
      if (window.navalCreator) {
        try {
          performance = window.navalCreator.calculateShipPerformance(ship) || performance;
          costs = window.navalCreator.calculateShipCosts(ship) || costs;
        } catch (e) {
          console.warn('Erro ao calcular performance/custos:', e);
        }
      }

      modal.innerHTML = `
        <div class="bg-slate-800 border border-slate-600 rounded-2xl max-w-4xl max-h-[90vh] overflow-y-auto p-6" onclick="event.stopPropagation()">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-slate-100 flex items-center space-x-2">
              <span>‚öì</span>
              <span>Ficha T√©cnica Naval</span>
            </h2>
            <button onclick="closeShipSummaryModal()" class="text-slate-400 hover:text-slate-200 text-2xl">&times;</button>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Informa√ß√µes B√°sicas -->
            <div class="bg-slate-900/50 rounded-lg p-4">
              <h3 class="text-lg font-semibold text-naval-300 mb-3">üìã Informa√ß√µes B√°sicas</h3>
              <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                  <span class="text-slate-400">Nome:</span>
                  <span class="text-slate-100 font-semibold">${ship.name}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-slate-400">Classe:</span>
                  <span class="text-slate-100">${hull.name}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-slate-400">Tipo:</span>
                  <span class="text-slate-100">${hull.role || 'Naval'}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-slate-400">Ano:</span>
                  <span class="text-slate-100">1954</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-slate-400">Pa√≠s:</span>
                  <span class="text-slate-100">${localStorage.getItem('loggedCountry') || 'Desconhecido'}</span>
                </div>
              </div>
            </div>

            <!-- Performance -->
            <div class="bg-slate-900/50 rounded-lg p-4">
              <h3 class="text-lg font-semibold text-blue-300 mb-3">üìä Performance Naval</h3>
              <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                  <span class="text-slate-400">Deslocamento:</span>
                  <span class="text-blue-300 font-semibold">${Math.round(performance.totalDisplacement || 0).toLocaleString()} t</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-slate-400">Velocidade M√°xima:</span>
                  <span class="text-blue-300 font-semibold">${Math.round(performance.maxSpeed || 0)} n√≥s</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-slate-400">Alcance:</span>
                  <span class="text-blue-300">${hull.range || 'N/A'} nm</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-slate-400">Tripula√ß√£o:</span>
                  <span class="text-blue-300">${hull.crew || 'N/A'}</span>
                </div>
              </div>
            </div>

            <!-- Armamento -->
            <div class="bg-slate-900/50 rounded-lg p-4">
              <h3 class="text-lg font-semibold text-red-300 mb-3">‚öîÔ∏è Sistema de Armamento</h3>
              <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                  <span class="text-slate-400">Artilharia Principal:</span>
                  <span class="text-red-300 font-semibold">${ship.main_guns?.length || 0} canh√µes</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-slate-400">M√≠sseis:</span>
                  <span class="text-red-300">${ship.missiles?.length || 0}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-slate-400">Defesa AA:</span>
                  <span class="text-red-300">${ship.aa_guns?.length || 0}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-slate-400">Torpedos:</span>
                  <span class="text-red-300">${ship.torpedo_tubes?.length || 0}</span>
                </div>
              </div>
            </div>

            <!-- Custos -->
            <div class="bg-slate-900/50 rounded-lg p-4">
              <h3 class="text-lg font-semibold text-green-300 mb-3">üí∞ An√°lise Financeira</h3>
              <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                  <span class="text-slate-400">Custo de Produ√ß√£o:</span>
                  <span class="text-green-300 font-semibold">$${(costs.production || hull.cost_base || 50000000).toLocaleString()}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-slate-400">Tempo de Constru√ß√£o:</span>
                  <span class="text-green-300">${hull.production?.build_time_months || 24} meses</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-slate-400">M√£o de obra:</span>
                  <span class="text-green-300">${(hull.production?.workers_required || 1000).toLocaleString()} trabalhadores</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-slate-400">Materiais (a√ßo):</span>
                  <span class="text-green-300">${(hull.production?.materials_steel_tons || 500).toLocaleString()} t</span>
                </div>
              </div>
            </div>
          </div>

          <div class="mt-6 flex justify-end space-x-3">
            <button onclick="exportNavalDesign()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
              üìÑ Exportar
            </button>
            <button onclick="closeShipSummaryModal()" class="px-4 py-2 bg-slate-600 hover:bg-slate-500 text-white rounded-lg transition-colors">
              Fechar
            </button>
          </div>
        </div>
      `;

      // Adiciona event listener para fechar clicando fora
      modal.addEventListener('click', (e) => {
        if (e.target === modal) closeShipSummaryModal();
      });

      document.body.appendChild(modal);
      console.log('‚úÖ Modal da ficha naval criado');
    };

    window.closeShipSummaryModal = function() {
      const modal = document.getElementById('ship-summary-modal');
      if (modal) {
        modal.remove();
        console.log('‚úÖ Modal da ficha naval fechado');
      }
    };

    window.exportNavalDesign = function() {
      if (window.navalCreator && typeof window.navalCreator.exportShipDesign === 'function') {
        const design = window.navalCreator.exportShipDesign();
        const blob = new Blob([design], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${window.currentShip.name.replace(/[^a-z0-9]/gi, '_')}_naval_design.json`;
        a.click();
        URL.revokeObjectURL(url);
      } else {
        alert('Sistema de exporta√ß√£o n√£o dispon√≠vel');
      }
    };

    // Fun√ß√£o para solicitar produ√ß√£o naval
    window.submitNavalProductionOrder = async function() {
      try {
        if (!window.currentShip?.hull) {
          alert('Selecione um casco antes de solicitar produ√ß√£o!');
          return;
        }

        console.log('üè≠ Iniciando solicita√ß√£o de produ√ß√£o naval...');
        const ship = window.currentShip;
        const hull = window.NAVAL_COMPONENTS?.hulls[ship.hull];

        if (!hull) {
          alert('Dados do casco n√£o encontrados!');
          return;
        }

        // Mostrar modal de confirma√ß√£o com quantidade
        const quantity = prompt('Quantos navios deseja produzir?', '1');
        if (!quantity || isNaN(quantity) || parseInt(quantity) < 1 || parseInt(quantity) > 50) {
          alert('Quantidade inv√°lida (1-50)');
          return;
        }

        const qty = parseInt(quantity);
        
        // Calcular performance e custos b√°sicos
        let performance = { 
          totalDisplacement: hull.displacement || 0, 
          maxSpeed: hull.max_speed || 0, 
          mainArmament: ship.main_guns?.length || 0 
        };
        let costs = { production: hull.cost_base || 50000000 };
        
        if (window.navalCreator) {
          try {
            performance = window.navalCreator.calculateShipPerformance(ship) || performance;
            costs = window.navalCreator.calculateShipCosts(ship) || costs;
          } catch (e) {
            console.warn('Usando custos padr√£o:', e);
          }
        }

        const orderData = {
          design: { ...ship },
          performance: performance,
          costs: costs,
          quantity: qty,
          totalCost: (costs.production || hull.cost_base || 50000000) * qty
        };

        console.log('üìã Dados da ordem:', orderData);

        // Mostrar ficha para captura
        showShipSummaryModal();

        // Aguardar modal renderizar
        setTimeout(async () => {
          try {
            console.log('üì∏ Tentando capturar ficha naval...');
            const sheetResult = await captureAndUploadNavalSheet(orderData);
            
            if (sheetResult.pngUrl || sheetResult.htmlUrl) {
              orderData.sheetImageUrl = sheetResult.pngUrl;
              orderData.sheetHtmlUrl = sheetResult.htmlUrl;
              console.log('‚úÖ Ficha capturada com sucesso');
            } else {
              console.warn('‚ö†Ô∏è Ficha n√£o capturada, continuando sem imagem');
            }

          } catch (captureError) {
            console.warn('‚ö†Ô∏è Erro na captura:', captureError);
          }

          try {
            // Submeter ordem
            console.log('üì§ Enviando ordem para aprova√ß√£o...');
            const result = await submitOrderToFirebase(orderData);
            
            if (result.success) {
              closeShipSummaryModal();
              
              const estimatedTurns = Math.ceil((hull.production?.build_time_months || 24) / 3);
              alert(`‚úÖ Solicita√ß√£o enviada com sucesso!\n\nID: ${result.id.substring(0, 8)}\nQuantidade: ${qty}x ${ship.name}\nTempo estimado: ${estimatedTurns} turnos`);
            }
          } catch (submitError) {
            console.error('‚ùå Erro ao submeter ordem:', submitError);
            alert('Erro ao enviar solicita√ß√£o: ' + submitError.message);
          }
        }, 1000);

      } catch (error) {
        console.error('‚ùå Erro geral:', error);
        alert('Erro ao solicitar produ√ß√£o: ' + error.message);
      }
    };

    // Fun√ß√£o para capturar e fazer upload da ficha naval
    async function captureAndUploadNavalSheet(orderData) {
      try {
        console.log('üñºÔ∏è Iniciando captura da ficha naval...');
        
        const sheetElement = document.querySelector('#ship-summary-modal .bg-slate-800');
        if (!sheetElement) {
          throw new Error('Elemento da ficha n√£o encontrado');
        }

        console.log('üì¶ html2canvas dispon√≠vel:', typeof html2canvas !== 'undefined');
        if (typeof html2canvas === 'undefined') {
          console.warn('html2canvas n√£o dispon√≠vel, usando HTML apenas');
          return { pngUrl: null, htmlUrl: await uploadHtmlSheet(orderData) };
        }

        // Capturar com html2canvas
        const canvas = await html2canvas(sheetElement, {
          backgroundColor: '#1e293b',
          width: 1200,
          height: Math.max(sheetElement.scrollHeight, 800),
          scale: 2,
          useCORS: true,
          logging: false
        });

        console.log('‚úÖ Canvas capturado:', canvas.width + 'x' + canvas.height);

        // Converter para blob
        const blob = await new Promise(resolve => {
          canvas.toBlob(resolve, 'image/png', 0.9);
        });

        if (!blob) {
          throw new Error('Falha ao criar blob da imagem');
        }

        // Upload para Firebase Storage (se dispon√≠vel)
        let pngUrl = null;
        if (window.firebase?.storage) {
          try {
            pngUrl = await uploadImageToStorage(blob, orderData);
            console.log('‚úÖ PNG enviado para Storage');
          } catch (uploadError) {
            console.warn('‚ö†Ô∏è Erro no upload PNG:', uploadError);
          }
        }

        // HTML de backup
        const htmlUrl = await uploadHtmlSheet(orderData);

        return { pngUrl, htmlUrl };

      } catch (error) {
        console.error('‚ùå Erro na captura:', error);
        return { pngUrl: null, htmlUrl: await uploadHtmlSheet(orderData) };
      }
    }

    async function uploadImageToStorage(blob, orderData) {
      const storage = window.firebase.storage();
      const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
      const filename = `naval-sheets/${orderData.design.name}_${timestamp}.png`;
      
      const storageRef = storage.ref().child(filename);
      const snapshot = await storageRef.put(blob);
      const downloadURL = await snapshot.ref.getDownloadURL();
      
      return downloadURL;
    }

    async function uploadHtmlSheet(orderData) {
      try {
        const htmlContent = generateNavalSheetHTML(orderData);
        const blob = new Blob([htmlContent], { type: 'text/html' });
        
        if (!window.firebase?.storage) {
          console.warn('Firebase Storage n√£o dispon√≠vel para HTML');
          return null;
        }
        
        const storage = window.firebase.storage();
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
        const filename = `naval-sheets/${orderData.design.name}_${timestamp}.html`;
        
        const storageRef = storage.ref().child(filename);
        const snapshot = await storageRef.put(blob);
        const downloadURL = await snapshot.ref.getDownloadURL();
        
        return downloadURL;
      } catch (error) {
        console.error('‚ùå Erro no upload HTML:', error);
        return null;
      }
    }

    function generateNavalSheetHTML(orderData) {
      const { design, performance, costs } = orderData;
      const hull = window.NAVAL_COMPONENTS?.hulls[design.hull];
      
      return `<!DOCTYPE html>
<html><head><title>Ficha Naval - ${design.name}</title><meta charset="utf-8">
<style>body{font-family:Arial,sans-serif;background:#1e293b;color:#e2e8f0;padding:20px}
.container{max-width:800px;margin:0 auto}.section{background:#334155;border-radius:8px;padding:16px;margin-bottom:16px}
.title{color:#3b82f6;font-size:24px;margin-bottom:20px}.subtitle{color:#10b981;font-size:18px;margin-bottom:12px}
.stat{display:flex;justify-content:space-between;margin:4px 0}.stat-label{color:#94a3b8}.stat-value{color:#e2e8f0;font-weight:bold}
</style></head><body><div class="container">
<h1 class="title">‚öì ${design.name}</h1>
<div class="section"><h2 class="subtitle">üìã Informa√ß√µes B√°sicas</h2>
<div class="stat"><span class="stat-label">Classe:</span><span class="stat-value">${hull?.name || 'Desconhecido'}</span></div>
<div class="stat"><span class="stat-label">Deslocamento:</span><span class="stat-value">${performance?.totalDisplacement || 'N/A'} t</span></div>
<div class="stat"><span class="stat-label">Velocidade:</span><span class="stat-value">${performance?.maxSpeed || 'N/A'} n√≥s</span></div></div>
<div class="section"><h2 class="subtitle">üí∞ Custos</h2>
<div class="stat"><span class="stat-label">Custo:</span><span class="stat-value">$${costs?.production?.toLocaleString() || 'N/A'}</span></div></div>
<p style="text-align:center;color:#64748b;font-size:12px;margin-top:32px;">WAR 1954 Naval System<br>${new Date().toLocaleString('pt-BR')}</p>
</div></body></html>`;
    }

    // Fun√ß√£o para submeter ao Firebase
    async function submitOrderToFirebase(orderData) {
      try {
        // Verificar autentica√ß√£o
        if (!window.firebase?.auth?.currentUser) {
          throw new Error('Usu√°rio n√£o autenticado');
        }

        const user = window.firebase.auth.currentUser;
        
        // Obter dados do usu√°rio
        const userDoc = await window.firebase.firestore().collection('usuarios').doc(user.uid).get();
        if (!userDoc.exists || !userDoc.data().paisId) {
          throw new Error('Pa√≠s n√£o vinculado ao usu√°rio');
        }
        
        const paisId = userDoc.data().paisId;
        const countryDoc = await window.firebase.firestore().collection('paises').doc(paisId).get();
        const countryData = countryDoc.exists ? countryDoc.data() : {};
        
        const submissionData = {
          ...orderData,
          userId: user.uid,
          userName: user.displayName || user.email,
          paisId: paisId,
          countryName: countryData.Pais || 'Desconhecido',
          submissionDate: new Date(),
          status: 'pending'
        };

        // Adicionar ao Firebase
        const docRef = await window.firebase.firestore().collection('naval_orders_pending').add(submissionData);
        
        console.log('‚úÖ Ordem naval submetida:', docRef.id);
        return { success: true, id: docRef.id };
        
      } catch (error) {
        console.error('‚ùå Erro ao submeter:', error);
        throw error;
      }
    }

    // Iniciar aplica√ß√£o quando DOM estiver pronto
    document.addEventListener('DOMContentLoaded', () => {
      console.log('‚öì Starting Naval Creator App...');
      window.navalCreatorApp.initialize();
    });

    // Fallback para browsers mais antigos
    window.addEventListener('load', () => {
      if (!window.navalCreatorApp.isInitialized) {
        console.log('üîÑ Fallback initialization...');
        setTimeout(() => window.navalCreatorApp.initialize(), 100);
      }
    });
  </script>

</body>
</html>