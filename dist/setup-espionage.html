<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Setup - Sistema de Espionagem</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 600px;
      width: 100%;
      padding: 40px;
    }

    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 28px;
    }

    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }

    .status {
      background: #f5f5f5;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      min-height: 200px;
      max-height: 400px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
    }

    .log-line {
      margin: 5px 0;
      padding: 5px;
      border-radius: 3px;
    }

    .log-info {
      color: #2563eb;
    }

    .log-success {
      color: #16a34a;
      font-weight: bold;
    }

    .log-error {
      color: #dc2626;
      font-weight: bold;
    }

    .log-warning {
      color: #ea580c;
    }

    button {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      margin-bottom: 10px;
    }

    button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    }

    button:active:not(:disabled) {
      transform: translateY(0);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: #64748b;
    }

    .alert {
      background: #fef3c7;
      border: 2px solid #f59e0b;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
      color: #92400e;
    }

    .alert strong {
      display: block;
      margin-bottom: 5px;
      font-size: 14px;
    }

    .progress {
      margin-top: 15px;
      text-align: center;
      font-size: 18px;
      font-weight: bold;
      color: #667eea;
    }
  </style>
  <script type="module" crossorigin src="/portal-da-war/assets/setup-espionage-TN6j3y2_.js"></script>
  <link rel="modulepreload" crossorigin href="/portal-da-war/assets/modulepreload-polyfill-B5Qt9EMX.js">
  <link rel="modulepreload" crossorigin href="/portal-da-war/assets/preload-helper-DnKmFyg5.js">
  <link rel="modulepreload" crossorigin href="/portal-da-war/assets/firebase-EZ41UaXc.js">
</head>
<body>
  <div class="container">
    <h1>üïµÔ∏è Setup - Sistema de Espionagem</h1>
    <p class="subtitle">Adicione o campo de Contra-Espionagem a todos os pa√≠ses</p>

    <div class="alert">
      <strong>‚ö†Ô∏è IMPORTANTE:</strong>
      Voc√™ precisa estar logado como <strong>Narrador</strong> para executar este setup.
    </div>

    <div class="status" id="status">
      <div class="log-info">Aguardando in√≠cio do processo...</div>
    </div>

    <div class="progress" id="progress" style="display: none;"></div>

    <button id="btnStart" onclick="startSetup()">
      üöÄ Iniciar Setup
    </button>

    <button class="btn-secondary" onclick="clearLog()">
      üóëÔ∏è Limpar Log
    </button>
  </div>


  <script>
    const statusDiv = document.getElementById('status');
    const btnStart = document.getElementById('btnStart');
    const progressDiv = document.getElementById('progress');

    function log(message, type = 'info') {
      const line = document.createElement('div');
      line.className = `log-line log-${type}`;
      line.textContent = message;
      statusDiv.appendChild(line);
      statusDiv.scrollTop = statusDiv.scrollHeight;
    }

    function clearLog() {
      statusDiv.innerHTML = '<div class="log-info">Log limpo. Aguardando in√≠cio do processo...</div>';
      progressDiv.style.display = 'none';
    }

    async function startSetup() {
      // Verificar se est√° logado
      if (!window.auth.currentUser) {
        log('‚ùå ERRO: Voc√™ precisa estar logado!', 'error');
        log('Por favor, fa√ßa login primeiro no site principal.', 'warning');
        return;
      }

      btnStart.disabled = true;
      statusDiv.innerHTML = '';
      progressDiv.style.display = 'block';

      log('üîê Usu√°rio logado: ' + window.auth.currentUser.email, 'success');
      log('üì¶ Iniciando processo de setup...', 'info');
      log('', 'info');

      try {
        // Buscar todos os pa√≠ses
        log('üîç Buscando pa√≠ses no Firestore...', 'info');
        const countriesRef = window.collection(window.db, 'countries');
        const snapshot = await window.getDocs(countriesRef);

        const totalPaises = snapshot.size;
        log(`‚úÖ Encontrados ${totalPaises} pa√≠ses`, 'success');
        log('', 'info');

        if (totalPaises === 0) {
          log('‚ö†Ô∏è Nenhum pa√≠s encontrado no banco de dados!', 'warning');
          btnStart.disabled = false;
          return;
        }

        // Processar cada pa√≠s
        let updated = 0;
        let skipped = 0;
        let errors = 0;
        let processed = 0;

        for (const docSnapshot of snapshot.docs) {
          processed++;
          progressDiv.textContent = `Processando ${processed}/${totalPaises}...`;

          const countryData = docSnapshot.data();
          const paisNome = countryData.Pais || 'Pa√≠s sem nome';

          try {
            // Verificar se j√° tem o campo
            if (countryData.CounterIntelligence !== undefined) {
              log(`‚è© ${paisNome}: j√° possui campo CounterIntelligence (${countryData.CounterIntelligence}%)`, 'info');
              skipped++;
            } else {
              // Adicionar campo
              await window.updateDoc(window.doc(window.db, 'countries', docSnapshot.id), {
                CounterIntelligence: 0
              });
              log(`‚úÖ ${paisNome}: campo CounterIntelligence adicionado (0%)`, 'success');
              updated++;
            }
          } catch (error) {
            log(`‚ùå ${paisNome}: ERRO - ${error.message}`, 'error');
            errors++;
          }

          // Pequeno delay para n√£o sobrecarregar o Firestore
          await new Promise(resolve => setTimeout(resolve, 100));
        }

        // Resumo final
        log('', 'info');
        log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'info');
        log('üìä RESUMO DO PROCESSO', 'info');
        log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'info');
        log(`Total de pa√≠ses: ${totalPaises}`, 'info');
        log(`‚úÖ Atualizados: ${updated}`, 'success');
        log(`‚è© J√° existiam: ${skipped}`, 'info');
        log(`‚ùå Erros: ${errors}`, errors > 0 ? 'error' : 'info');
        log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'info');

        if (errors === 0) {
          log('', 'info');
          log('üéâ SETUP CONCLU√çDO COM SUCESSO!', 'success');
          log('O sistema de espionagem est√° pronto para uso.', 'success');
        } else {
          log('', 'info');
          log('‚ö†Ô∏è Setup conclu√≠do com alguns erros.', 'warning');
          log('Verifique os erros acima e tente novamente se necess√°rio.', 'warning');
        }

        progressDiv.style.display = 'none';

      } catch (error) {
        log('', 'info');
        log('‚ùå ERRO CR√çTICO: ' + error.message, 'error');
        log('Stack trace:', 'error');
        log(error.stack, 'error');
        progressDiv.style.display = 'none';
      }

      btnStart.disabled = false;
    }

    // Tornar a fun√ß√£o global
    window.startSetup = startSetup;
    window.clearLog = clearLog;
  </script>
</body>
</html>
