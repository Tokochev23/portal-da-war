<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Teste - Sistema de Consumo de Recursos</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      color: #e2e8f0;
    }
  </style>
</head>
<body class="min-h-screen p-8">
  <div class="max-w-7xl mx-auto">
    <div class="bg-slate-800/50 backdrop-blur border border-slate-600/50 rounded-2xl p-8 mb-8">
      <h1 class="text-3xl font-bold text-center mb-2">üçΩÔ∏è Sistema de Consumo de Recursos</h1>
      <p class="text-center text-slate-400">C√°lculo autom√°tico baseado em popula√ß√£o, desenvolvimento e clima</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
      <!-- Aplicar Consumo -->
      <div class="bg-slate-800/30 border border-slate-600/50 rounded-xl p-6">
        <h2 class="text-xl font-semibold mb-4 text-amber-400">üîÑ Aplicar Consumo</h2>
        <div class="space-y-3">
          <button id="btn-apply-consumption" class="w-full bg-amber-600 hover:bg-amber-500 text-white font-semibold px-4 py-3 rounded-lg transition-colors">
            Calcular Consumo de Todos os Pa√≠ses
          </button>
          <div id="apply-status" class="text-sm text-slate-400"></div>
        </div>
      </div>

      <!-- Teste Individual -->
      <div class="bg-slate-800/30 border border-slate-600/50 rounded-xl p-6">
        <h2 class="text-xl font-semibold mb-4 text-blue-400">üîç Teste Individual</h2>
        <div class="space-y-3">
          <select id="select-country-test" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2">
            <option value="">-- Selecione um pa√≠s --</option>
          </select>
          <button id="btn-test-individual" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-medium px-4 py-3 rounded-lg transition-colors">
            Testar Consumo
          </button>
          <div id="test-status" class="text-sm text-slate-400"></div>
        </div>
      </div>

      <!-- Simula√ß√£o -->
      <div class="bg-slate-800/30 border border-slate-600/50 rounded-xl p-6">
        <h2 class="text-xl font-semibold mb-4 text-orange-400">üîÆ Simula√ß√£o</h2>
        <div class="space-y-3">
          <input id="input-turns" type="number" value="3" min="1" max="12" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2" placeholder="N√∫mero de turnos">
          <button id="btn-simulate" class="w-full bg-orange-600 hover:bg-orange-500 text-white font-medium px-4 py-3 rounded-lg transition-colors">
            Simular Turnos
          </button>
          <div id="simulate-status" class="text-sm text-slate-400"></div>
        </div>
      </div>
    </div>

    <!-- Resultado do Teste Individual -->
    <div id="individual-result" class="hidden mb-8 bg-slate-900/50 border border-slate-600/50 rounded-xl p-6">
      <h3 class="text-lg font-semibold mb-4 text-blue-400">üîç Resultado do Teste Individual</h3>
      <div id="individual-result-content" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Ser√° preenchido dinamicamente -->
      </div>
    </div>

    <!-- Estat√≠sticas Gerais -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
      <!-- Fatores de Consumo -->
      <div class="bg-slate-800/30 border border-slate-600/50 rounded-xl p-6">
        <h3 class="text-lg font-semibold mb-4 text-purple-400">üìä Fatores de Consumo</h3>
        <div class="space-y-3 text-sm">
          <div class="grid grid-cols-3 gap-3">
            <div class="text-slate-400">Recurso</div>
            <div class="text-slate-400">Base/1M hab</div>
            <div class="text-slate-400">Modificadores</div>
          </div>
          <div class="grid grid-cols-3 gap-3">
            <div class="text-slate-200">Gr√£os</div>
            <div class="text-emerald-400">150</div>
            <div class="text-xs text-slate-500">Urbaniza√ß√£o -0.5%</div>
          </div>
          <div class="grid grid-cols-3 gap-3">
            <div class="text-slate-200">Combust√≠vel</div>
            <div class="text-emerald-400">50</div>
            <div class="text-xs text-slate-500">Urban +2%, Tech +3%, Clima</div>
          </div>
          <div class="grid grid-cols-3 gap-3">
            <div class="text-slate-200">Metais</div>
            <div class="text-emerald-400">30</div>
            <div class="text-xs text-slate-500">Urban +1%, Tech +4%</div>
          </div>
          <div class="grid grid-cols-3 gap-3">
            <div class="text-slate-200">Carv√£o</div>
            <div class="text-emerald-400">40</div>
            <div class="text-xs text-slate-500">Tech +2.5%, Clima</div>
          </div>
        </div>
      </div>

      <!-- N√≠veis de Desenvolvimento -->
      <div class="bg-slate-800/30 border border-slate-600/50 rounded-xl p-6">
        <h3 class="text-lg font-semibold mb-4 text-green-400">üí∞ N√≠veis de Desenvolvimento</h3>
        <div class="space-y-3 text-sm">
          <div class="flex justify-between">
            <span class="text-slate-400">Ultradesenvolvido</span>
            <span class="text-emerald-400">PIB/cap > $2000 (√ó2.5)</span>
          </div>
          <div class="flex justify-between">
            <span class="text-slate-400">Altamente desenvolvido</span>
            <span class="text-blue-400">PIB/cap > $1200 (√ó2.0)</span>
          </div>
          <div class="flex justify-between">
            <span class="text-slate-400">Desenvolvido</span>
            <span class="text-cyan-400">PIB/cap > $800 (√ó1.5)</span>
          </div>
          <div class="flex justify-between">
            <span class="text-slate-400">Moderadamente desenvolvido</span>
            <span class="text-yellow-400">PIB/cap > $500 (√ó1.2)</span>
          </div>
          <div class="flex justify-between">
            <span class="text-slate-400">Em desenvolvimento</span>
            <span class="text-orange-400">PIB/cap > $200 (√ó1.0)</span>
          </div>
          <div class="flex justify-between">
            <span class="text-slate-400">Subdesenvolvido</span>
            <span class="text-red-400">PIB/cap < $200 (√ó0.7)</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Log de Execu√ß√£o -->
    <div class="bg-slate-900/50 border border-slate-600/50 rounded-xl p-6">
      <h3 class="text-lg font-semibold mb-4">üìã Log de Execu√ß√£o</h3>
      <div id="execution-log" class="bg-slate-950/50 rounded-lg p-4 text-sm font-mono max-h-96 overflow-y-auto">
        <div class="text-slate-400">Sistema de consumo carregado. Pronto para testes...</div>
      </div>
    </div>
  </div>

  <script src="./js/services/firebase.js" type="module"></script>
  <script type="module">
    import { db, auth, getAllCountries } from './js/services/firebase.js';
    import { applyResourceConsumption, simulateConsumptionTurns } from './scripts/apply-resource-consumption.js';
    import ResourceConsumptionCalculator from './js/systems/resourceConsumptionCalculator.js';

    const log = document.getElementById('execution-log');
    const statusElements = {
      apply: document.getElementById('apply-status'),
      test: document.getElementById('test-status'),
      simulate: document.getElementById('simulate-status')
    };

    function addLog(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const colors = {
        info: 'text-blue-400',
        success: 'text-emerald-400',
        error: 'text-red-400',
        warning: 'text-amber-400'
      };

      log.innerHTML += `<div class="${colors[type]}">[${timestamp}] ${message}</div>`;
      log.scrollTop = log.scrollHeight;
    }

    function updateStatus(element, message, type = 'info') {
      const colors = {
        info: 'text-slate-400',
        success: 'text-emerald-400',
        error: 'text-red-400',
        warning: 'text-amber-400'
      };

      element.innerHTML = message;
      element.className = `text-sm ${colors[type]}`;
    }

    // Carregar pa√≠ses
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        addLog(`üë§ Usu√°rio autenticado: ${user.email}`, 'success');
        await loadCountries();
      } else {
        addLog('‚ö†Ô∏è Usu√°rio n√£o autenticado', 'warning');
      }
    });

    async function loadCountries() {
      try {
        const countries = await getAllCountries();
        const select = document.getElementById('select-country-test');

        select.innerHTML = '<option value="">-- Selecione um pa√≠s --</option>';
        countries.forEach(country => {
          select.innerHTML += `<option value="${country.id}">${country.Pais || country.id}</option>`;
        });

        addLog(`${countries.length} pa√≠ses carregados`, 'success');
      } catch (error) {
        addLog('Erro ao carregar pa√≠ses: ' + error.message, 'error');
      }
    }

    // Aplicar consumo a todos os pa√≠ses
    document.getElementById('btn-apply-consumption').addEventListener('click', async () => {
      const btn = document.getElementById('btn-apply-consumption');
      try {
        btn.disabled = true;
        btn.textContent = '‚è≥ Calculando...';
        updateStatus(statusElements.apply, 'Calculando consumo para todos os pa√≠ses...', 'warning');
        addLog('üöÄ Iniciando c√°lculo de consumo para todos os pa√≠ses', 'info');

        await applyResourceConsumption();

        updateStatus(statusElements.apply, 'Consumo calculado com sucesso!', 'success');
        addLog('‚úÖ Consumo aplicado a todos os pa√≠ses', 'success');

      } catch (error) {
        updateStatus(statusElements.apply, 'Erro no c√°lculo de consumo', 'error');
        addLog('‚ùå Erro: ' + error.message, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Calcular Consumo de Todos os Pa√≠ses';
      }
    });

    // Teste individual
    document.getElementById('btn-test-individual').addEventListener('click', async () => {
      const select = document.getElementById('select-country-test');
      const countryId = select.value;

      if (!countryId) {
        updateStatus(statusElements.test, 'Selecione um pa√≠s primeiro', 'error');
        return;
      }

      try {
        updateStatus(statusElements.test, 'Testando consumo...', 'warning');
        addLog(`üîç Testando consumo para ${select.options[select.selectedIndex].text}`, 'info');

        // Buscar dados do pa√≠s
        const doc = await db.collection('paises').doc(countryId).get();
        if (!doc.exists) {
          throw new Error('Pa√≠s n√£o encontrado');
        }

        const country = { id: doc.id, ...doc.data() };

        // Calcular consumo
        const consumption = ResourceConsumptionCalculator.calculateCountryConsumption(country);
        const balance = ResourceConsumptionCalculator.calculateResourceBalance(country);
        const report = ResourceConsumptionCalculator.generateConsumptionReport(country);

        // Exibir resultado
        showIndividualResult(country, consumption, balance, report);

        updateStatus(statusElements.test, 'Teste conclu√≠do!', 'success');
        addLog('‚úÖ Teste individual conclu√≠do', 'success');

      } catch (error) {
        updateStatus(statusElements.test, 'Erro no teste', 'error');
        addLog('‚ùå Erro no teste: ' + error.message, 'error');
      }
    });

    // Simula√ß√£o
    document.getElementById('btn-simulate').addEventListener('click', async () => {
      const btn = document.getElementById('btn-simulate');
      const turns = parseInt(document.getElementById('input-turns').value) || 3;

      try {
        btn.disabled = true;
        btn.textContent = '‚è≥ Simulando...';
        updateStatus(statusElements.simulate, `Simulando ${turns} turnos...`, 'warning');
        addLog(`üîÆ Iniciando simula√ß√£o de ${turns} turnos`, 'info');

        await simulateConsumptionTurns(turns);

        updateStatus(statusElements.simulate, 'Simula√ß√£o conclu√≠da!', 'success');
        addLog('‚úÖ Simula√ß√£o conclu√≠da - veja resultados no console', 'success');

      } catch (error) {
        updateStatus(statusElements.simulate, 'Erro na simula√ß√£o', 'error');
        addLog('‚ùå Erro na simula√ß√£o: ' + error.message, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Simular Turnos';
      }
    });

    function showIndividualResult(country, consumption, balance, report) {
      const resultDiv = document.getElementById('individual-result');
      const contentDiv = document.getElementById('individual-result-content');

      contentDiv.innerHTML = `
        <!-- Dados do Pa√≠s -->
        <div class="space-y-4">
          <h4 class="font-semibold text-slate-200">üìä Dados do Pa√≠s</h4>
          <div class="grid grid-cols-2 gap-3 text-sm">
            <div class="flex justify-between">
              <span class="text-slate-400">Popula√ß√£o:</span>
              <span class="text-slate-200">${(consumption._metadata.population || 0).toLocaleString()}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-slate-400">PIB per capita:</span>
              <span class="text-slate-200">$${consumption._metadata.pibPerCapita || 0}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-slate-400">Desenvolvimento:</span>
              <span class="text-emerald-400">${consumption._metadata.developmentLevel}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-slate-400">Zona clim√°tica:</span>
              <span class="text-blue-400">${consumption._metadata.climateZone}</span>
            </div>
          </div>
        </div>

        <!-- Consumo Calculado -->
        <div class="space-y-4">
          <h4 class="font-semibold text-slate-200">üçΩÔ∏è Consumo Mensal</h4>
          <div class="space-y-2 text-sm">
            ${Object.entries(consumption).filter(([key, _]) => !key.startsWith('_')).map(([resource, value]) => {
              const balanceData = balance[resource];
              const balanceColor = balanceData.balance >= 0 ? 'text-emerald-400' : 'text-red-400';
              const monthsColor = balanceData.monthsRemaining < 3 ? 'text-red-400' :
                                balanceData.monthsRemaining < 12 ? 'text-amber-400' : 'text-emerald-400';

              return `
                <div class="flex justify-between items-center p-2 rounded bg-slate-800/30">
                  <span class="text-slate-300">${resource}:</span>
                  <div class="text-right">
                    <div class="text-slate-200 font-medium">${value}/m√™s</div>
                    <div class="text-xs ${balanceColor}">Saldo: ${balanceData.balance}</div>
                    <div class="text-xs ${monthsColor}">${balanceData.monthsRemaining} meses</div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;

      resultDiv.classList.remove('hidden');

      // Log detalhado
      addLog(`Consumo calculado para ${country.Pais}:`, 'info');
      addLog(`  - Gr√£os: ${consumption.Graos}/m√™s (${balance.Graos.monthsRemaining} meses restantes)`, 'info');
      addLog(`  - Combust√≠vel: ${consumption.Combustivel}/m√™s (${balance.Combustivel.monthsRemaining} meses)`, 'info');
      addLog(`  - Desenvolvimento: ${consumption._metadata.developmentLevel}`, 'info');
      addLog(`  - Multiplicador: ${consumption._metadata.devMultiplier}x`, 'info');
    }

    // Inicializa√ß√£o
    addLog('Sistema de consumo carregado e pronto', 'success');
    addLog('Aguardando autentica√ß√£o...', 'info');
  </script>
</body>
</html>