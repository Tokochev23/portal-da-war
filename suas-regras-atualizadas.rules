rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ===== Helpers =====
    function isLoggedIn() {
      return request.auth != null;
    }

    function isStaff() {
      return isLoggedIn() &&
        exists(/databases/$(database)/documents/usuarios/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.papel in ['narrador', 'admin'];
    }

    // ===== PAÍSES =====
    match /paises/{document} {
      allow read: if true;
      allow write: if isLoggedIn();
    }

    // ===== USUÁRIOS =====
    match /usuarios/{userId} {
      // Jogador pode ler/editar só o próprio documento
      allow read, write: if isLoggedIn() && request.auth.uid == userId;

      // Staff pode ler/editar qualquer usuário
      allow read: if isStaff();
      allow write: if isStaff();
    }

    // ===== CONFIGURAÇÕES =====
    match /configuracoes/{document} {
      allow read: if true;
      allow write: if isLoggedIn();
    }

    // ===== SISTEMA ECONÔMICO (NOVAS REGRAS) =====
    match /economic_history/{document} {
      allow read: if isLoggedIn();
      allow write: if isStaff();
    }

    match /change_history/{document} {
      allow read: if isLoggedIn();
      allow write: if isStaff();
    }

    // ===== VEÍCULOS PENDENTES =====
    match /vehicles_pending/{docId} {
      // Jogador cria para si mesmo
      allow create: if isLoggedIn()
        && request.resource.data.keys().hasAny(['playerId'])
        && request.auth.uid == request.resource.data.playerId;

      // Jogador lê os seus; staff lê todos
      allow read: if isLoggedIn()
        && (request.auth.uid == resource.data.playerId || isStaff());

      // Atualizar/deletar: só staff
      allow update, delete: if isStaff();
    }

    // ===== VEÍCULOS APROVADOS =====
    match /vehicles_approved/{playerId}/{documents=**} {
      // Jogador lê seu inventário; staff lê tudo
      allow read: if isLoggedIn()
        && (request.auth.uid == playerId || isStaff());

      // Escrever: só staff (aprova/move itens)
      allow write: if isStaff();
    }

    // ===== VEÍCULOS REJEITADOS =====
    match /vehicles_rejected/{docId} {
      allow create: if isStaff();
      allow read: if isLoggedIn()
        && (request.auth.uid == resource.data.playerId || isStaff());
      allow update, delete: if isStaff();
    }

    // ===== INVENTÁRIO =====
    match /inventory/{countryId}/{documents=**} {
      // Jogador lê se for owner do país; staff lê tudo
      allow read: if isLoggedIn()
        && (resource.data.ownerUid == request.auth.uid || isStaff());

      // Escrever no inventário: só staff
      allow write: if isStaff();
    }
  }
}