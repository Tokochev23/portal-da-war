<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üèóÔ∏è Criador de Ve√≠culos Blindados Avan√ßado ‚Ä¢ WAR Era 1954</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 16 16%22%3E%3Crect width=%2216%22 height=%2216%22 rx=%223%22 fill=%22%23ffb400%22/%3E%3Ctext x=%228%22 y=%2211%22 font-size=%2210%22 text-anchor=%22middle%22 fill=%22%230b1020%22%3EW%3C/text%3E%3C/svg%3E" />

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            bg: {
              DEFAULT: "#0b1020",
              soft: "#10172a",
              ring: "#1e293b"
            },
            brand: {
              50:"#fff7e6",100:"#ffefcc",200:"#ffe099",300:"#ffd166",400:"#ffc233",
              500:"#ffb400",600:"#e09f00",700:"#b37d00",800:"#805900",900:"#4d3600"
            }
          }
        }
      }
    }
  </script>

  <!-- Inter Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Stardos+Stencil:wght@700&display=swap" rel="stylesheet">
  
  <!-- Chart.js for performance graphs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- CSS Refatorado -->
  <link rel="stylesheet" href="css/vehicle-creator.css">
  <link rel="stylesheet" href="css/vehicle-creator-enhanced.css">
</head>

<body class="gradient-bg min-h-screen">
  <!-- Loading Screen -->
  <div id="initial-loading" class="fixed inset-0 bg-bg z-50 flex items-center justify-center">
    <div class="text-center">
      <div class="animate-spin w-12 h-12 border-4 border-brand-500 border-t-transparent rounded-full mx-auto mb-4"></div>
      <p class="text-slate-200 font-medium">Iniciando Criador de Ve√≠culos...</p>
      <p class="text-slate-400 text-sm mt-2" id="loading-status">Carregando templates...</p>
    </div>
  </div>

  <!-- HEADER - Carregado dinamicamente -->
  <div id="header-container"></div>

  <!-- MAIN CONTENT -->
  <main class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-8">
    
    <!-- PROJECT INFO SECTION - Carregado dinamicamente -->
    <div id="project-info-container"></div>

    <!-- COMPONENT SELECTION TABS - Carregado dinamicamente -->
    <div id="component-tabs-container"></div>

    <!-- WARNINGS SECTION - Carregado dinamicamente -->
    <div id="warnings-container"></div>

    <!-- DETAILED ANALYSIS SECTION - Carregado dinamicamente -->
    <div id="analysis-container"></div>

    <!-- ACTION BUTTONS - Carregado dinamicamente -->
    <div id="action-buttons-container"></div>

  </main>

  <!-- FOOTER COMPONENTS - Carregado dinamicamente -->
  <div id="footer-components-container"></div>

  <!-- Scripts -->
  <script src="./js/utils/templateLoader.js" type="module"></script>
  <script src="./js/components/tabLoaders.js" type="module"></script>
  <script src="./js/services/firebase.js" type="module"></script>
  <script src="js/vehicleCreator.js" type="module"></script>
  
  <script>
    // Sistema de inicializa√ß√£o refatorado
    class VehicleCreatorApp {
      constructor() {
        this.currentTab = 'chassis';
        this.performanceChart = null;
        this.isInitialized = false;
        this.loadingElement = document.getElementById('initial-loading');
        this.statusElement = document.getElementById('loading-status');
      }

      updateLoadingStatus(message) {
        if (this.statusElement) {
          this.statusElement.textContent = message;
        }
      }

      async initialize() {
        try {
          this.updateLoadingStatus('Iniciando carregamento progressivo...');
          
          // Fase 1: Templates cr√≠ticos
          await this.loadCriticalComponents();
          
          // Fase 2: Templates secund√°rios
          setTimeout(() => this.loadSecondaryComponents(), 100);
          
          // Fase 3: Inicializar funcionalidades
          setTimeout(() => this.initializeFeatures(), 300);
          
          // Fase 4: Templates finais e cleanup
          setTimeout(() => this.finishInitialization(), 500);
          
        } catch (error) {
          console.error('‚ùå Initialization failed:', error);
          this.showInitializationError(error);
        }
      }

      async loadCriticalComponents() {
        this.updateLoadingStatus('Carregando componentes principais...');
        
        const criticalInjections = [
          { containerId: 'header-container', templatePath: 'templates/vehicle-creator/header.html' },
          { containerId: 'project-info-container', templatePath: 'templates/vehicle-creator/project-info.html' }
        ];

        await window.templateInjector.injectMultipleTemplates(criticalInjections);
        console.log('‚úÖ Critical components loaded');
      }

      async loadSecondaryComponents() {
        this.updateLoadingStatus('Carregando sistema de abas...');
        
        const secondaryInjections = [
          { containerId: 'component-tabs-container', templatePath: 'templates/vehicle-creator/component-tabs.html' },
          { containerId: 'warnings-container', templatePath: 'templates/vehicle-creator/warnings-section.html' },
          { containerId: 'analysis-container', templatePath: 'templates/vehicle-creator/analysis-section.html' }
        ];

        await window.templateInjector.injectMultipleTemplates(secondaryInjections);
        console.log('‚úÖ Secondary components loaded');
      }

      async finishInitialization() {
        this.updateLoadingStatus('Finalizando configura√ß√£o...');
        
        const tertiaryInjections = [
          { containerId: 'action-buttons-container', templatePath: 'templates/vehicle-creator/action-buttons.html' },
          { containerId: 'footer-components-container', templatePath: 'templates/vehicle-creator/footer-components.html' }
        ];

        await window.templateInjector.injectMultipleTemplates(tertiaryInjections);
        
        this.hideLoadingScreen();
        this.isInitialized = true;
        console.log('‚úÖ Vehicle Creator fully initialized');
      }

      async initializeFeatures() {
        this.updateLoadingStatus('Configurando funcionalidades...');
        
        // Aguardar DOM estar pronto
        await new Promise(resolve => setTimeout(resolve, 100));
        
        this.initializeInterface();
        this.setupTabNavigation();
        this.setupPerformanceChart();
        this.loadComponentTabs();
      }

      hideLoadingScreen() {
        if (this.loadingElement) {
          this.loadingElement.style.opacity = '0';
          setTimeout(() => {
            this.loadingElement.style.display = 'none';
          }, 300);
        }
      }

      showInitializationError(error) {
        if (this.loadingElement) {
          this.loadingElement.innerHTML = `
            <div class="text-center text-red-400">
              <div class="text-4xl mb-4">‚ö†Ô∏è</div>
              <h2 class="text-xl font-bold mb-2">Erro de Inicializa√ß√£o</h2>
              <p class="text-slate-300 mb-4">Falha ao carregar o aplicativo</p>
              <p class="text-sm text-slate-500 mb-4">${error.message}</p>
              <button 
                onclick="window.location.reload()" 
                class="px-4 py-2 bg-brand-500 text-bg rounded-lg hover:bg-brand-600 transition-colors"
              >
                üîÑ Recarregar P√°gina
              </button>
            </div>
          `;
        }
      }

      initializeInterface() {
        const country = localStorage.getItem('loggedCountry') || 'Desconhecido';
        const countryElement = document.getElementById('current-country');
        if (countryElement) {
          countryElement.textContent = country;
        }
        this.setActiveTab('chassis');
      }

      setupTabNavigation() {
        const tabButtons = document.querySelectorAll('.tab-button');
        tabButtons.forEach(button => {
          button.addEventListener('click', () => {
            const tabId = button.dataset.tab;
            this.setActiveTab(tabId);
            this.loadTabContent(tabId);
          });
        });
      }

      setActiveTab(tabId) {
        this.currentTab = tabId;
        document.querySelectorAll('.tab-button').forEach(btn => {
          btn.classList.remove('border-brand-500', 'text-brand-300');
          btn.classList.add('border-transparent', 'text-slate-400');
        });
        const activeBtn = document.querySelector(`[data-tab="${tabId}"]`);
        if(activeBtn) {
          activeBtn.classList.add('border-brand-500', 'text-brand-300');
          activeBtn.classList.remove('border-transparent', 'text-slate-400');
        }
      }

      loadTabContent(tabId) {
        const tabContent = document.getElementById('tab-content');
        if (!tabContent) return;
        
        tabContent.innerHTML = '<div class="text-center py-8"><div class="animate-spin w-6 h-6 border-2 border-brand-500 border-t-transparent rounded-full mx-auto"></div></div>';
        
        setTimeout(() => {
          switch(tabId) {
            case 'chassis': this.loadChassisTab(); break;
            case 'engine': this.loadEngineTab(); break;
            case 'transmission': this.loadTransmissionTab(); break;
            case 'suspension': this.loadSuspensionTab(); break;
            case 'crew': this.loadCrewTab(); break;
            case 'armor': this.loadArmorTab(); break;
            case 'weapons': this.loadWeaponsTab(); break;
            case 'systems': this.loadSystemsTab(); break;
            case 'equipment': this.loadEquipmentTab(); break;
          }
        }, 200);
      }

      loadComponentTabs() {
        this.loadTabContent(this.currentTab);
      }

      setupPerformanceChart() {
        const chartElement = document.getElementById('performance-radar');
        if (!chartElement) {
          console.warn('Performance chart element not found, skipping chart setup');
          return;
        }

        const ctx = chartElement.getContext('2d');
        this.performanceChart = new Chart(ctx, {
          type: 'radar',
          data: {
            labels: ['Velocidade', 'Blindagem', 'Pot√™ncia', 'Confiabilidade', 'Economia', 'Manutenibilidade'],
            datasets: [{
              label: 'Performance',
              data: [0, 0, 0, 0, 0, 0],
              backgroundColor: 'rgba(255, 180, 0, 0.2)',
              borderColor: 'rgba(255, 180, 0, 0.8)',
              pointBackgroundColor: 'rgba(255, 180, 0, 1)',
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: { 
              r: { 
                min: 0, 
                max: 100, 
                ticks: { display: false }, 
                grid: { color: 'rgba(255, 255, 255, 0.1)' }, 
                pointLabels: { color: 'rgba(255, 255, 255, 0.7)', font: { size: 11 } } 
              } 
            },
            plugins: { legend: { display: false } }
          }
        });
      }

      // Integrated tab loading methods
      loadChassisTab() { 
        if (window.tabLoaders) window.tabLoaders.loadChassisTab(); 
      }
      loadEngineTab() { 
        if (window.tabLoaders) window.tabLoaders.loadEngineTab(); 
      }
      loadTransmissionTab() { 
        if (window.tabLoaders) window.tabLoaders.loadTransmissionTab(); 
      }
      loadSuspensionTab() { 
        if (window.tabLoaders) window.tabLoaders.loadSuspensionTab(); 
      }
      loadCrewTab() { 
        if (window.tabLoaders) window.tabLoaders.loadCrewTab(); 
      }
      loadArmorTab() { 
        if (window.tabLoaders) window.tabLoaders.loadArmorTab(); 
      }
      loadWeaponsTab() { 
        if (window.tabLoaders) window.tabLoaders.loadWeaponsTab(); 
      }
      loadSystemsTab() { 
        if (window.tabLoaders) window.tabLoaders.loadSystemsTab(); 
      }
      loadEquipmentTab() { 
        if (window.tabLoaders) window.tabLoaders.loadEquipmentTab(); 
      }
    }

    // Inicializa√ß√£o global
    window.vehicleCreatorApp = new VehicleCreatorApp();

    // Iniciar aplica√ß√£o quando DOM estiver pronto
    document.addEventListener('DOMContentLoaded', () => {
      console.log('üöó Starting Vehicle Creator App...');
      window.vehicleCreatorApp.initialize();
    });

    // Fallback para browsers mais antigos
    window.addEventListener('load', () => {
      if (!window.vehicleCreatorApp.isInitialized) {
        console.log('üîÑ Fallback initialization...');
        setTimeout(() => window.vehicleCreatorApp.initialize(), 100);
      }
    });
  </script>
</body>
</html>